
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANGMANCH</title>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <!-- HLS.js for Live TV Streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&amp;display=swap" rel="stylesheet">

<style>
    :root {
        --primary-color: #e50914;
        --primary-glow: rgba(229, 9, 20, 0.5);
        --bg-color: #0b0b0b;
        --card-bg: rgba(30, 30, 30, 0.6);
        --glass-bg: rgba(255, 255, 255, 0.08);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --border-color: rgba(255, 255, 255, 0.1);
        --plyr-color-main: #e50914;
        --plyr-font-family: 'Poppins', sans-serif;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
    html, body {
        height: 100%;
        max-width: 480px;
        margin: 0 auto;
    }
    body { 
        background-color: var(--bg-color);
        background-image: var(--bg-image, 
            radial-gradient(circle at 10% 20%, rgba(229, 9, 20, 0.15) 0%, transparent 40%),
            radial-gradient(circle at 90% 80%, rgba(40, 40, 40, 0.5) 0%, transparent 40%)
        );
        background-attachment: fixed;
        color: var(--text-primary); 
        overflow-x: hidden; 
        -webkit-font-smoothing: antialiased; 
        display: flex; 
        flex-direction: column;
    }
    

    .hidden { display: none !important; }

    /* --- Glassmorphism Utility --- */
    .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        box-shadow: var(--glass-shadow);
    }

    /* --- Animations --- */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--primary-glow); } 70% { box-shadow: 0 0 0 8px rgba(229, 9, 20, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 9, 20, 0); } }
    @keyframes scaleIn { from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }

    .page-container, .page-content {
        animation: fadeIn 0.5s ease-out;
    }

    .list-item-animate {
        opacity: 0;
        transform: translateY(20px);
        animation: fadeIn 0.5s ease-out forwards;
    }

    /* Animation for card click */
    .content-card, .trending-card, .backdrop-card, .watchlist-card-pro, .livetv-channel-card, .slide {
        transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.3s ease;
    }
    .card-clicked {
        transform: scale(0.95);
        transition: transform 0.15s ease-in;
    }

    #maintenance-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px; z-index: 10000; }
    #maintenance-page .maintenance-icon { font-size: 60px; color: var(--primary-color); margin-bottom: 25px; }
    #maintenance-page h1 { font-size: 28px; font-weight: 700; margin-bottom: 15px; }
    #maintenance-page p { font-size: 16px; color: var(--text-secondary); line-height: 1.6; }

    #loading-page {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: var(--bg-color);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
    }
    #loading-page.fade-out { opacity: 0; }
    #loading-page .logo {
        font-size: 48px; font-weight: 700; letter-spacing: -1.5px;
        text-shadow: 0 0 20px var(--primary-glow);
        animation: fadeIn 1s ease;
    }
    #loading-page .logo .movie-text { color: white; }
    #loading-page .logo .hunt-text { color: var(--primary-color); }

    #auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: var(--bg-color) url('https://i.ibb.co/svdhXJrL/1001802230.jpg') center center/cover; }
    #auth-container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(11, 11, 11, 1) 20%, rgba(11, 11, 11, 0.6) 60%, rgba(11, 11, 11, 0.9) 100%); }
    .auth-page { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; position: relative; animation: fadeIn 0.5s ease; }
    .auth-logo { text-align: center; margin-bottom: 40px; }
    .auth-logo .logo { font-size: 42px; font-weight: 700; letter-spacing: -1.5px; text-shadow: 0 0 15px var(--primary-glow); }
    .auth-logo .logo .movie-text { color: white; }
    .auth-logo .logo .hunt-text { color: var(--primary-color); }
    .auth-form { 
        width: 100%; 
        max-width: 350px; 
        background: rgba(30, 30, 30, 0.4); 
        backdrop-filter: blur(20px); 
        -webkit-backdrop-filter: blur(20px); 
        padding: 30px; 
        border-radius: 24px; 
        border: 1px solid rgba(255,255,255,0.08); 
        box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
    }
    .auth-form h1 { font-size: 24px; font-weight: 600; text-align: center; margin-bottom: 25px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .input-group { position: relative; margin-bottom: 20px; }
    .auth-input { 
        width: 100%; 
        padding: 15px 45px 15px 20px; 
        background-color: rgba(0, 0, 0, 0.3); 
        border: 1px solid rgba(255,255,255,0.1); 
        border-radius: 16px; 
        color: #fff; 
        font-size: 15px; 
        outline: none; 
        transition: all 0.3s; 
        backdrop-filter: blur(5px);
    }
    .auth-input:focus { border-color: var(--primary-color); background-color: rgba(0, 0, 0, 0.5); box-shadow: 0 0 15px rgba(229, 9, 20, 0.3); }
    #report-bug-description { min-height: 150px; resize: vertical; padding: 15px 20px; }
    .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); cursor: pointer; font-size: 18px; }
    .auth-btn { width: 100%; padding: 15px; background-color: var(--primary-color); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px var(--primary-glow); margin-top: 10px; }
    .auth-btn:hover { background-color: #ff1a25; transform: translateY(-2px); }
    .auth-btn:disabled { background-color: #555; cursor: not-allowed; transform: none; box-shadow: none; }
    .auth-btn.guest-btn { background-color: transparent; border: 2px solid var(--primary-color); margin-top: 15px; }
    .auth-btn.guest-btn:hover { background-color: var(--primary-color); }
    .auth-switch-link { text-align: center; margin-top: 25px; font-size: 14px; color: var(--text-secondary); }
    .auth-switch-link a { color: var(--primary-color); font-weight: 600; text-decoration: none; cursor: pointer; }
    .error-message { color: var(--primary-color); font-size: 13px; text-align: center; margin-top: 15px; display: none; }
    .avatar-selector { margin-top: 20px; }
    .avatar-selector p { text-align: center; font-size: 14px; color: var(--text-secondary); margin-bottom: 15px; }
    .avatar-choices { display: flex; justify-content: center; gap: 15px; }
    .avatar-choice { width: 50px; height: 50px; border-radius: 50%; overflow: hidden; cursor: pointer; border: 3px solid transparent; transition: all 0.3s ease; }
    .avatar-choice img { width: 100%; height: 100%; object-fit: cover; }
    .avatar-choice.selected { border-color: var(--primary-color); transform: scale(1.1); box-shadow: 0 0 15px var(--primary-glow); }
    #app-wrapper { padding-bottom: 80px; flex-grow: 1; display: flex; flex-direction: column; }
    .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; transition: background-color 0.3s ease, padding 0.3s ease; background: transparent; }
    .header.scrolled { 
        background: rgba(11, 11, 11, 0.7); 
        backdrop-filter: blur(20px); 
        -webkit-backdrop-filter: blur(20px); 
        padding: 12px 15px; 
        border-bottom: 1px solid rgba(255,255,255,0.05); 
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .logo { font-size: 28px; font-weight: 700; letter-spacing: -1px; text-shadow: 0 0 10px var(--primary-glow); }
    .logo .movie-text { color: white; }
    .logo .hunt-text { color: var(--primary-color); }
    .header-icons { display: flex; align-items: center; gap: 20px; }
    .header-icons i { 
        font-size: 22px; 
        color: white; 
        cursor: pointer; 
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        text-shadow: 0 1px 3px rgba(0,0,0,0.5); 
    }
    .header-icons i:hover { 
        color: var(--primary-color); 
        transform: scale(1.25); 
        text-shadow: 0 0 15px var(--primary-glow); 
    }
    .search-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background-color: rgba(255,255,255,0.08);
        color: white;
        border: 1px solid var(--border-color);
        padding: 8px 14px;
        border-radius: 24px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(6px);
    }
    .search-btn i { font-size: 16px; }
    .search-btn:hover { 
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
        border-color: rgba(255,255,255,0.25);
        color: var(--primary-color);
    }
    .slider-container { position: relative; width: 100%; height: 280px; overflow: hidden; margin-bottom: 25px; }
    .slider { display: flex; transition: transform 0.5s ease; height: 100%; }
    .slide { min-width: 100%; height: 100%; position: relative; cursor: pointer; }
    .slide img { width: 100%; height: 100%; object-fit: cover; }
    .slide-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,1) 10%, transparent); padding: 20px; }
    .slide-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .slide-meta { font-size: 14px; font-weight: 500; color: var(--text-secondary); }
    .slider-indicators { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
    .indicator { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s; }
    .indicator.active { background-color: var(--primary-color); transform: scale(1.2); box-shadow: 0 0 8px var(--primary-glow); }
    .search-page { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(11, 11, 11, 0.85); 
        backdrop-filter: blur(20px); 
        -webkit-backdrop-filter: blur(20px); 
        z-index: 150; 
        display: none; 
        flex-direction: column; 
    }
    .search-page.active { display: flex; animation: fadeIn 0.4s ease; }
    .search-header { display: flex; align-items: center; padding: 15px; flex-shrink: 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .search-header .back-btn-search { background: none; border: none; color: white; font-size: 20px; cursor: pointer; margin-right: 15px; }
    .search-header h1 { font-size: 22px; font-weight: 600; }
    .search-input-wrapper { position: relative; display: flex; align-items: center; width: 100%; padding: 15px; }
    .search-input-wrapper .search-icon { position: absolute; left: 33px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 16px; }
    .search-input-full { 
        width: 100%; 
        padding: 14px 50px 14px 45px; 
        background-color: rgba(255, 255, 255, 0.05); 
        border: 1px solid rgba(255,255,255,0.1); 
        border-radius: 28px; 
        color: #fff; 
        font-size: 16px; 
        outline: none; 
        transition: all 0.3s; 
    }
    .search-input-full:focus { border-color: var(--primary-color); background-color: rgba(255, 255, 255, 0.1); box-shadow: 0 0 15px rgba(229, 9, 20, 0.3); }
    .search-clear-btn { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; }
    .search-content-wrapper { flex-grow: 1; overflow-y: auto; padding-bottom: 90px; }
    #search-results-container { display: flex; flex-direction: column; gap: 15px; padding: 0 15px; }
    .search-results-container .empty-state { margin: 20px auto; }
    .search-result-card { 
        display: flex; 
        gap: 15px; 
        background-color: rgba(30, 30, 30, 0.4); 
        border-radius: 16px; 
        overflow: hidden; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        border: 1px solid rgba(255,255,255,0.05); 
    }
    .search-result-card:hover { background-color: rgba(40, 40, 40, 0.6); border-color: var(--primary-color); transform: translateY(-2px); }
    .search-result-poster { width: 90px; flex-shrink: 0; }
    .search-result-poster img { width: 100%; height: 100%; object-fit: cover; }
    .search-result-info { padding: 12px 12px 12px 0; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
    .search-result-title { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; }
    .search-result-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
    .search-result-storyline { font-size: 13px; color: var(--text-secondary); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
    #search-initial-state { padding: 0 15px; }

    .header-icons .icon-wrapper { position: relative; }
    .unread-indicator { position: absolute; top: -2px; right: -4px; width: 10px; height: 10px; background-color: var(--primary-color); border-radius: 50%; border: 2px solid var(--bg-color); box-shadow: 0 0 8px var(--primary-glow); }
    #notification-page { padding: 0; }
    .notification-header { display: flex; align-items: center; justify-content: center; padding: 20px 15px 15px 15px; border-bottom: 1px solid var(--border-color); }
    .notification-header h1 { font-size: 22px; font-weight: 600; }
    .notification-list { padding: 15px; }
    .notification-card-wrapper { position: relative; background-color: #c62828; border-radius: 12px; margin-bottom: 15px; overflow: hidden; }
    .notification-card-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; align-items: center; padding: 0 20px; }
    .notification-card-actions .delete-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
    .notification-card { 
        display: flex; 
        gap: 15px; 
        background-color: rgba(30, 30, 30, 0.4); 
        backdrop-filter: blur(10px); 
        padding: 15px; 
        position: relative; 
        z-index: 2; 
        transition: transform 0.3s ease; 
        touch-action: pan-y; 
        border-bottom: 1px solid rgba(255,255,255,0.05); 
    }
    .notif-card-image { flex-shrink: 0; width: 70px; height: 100px; border-radius: 8px; background-color: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .notif-card-image img { width: 100%; height: 100%; object-fit: cover; }
    .notif-card-image .icon { font-size: 32px; color: var(--primary-color); }
    .notif-card-content { flex-grow: 1; display: flex; flex-direction: column; }
    .notif-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .notif-card-header h3 { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .unread-dot-card { width: 10px; height: 10px; background-color: var(--primary-color); border-radius: 50%; box-shadow: 0 0 8px var(--primary-glow); flex-shrink: 0; }
    .notif-card-message { font-size: 14px; color: var(--text-secondary); line-height: 1.5; flex-grow: 1; }
    .notif-card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 12px; }
    .notif-card-footer .time { font-size: 12px; color: #888; }
    .watch-now-btn { background-color: var(--primary-color); color: white; border: none; padding: 6px 14px; font-size: 13px; font-weight: 500; border-radius: 20px; cursor: pointer; transition: background-color 0.2s; }
    .watch-now-btn:hover { background-color: #ff1a25; }
    .page-header { padding: 20px 15px 15px 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
    .page-header h1 { font-size: 22px; font-weight: 600; text-align: left; display: flex; align-items: center; gap: 12px; }
    .page-header.centered-header h1 { justify-content: center; text-align: center; width: 100%; }
    .brand-badge {
        margin-left: 10px;
        padding: 6px 12px;
        border-radius: 16px;
        background: rgba(229, 9, 20, 0.12);
        color: var(--primary-color);
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.4px;
        border: 1px solid rgba(229, 9, 20, 0.35);
    }
    .watchlist-container-pro { display: flex; flex-direction: column; gap: 15px; padding: 15px; }
    .watchlist-card-pro { 
        display: flex; 
        background-color: rgba(30, 30, 30, 0.4); 
        backdrop-filter: blur(10px); 
        border-radius: 16px; 
        overflow: hidden; 
        position: relative; 
        border: 1px solid rgba(255,255,255,0.05); 
        transition: transform 0.3s ease, box-shadow 0.3s ease; 
    }
    .watchlist-card-pro:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5), 0 0 15px var(--primary-glow); }
    .watchlist-card-pro .poster { width: 100px; flex-shrink: 0; }
    .watchlist-card-pro .poster img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .watchlist-card-pro .info { padding: 15px; display: flex; flex-direction: column; flex-grow: 1; justify-content: center; }
    .watchlist-card-pro .info .title { font-size: 17px; font-weight: 600; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .watchlist-card-pro .info .meta { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; }
    .watchlist-card-pro .info .play-icon { color: var(--primary-color); font-size: 18px; }
    .watchlist-card-pro .remove-btn-pro { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    .watchlist-card-pro .remove-btn-pro:hover { background-color: var(--primary-color); transform: scale(1.1); }
    .profile-header-pro { position: relative; padding: 40px 20px 30px 20px; text-align: center; background: linear-gradient(180deg, rgba(229, 9, 20, 0.2) 0%, rgba(0,0,0,0) 100%); border-bottom: 1px solid var(--border-color); margin-bottom: 30px; }
    .profile-avatar-wrapper { position: relative; width: 110px; margin: 0 auto 15px; }
    .profile-avatar-pro { width: 110px; height: 110px; border-radius: 50%; border: 4px solid var(--primary-color); box-shadow: 0 0 20px var(--primary-glow); display: flex; justify-content: center; align-items: center; font-size: 52px; font-weight: 600; color: white; background-color: #333; overflow: hidden; }
    .profile-avatar-pro img { width: 100%; height: 100%; object-fit: cover; }
    #change-avatar-btn { position: absolute; bottom: 0; right: 0; background-color: var(--primary-color); color: white; border: 2px solid var(--bg-color); width: 32px; height: 32px; border-radius: 50%; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease; }
    #change-avatar-btn:hover { transform: scale(1.1); }
    .profile-name { font-size: 26px; font-weight: 700; margin-bottom: 5px; }
    .profile-email { font-size: 15px; color: var(--text-secondary); }
    .profile-stats { 
        display: flex; 
        justify-content: space-around; 
        padding: 25px 15px; 
        margin: 0 15px 30px 15px; 
        background-color: rgba(30, 30, 30, 0.4); 
        backdrop-filter: blur(10px); 
        border-radius: 20px; 
        border: 1px solid rgba(255,255,255,0.05); 
        box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
    }
    .stat-item { text-align: center; }
    .stat-item .stat-number { font-size: 18px; font-weight: 600; color: var(--text-primary); }
    .stat-item .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
    .form-page { padding: 20px 15px; }
    .form-page .auth-form { max-width: 100%; margin: 0 auto; background: transparent; backdrop-filter: none; border: none; padding: 10px 0; }
    .form-page .auth-form h1 { margin-bottom: 30px; }
    .settings-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 10px; text-align: center; font-weight: 500;}
    .gender-radio-group { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
    .gender-radio-group label { display: flex; align-items: center; cursor: pointer; }
    .gender-radio-group input[type="radio"] { display: none; }
    .gender-radio-label { padding: 10px 25px; border: 2px solid var(--border-color); border-radius: 25px; transition: all 0.3s ease; font-weight: 500; }
    .gender-radio-group input[type="radio"]:checked + .gender-radio-label { background-color: var(--primary-color); border-color: var(--primary-color); color: var(--text-primary); }
    .toast-notification { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: #2a2a2a; color: white; padding: 12px 20px; border-radius: 25px; font-size: 14px; z-index: 1100; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; border: 1px solid var(--border-color); }
    .toast-notification.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    .category-section { margin-bottom: 35px; }
    .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 15px; }
    .category-title { position: relative; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; color: var(--text-primary);}
    .category-title::before { content: ''; display: block; width: 5px; height: 24px; background-color: var(--primary-color); border-radius: 0; box-shadow: 0 0 8px var(--primary-glow); }
    .see-all-btn { color: var(--primary-color); text-decoration: none; font-size: 14px; font-weight: 500; text-shadow: 0 0 8px var(--primary-glow); transition: color 0.3s; }
    .see-all-btn:hover { color: white; }
    .content-slider { display: flex; overflow-x: auto; padding: 0 15px; scrollbar-width: none; -ms-overflow-style: none; gap: 12px; }
    .content-slider::-webkit-scrollbar { display: none; }
    .content-card, .trending-card, .backdrop-card { flex-shrink: 0; position: relative; border-radius: 12px; overflow: hidden; background-color: var(--card-bg); }
    .content-card, .trending-card { flex: 0 0 130px; }
    .backdrop-card { flex: 0 0 220px; }
    .content-card:hover, .trending-card:hover, .backdrop-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5), 0 0 15px var(--primary-glow); }
    .content-card img, .trending-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
    .backdrop-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
    .content-card-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); text-align: center; z-index: 2;}
    .content-card-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 0 6px rgba(255, 255, 255, 0.7); }

    .new-badge-ribbon {
        position: absolute;
        top: -1px;
        right: -1px;
        width: 50px;
        height: 50px;
        overflow: hidden;
        z-index: 2;
    }
    .new-badge-ribbon span {
        position: absolute;
        display: block;
        width: 80px;
        padding: 5px 0;
        background: var(--primary-color);
        box-shadow: 0 5px 10px rgba(0,0,0,0.2), 0 0 10px var(--primary-glow);
        color: #fff;
        font: 700 11px/1 'Poppins', sans-serif;
        text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        text-transform: uppercase;
        text-align: center;
        right: -17px;
        top: 13px;
        transform: rotate(45deg);
    }

    .trending-card .trending-rank { position: absolute; bottom: -15px; left: 5px; font-size: 80px; font-weight: 900; color: rgba(255, 255, 255, 0.9); line-height: 1; z-index: 2; text-shadow: 0 2px 8px rgba(0,0,0,0.5); }
    .trending-card .trending-title { position: absolute; bottom: 10px; left: 45px; right: 10px; font-size: 15px; font-weight: 700; color: white; line-height: 1.3; z-index: 3; text-shadow: 1px 1px 5px rgba(0,0,0,0.9); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .trending-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.8) 10%, transparent); z-index: 1; }
    .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; padding: 15px; }
    .content-grid .content-card { flex-basis: auto; }
    .language-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: var(--primary-color);
        color: var(--text-primary);
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        z-index: 3;
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    .new-badge-ribbon ~ .language-badge {
        top: 40px;
    }
    .detail-page { display: none; padding-bottom: 30px; }
    .detail-backdrop { width: 100%; height: 250px; position: relative; }
    .detail-backdrop img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
    .detail-backdrop::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 100px; background: linear-gradient(to top, var(--bg-color) 20%, transparent); }
    .detail-content { padding: 15px; position: relative; z-index: 10; }
    .detail-title { font-size: 26px; font-weight: 700; line-height: 1.2; margin-bottom: 10px; }
    .detail-meta { font-size: 15px; color: var(--text-secondary); margin-bottom: 20px; font-weight: 500;}
    .detail-actions { margin-bottom: 25px; }
    .btn-play-full { background-color: var(--primary-color); color: var(--text-primary); border: none; padding: 15px; width: 100%; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: 600; display: flex; justify-content: center; align-items: center; gap: 10px; transition: all 0.2s ease; box-shadow: 0 4px 15px var(--primary-glow); }
    .btn-play-full:hover { background-color: #ff1a25; }
    .btn-play-full i { font-size: 18px; }
    .storyline-wrapper { margin-bottom: 25px; }
    .detail-storyline { font-size: 15px; color: var(--text-secondary); line-height: 1.6; }
    .secondary-actions-container { display: flex; justify-content: space-around; padding: 10px 0; margin-bottom: 30px; }
    .action-icon-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; color: var(--text-secondary); cursor: pointer; font-size: 12px; font-weight: 500; transition: color 0.3s ease, transform 0.2s ease; width: 70px; text-align: center; background: none; border: none; }
    .action-icon-btn i { font-size: 24px; }
    .action-icon-btn:hover { color: var(--text-primary); transform: scale(1.1); }
    .action-icon-btn.active { color: var(--primary-color); }
    .action-icon-btn span.action-count { font-size: 11px; color: var(--text-secondary); font-weight: 400; transition: color 0.3s ease; }
    .action-icon-btn.active span.action-count { color: var(--primary-color); }
    .cast-section { margin-bottom: 30px; }
    .cast-list { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; scrollbar-width: none; }
    .cast-list::-webkit-scrollbar { display: none; }
    .cast-item { text-align: center; min-width: 80px; flex-shrink: 0; }
    .cast-item img { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 2px solid var(--border-color); transition: all 0.3s ease; }
    .cast-item:hover img { border-color: var(--primary-color); transform: scale(1.1); }
    .cast-item p { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #similar-section .category-header { padding: 0; }
    .back-btn { 
        position: fixed; 
        top: 15px; 
        left: 15px; 
        background: rgba(0,0,0,0.5); 
        color: white; 
        border: none; 
        width: 40px; 
        height: 40px; 
        border-radius: 50%; 
        font-size: 18px; 
        cursor: pointer; 
        z-index: 101; 
        display: none; 
        backdrop-filter: blur(5px); 
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    .back-btn:hover { 
        background-color: var(--primary-color); 
        transform: scale(1.15); 
        box-shadow: 0 0 15px var(--primary-glow); 
    }
    .bottom-nav { 
        position: fixed; 
        bottom: 20px; 
        left: 50%; 
        transform: translateX(-50%); 
        width: calc(100% - 40px); 
        max-width: 450px; 
        height: 70px; 
        background: rgba(20, 20, 20, 0.65); 
        backdrop-filter: blur(20px); 
        -webkit-backdrop-filter: blur(20px); 
        border-radius: 40px; 
        display: flex; 
        justify-content: space-around; 
        align-items: center; 
        z-index: 200; 
        border: 1px solid rgba(255,255,255,0.1); 
        box-shadow: 0 10px 40px rgba(0,0,0,0.4); 
    }
    .nav-item { 
        background: none; 
        border: none; 
        color: var(--text-secondary); 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: 4px; 
        cursor: pointer; 
        font-size: 11px; 
        font-weight: 500; 
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        position: relative; 
        padding: 8px 0; 
        flex: 1; 
        transform-origin: center;
    }
    .nav-item i { font-size: 22px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    
    /* Glass Zoom Effect */
    .nav-item:hover {
        transform: scale(1.25) translateY(-5px);
        color: white;
        text-shadow: 0 0 10px rgba(255,255,255,0.6);
    }
    .nav-item:hover i {
        text-shadow: 0 0 15px var(--primary-glow);
    }
    
    .nav-item.active { 
        color: var(--primary-color); 
        transform: scale(1.15) translateY(-5px); 
        text-shadow: 0 0 10px var(--primary-glow); 
    }
    .nav-item.active i { color: var(--primary-color); }
    .page-container.is-empty-page, .category-container.is-empty-page { display: flex; justify-content: center; align-items: center; min-height: calc(100vh - 200px); }
    .empty-state { text-align: center; padding: 20px 15px; color: var(--text-secondary); width: 100%; }
    .empty-state .empty-icon { font-size: 60px; margin-bottom: 20px; display: block; color: rgba(255,255,255,0.3); }
    .empty-state p { font-size: 18px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px; }
    .empty-state span { font-size: 14px; }
    .search-suggestions-group { margin-bottom: 35px; }
    .suggestion-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .suggestion-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
    .suggestion-title i { color: var(--primary-color); }
    .clear-btn { background: none; border: none; color: var(--primary-color); font-size: 13px; cursor: pointer; font-weight: 500; }
    .suggestion-tags-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .suggestion-tag { padding: 8px 15px; background-color: var(--card-bg); border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); }
    .suggestion-tag:hover { background-color: var(--primary-color); color: var(--text-primary); border-color: var(--primary-color); }
    .recent-search-item { display: flex; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s ease; }
    .recent-search-item:last-child { border-bottom: none; }
    .recent-search-item:hover { background-color: rgba(255,255,255,0.05); }
    .recent-search-item .icon { color: var(--text-secondary); margin-right: 15px; font-size: 14px; width: 18px; text-align: center; }
    .recent-search-item .text { flex-grow: 1; color: var(--text-secondary); font-weight: 500; }
    .recent-search-item .remove-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 16px; padding: 5px; }
    #profile-page.page-container { padding: 0; overflow-y: auto; }
    .profile-menu-group { margin: 0 15px 30px 15px; }
    .group-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; padding-left: 5px; }
    .profile-menu .menu-item { 
        background-color: rgba(30, 30, 30, 0.4); 
        backdrop-filter: blur(5px); 
        border-radius: 16px; 
        padding: 16px; 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        margin-bottom: 12px; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        border: 1px solid rgba(255,255,255,0.05); 
    }
    .profile-menu .menu-item:hover { background-color: #2a2a2a; border-color: var(--primary-color); transform: translateX(5px); }
    .profile-menu .menu-item .icon { font-size: 18px; color: var(--primary-color); width: 20px; text-align: center; }
    .profile-menu .menu-item .text { flex-grow: 1; font-weight: 500; }
    .profile-menu .menu-item .chevron { font-size: 16px; color: var(--text-secondary); }
    .profile-menu .logout-item { border: 1px solid rgba(229, 9, 20, 0.5); }
    .profile-menu .logout-item .text { color: var(--primary-color); font-weight: 600; }
    .static-page-content { padding: 20px; color: var(--text-secondary); line-height: 1.7; }
    .static-page-content h2 { color: var(--text-primary); font-size: 18px; margin-bottom: 15px; }
    .static-page-content h3 { color: var(--text-primary); font-size: 16px; margin-top: 25px; margin-bottom: 10px; }
    .static-page-content p { margin-bottom: 20px; font-size: 15px; }
    .static-page-content ul { padding-left: 20px; margin-bottom: 20px; }
    .static-page-content li { margin-bottom: 10px; }

    .player-page {
        background-color: var(--bg-color);
        z-index: 500;
        display: none;
        flex-direction: column;
        width: 100%;
        height: 100vh;
    }

    .player-wrapper {
        width: 100%;
        position: relative;
        background-color: #000;
        overflow: hidden;
        font-size: 14px;
        user-select: none;
        line-height: 0;
        aspect-ratio: 16/9;
    }

    .player-wrapper video { width: 100%; height: 100%; display: block; }

    .player-loading-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #000;
        z-index: 20;
        display: flex; justify-content: center; align-items: center;
        pointer-events: none; opacity: 0; transition: opacity 0.3s;
    }
    .player-loading-overlay.show { opacity: 1; pointer-events: auto; }
    .plyr__spinner {
        display: inline-block;
        width: 35px; height: 35px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .player-error-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
    .player-error-overlay.show { display: flex; }
    .player-error-overlay i { font-size: 48px; color: var(--primary-color); margin-bottom: 15px; }
    .player-error-overlay p { font-size: 16px; font-weight: 500; }
    .error-back-btn { margin-top: 20px; padding: 10px 25px; background-color: var(--primary-color); border: none; border-radius: 25px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease; }
    .error-back-btn:hover { background-color: #ff1a25; }
    #movie-player-page, #series-player-page, #livetv-player-page { overflow-y: auto; height: auto; } /* Allow scrolling on player pages */
    .movie-player-info { padding: 20px 15px; }
    .movie-player-title { font-size: 24px; font-weight: 700; margin-bottom: 15px; }
    .movie-player-suggestions { padding-bottom: 20px; }

    .player-back-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        z-index: 25;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        transition: background-color 0.3s ease;
    }
    .player-back-btn:hover {
        background-color: var(--primary-color);
    }

    .player-wrapper {
        --plyr-control-radius: 50%;
        --plyr-control-spacing: 10px;
        --plyr-tooltip-background: var(--primary-color);
        --plyr-tooltip-color: #fff;
        --plyr-range-thumb-height: 14px;
        --plyr-range-track-height: 5px;
        --plyr-control-icon-size: 20px;
    }
    .plyr--video .plyr__controls {
        background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        padding: 8px 10px 15px 10px;
    }
    .plyr__controls__item.plyr__progress__container { flex: 1 1 auto; margin: 0 10px; }
    .plyr__control { background: transparent !important; border-radius: 50%; transition: background-color 0.2s ease; width: 40px; height: 40px; }
    .plyr__control:hover, .plyr__control:focus { background: rgba(255,255,255,0.15) !important; }
    .plyr__control.plyr__tab-focus, .plyr__control--overlaid:focus { box-shadow: 0 0 0 4px var(--primary-glow); }
    .plyr__play-large { width: 70px; height: 70px; border-radius: 50%; background: rgba(229, 9, 20, 0.8) !important; border: 2px solid white; box-shadow: 0 0 20px var(--primary-glow); transition: all 0.2s ease; }
    .plyr__play-large:hover { transform: scale(1.1); background: rgba(229, 9, 20, 1) !important; }
    .plyr__play-large svg { width: 24px; height: 24px; left: 25px; }
    .plyr--video .plyr__progress input[type=range] { -webkit-appearance: none; appearance: none; background: transparent; border: 0; border-radius: 20px; color: var(--plyr-color-main); display: block; height: 18px; margin: 0; padding: 0; transition: box-shadow .3s ease; width: 100%; }
    .plyr__progress input[type=range]::-webkit-slider-thumb { background: #fff; border: 0; border-radius: 50%; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.15); height: 14px; width: 14px; position: relative; transition: all .2s ease; -webkit-appearance: none; }
    .plyr__progress input[type=range]:focus::-webkit-slider-thumb { box-shadow: 0 0 0 5px var(--primary-glow); }
    .plyr__time { font-size: 14px; }
    .plyr__preview-thumbnail { border: 2px solid white; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.5); background: #000; }
    .plyr__preview-thumbnail .plyr__preview-time { font-size: 13px; background: rgba(0,0,0,0.6); border-radius: 4px; padding: 2px 6px; bottom: 6px; right: 6px; }

    .player-rotate-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 50;
        pointer-events: none;
        text-align: center;
    }
    .player-rotate-overlay i { font-size: 48px; margin-bottom: 15px; transform: rotate(-90deg); }

    .plyr--fullscreen-active .player-wrapper:has(video:fullscreen) .player-rotate-overlay,
    .plyr--fullscreen-active .player-wrapper:has(video:-webkit-full-screen) .player-rotate-overlay {
        @media (orientation: portrait) {
            display: flex;
        }
    }

    #avatar-change-modal, #gender-choice-modal { position: fixed; bottom: 0; left: 0; max-width: 480px; margin: 0 auto; right: 0; background-color: var(--card-bg); z-index: 1100; border-top: 1px solid var(--border-color); border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 25px 15px; transform: translateY(100%); transition: transform 0.3s ease-in-out; }
    #avatar-change-modal.show, #gender-choice-modal.show { transform: translateY(0); }
    #avatar-change-modal h3, #gender-choice-modal h3 { text-align: center; font-size: 18px; margin-bottom: 25px; }
    #avatar-change-modal .avatar-choices { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; justify-items: center; }
    #avatar-change-modal .avatar-choice { width: 65px; height: 65px; }
    .gender-choices { display: flex; justify-content: space-around; gap: 20px; }
    .gender-btn { background-color: var(--bg-color); border: 2px solid var(--border-color); color: var(--text-secondary); border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s ease; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 16px; font-weight: 600; }
    .gender-btn i { font-size: 32px; }
    .gender-btn:hover { border-color: var(--primary-color); color: var(--primary-color); transform: translateY(-5px); }
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1099; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .modal-backdrop.show { opacity: 1; pointer-events: auto; }

    auth-btn, .nav-item, .btn-play-full, .action-icon-btn, .menu-item, .suggestion-tag, .back-btn, .player-btn, .refresh-stream-btn, .error-back-btn, #change-avatar-btn, .search-clear-btn, .clear-btn, .remove-btn-pro, .channel-list-item, .indicator, .gender-btn, .player-back-btn { transition: transform 0.1s ease-out; }
    .auth-btn:active, .nav-item:active, .btn-play-full:active, .action-icon-btn:active, .menu-item:active, .suggestion-tag:active, .back-btn:active, .player-btn:active, .refresh-stream-btn:active, .error-back-btn:active, #change-avatar-btn:active, .search-clear-btn:active, .clear-btn:active, .remove-btn-pro:active, .channel-list-item:active, .indicator:active, .gender-btn:active, .player-back-btn:active { transform: scale(0.95); }

    .featured-series-card {
        position: relative;
        height: 350px;
        margin: 0 0 25px 0;
        border-radius: 0;
        overflow: hidden;
        background-color: var(--card-bg);
        cursor: pointer;
    }
    .featured-series-card .backdrop { width: 100%; height: 100%; object-fit: cover; }
    .featured-series-card .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(11,11,11,1) 15%, rgba(11,11,11,0.2) 60%, rgba(11,11,11,0.8) 100%); padding: 20px; display: flex; flex-direction: column; justify-content: flex-end; }
    .featured-series-card .title { font-size: 28px; font-weight: 800; line-height: 1.2; margin-bottom: 8px; text-shadow: 0 2px 10px rgba(0,0,0,0.7); }
    .featured-series-card .meta { font-size: 14px; font-weight: 500; color: var(--text-secondary); margin-bottom: 15px; }

    .detail-tabs { display: flex; padding: 0 15px; gap: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; }
    .detail-tabs::-webkit-scrollbar { display: none; }
    .tab-link { background: none; border: none; color: var(--text-secondary); padding: 12px 10px; font-size: 15px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; }
    .tab-link.active { color: var(--text-primary); border-bottom-color: var(--primary-color); }
    .tab-content { display: none; padding: 0 15px; animation: fadeIn 0.4s; }

    .season-tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
    .season-tabs::-webkit-scrollbar { display: none; }
    .season-tab { padding: 10px 15px; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.3s ease; white-space: nowrap; }
    .season-tab.active { color: var(--text-primary); border-bottom-color: var(--primary-color); }

    #livetv-page {
        display: none;
        flex-direction: column;
    }
    #livetv-page .header {
        position: static;
        background-color: transparent;
    }
    #livetv-page .search-input-wrapper {
        padding-bottom: 0;
    }

    .category-filters {
        display: flex;
        overflow-x: auto;
        padding: 15px 15px 15px 15px;
        gap: 10px;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .category-filters::-webkit-scrollbar { display: none; }
    .filter-chip {
        flex-shrink: 0;
        padding: 8px 18px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .filter-chip.active, .filter-chip:hover {
        background-color: var(--primary-color);
        color: var(--text-primary);
        border-color: var(--primary-color);
    }
    #livetv-content {
        padding-bottom: 20px;
    }
    .livetv-category-section { margin-bottom: 30px; }
    .livetv-grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 20px 15px; 
        padding: 0 15px; 
    }
    .livetv-channel-card {
        position: relative;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .livetv-channel-card .logo-wrapper {
        width: 100%;
        aspect-ratio: 1 / 1;
        background-color: #000; /* Changed from #fff to #000 for black background */
        border-radius: 12px;
        padding: 15px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .livetv-channel-card:hover .logo-wrapper {
        border-color: var(--primary-color);
        transform: scale(1.05);
        box-shadow: 0 0 15px var(--primary-glow);
    }
    .livetv-channel-card img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    .livetv-channel-card .channel-name {
        font-size: 13px;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: color 0.3s ease;
        margin-top: 8px;
        width: 100%;
        text-align: center;
    }
    .livetv-channel-card:hover .channel-name {
        color: var(--text-primary);
    }
     .content-slider .livetv-channel-card {
        flex: 0 0 100px;
    }

    .autoplay-toggle-wrapper { display: flex; justify-content: flex-end; padding: 0 15px 20px; }
    .autoplay-toggle { display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 500; color: var(--text-secondary); }
    .autoplay-toggle .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .autoplay-toggle .switch input { opacity: 0; width: 0; height: 0; }
    .autoplay-toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px; }
    .autoplay-toggle .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    .autoplay-toggle input:checked + .slider { background-color: var(--primary-color); }
    .autoplay-toggle input:checked + .slider:before { transform: translateX(20px); }

    #series-player-page .movie-player-info { padding: 20px 15px; }
    #series-player-page .movie-player-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
    #series-player-page .secondary-actions-container { margin-bottom: 25px; }
    .episodes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .episodes-header h3 { font-size: 18px; font-weight: 600; }
     #series-player-episode-list .episode-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    #series-player-episode-list .episode-item { flex-direction: column; gap: 8px; padding: 0; cursor: pointer; border-radius: 8px; overflow: hidden; background-color: var(--card-bg); border: 1px solid transparent; transition: all 0.3s ease; }
    #series-player-episode-list .episode-item:hover { border-color: var(--primary-color); transform: scale(1.05); }
    #series-player-episode-list .episode-item.active { border-color: var(--primary-color); box-shadow: 0 0 10px var(--primary-glow); }
    #series-player-episode-list .episode-thumbnail { width: 100%; aspect-ratio: 16/9; position: relative; }
    #series-player-episode-list .episode-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
    #series-player-episode-list .episode-thumbnail .play-icon-wrapper { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; font-size: 32px; color: white; opacity: 0; transition: opacity 0.3s ease; }
    #series-player-episode-list .episode-item:hover .play-icon-wrapper { opacity: 1; }
    #series-player-episode-list .episode-details { padding: 10px; width: 100%; }
    #series-player-episode-list .episode-details .title { font-size: 14px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    #series-player-episode-list .episode-details .ep-desc { display: none; }

    #seasons-container .episode-list { display: flex; flex-direction: column; gap: 1px; background-color: var(--card-bg); border-radius: 12px; overflow: hidden; }
    #seasons-container .episode-item { display: flex; align-items: center; gap: 15px; padding: 12px; cursor: pointer; transition: background-color 0.3s ease; background-color: transparent; border-bottom: 1px solid var(--border-color); }
    #seasons-container .episode-item:last-child { border-bottom: none; }
    #seasons-container .episode-item .play-icon-wrapper { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; opacity: 0; transition: opacity 0.3s ease; }
    #seasons-container .episode-item:hover .play-icon-wrapper { opacity: 1; }
    #seasons-container .episode-thumbnail { width: 140px; aspect-ratio: 16/9; border-radius: 8px; overflow: hidden; flex-shrink: 0; position: relative; }
    #seasons-container .episode-thumbnail img { width: 100%; height: 100%; object-fit: cover; }
    #seasons-container .episode-details { flex-grow: 1; }
    #seasons-container .episode-details .title { font-size: 15px; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); }
    #seasons-container .episode-details .ep-desc { font-size: 13px; color: var(--text-secondary); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }

    .premium-crown {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 20px;
        color: #FFD700;
        text-shadow: 0 1px 4px rgba(0,0,0,0.9);
        z-index: 3;
    }
    .new-badge-ribbon + .premium-crown {
        left: auto;
        right: 8px;
        top: 8px;
    }

    .subscription-plan-grid { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 15px; }
    .subscription-plan-card {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 25px;
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .subscription-plan-card.highlighted {
        border-color: var(--primary-color);
        box-shadow: 0 0 20px var(--primary-glow);
    }
    .subscription-plan-card .plan-header {
        text-align: center;
    }
    .subscription-plan-card .plan-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
    }
    .subscription-plan-card .plan-rate {
        font-size: 36px;
        font-weight: 900;
        margin: 5px 0;
        color: var(--text-primary);
    }
    .subscription-plan-card .plan-rate span {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-secondary);
    }
    .subscription-plan-card .plan-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        text-align: left;
    }
    .plan-description ul { list-style: none; padding: 0; }
    .plan-description li { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .plan-description i { color: var(--primary-color); }
    .choose-plan-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 12px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-top: auto;
    }
    .choose-plan-btn:hover { background-color: #ff1a25; }

    /* --- Payment Modal --- */
    #payment-modal {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.8);
        z-index: 1200;
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    #payment-modal.show { 
        display: flex; 
        opacity: 1;
    }
    .payment-modal-content {
        background-color: var(--card-bg);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid var(--border-color);
        position: relative;
        width: 90%;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.95);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    #payment-modal.show .payment-modal-content {
        transform: scale(1);
        opacity: 1;
    }
     .payment-modal-content::-webkit-scrollbar { display: none; }
    .payment-modal-content h3 {
        font-size: 20px;
        margin-bottom: 15px;
    }
    #payment-qr-code-img {
        width: 200px;
        height: 200px;
        background: white;
        padding: 10px;
        border-radius: 8px;
    }
    .payment-modal-close-btn {
        position: absolute;
        top: 10px; right: 10px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 28px;
        cursor: pointer;
    }
    #payment-details-form {
        margin-top: 20px;
    }
    #payment-details-form .input-group {
        margin-bottom: 15px;
    }
    #payment-details-form .auth-input {
        text-align: left;
        padding-left: 20px;
    }


    .detail-card {
        background-color: var(--card-bg);
        border-radius: 15px;
        padding: 25px;
        margin: 15px;
        border: 1px solid var(--border-color);
    }
    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .detail-row:last-child {
        border-bottom: none;
    }
    .detail-label {
        font-size: 15px;
        color: var(--text-secondary);
    }
    .detail-value {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        text-align: right;
        text-transform: capitalize;
    }
    .premium-badge {
        background-color: #FFD700;
        color: #000;
        padding: 3px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
    }
    .upgrade-btn {
        display: block;
        width: calc(100% - 30px);
        margin: 20px 15px 0 15px;
    }

    .comments-section {
        padding: 0 15px;
        margin-top: 30px;
        margin-bottom: 30px;
    }
    .comments-section .category-title {
        margin-bottom: 20px;
    }
    .comment-form-container {
        margin-bottom: 25px;
    }
    .comment-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .comment-input {
        width: 100%;
        min-height: 80px;
        padding: 12px;
        background-color: rgba(30, 30, 30, 0.4);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px;
        color: var(--text-primary);
        font-size: 15px;
        resize: vertical;
        outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .comment-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 10px var(--primary-glow);
        background-color: rgba(30, 30, 30, 0.6);
    }
    .comment-submit-btn {
        align-self: flex-end;
        padding: 10px 25px;
        background-color: var(--primary-color);
        border: none;
        border-radius: 25px;
        color: white;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease-out;
    }
     .comment-submit-btn:active {
        transform: scale(0.95);
    }
    .comment-submit-btn:hover {
        background-color: #ff1a25;
    }
    .comment-submit-btn:disabled {
        background-color: #555;
        cursor: not-allowed;
    }
    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .comment-item {
        display: flex;
        gap: 15px;
        align-items: flex-start;
    }
    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
    }
    .comment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .comment-content {
        flex-grow: 1;
    }
    .comment-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
    }
    .comment-user-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .comment-timestamp {
        font-size: 12px;
        color: var(--text-secondary);
    }
    .comment-text {
        font-size: 15px;
        color: var(--text-secondary);
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
    }
    .comment-actions {
        margin-left: auto;
    }
    .comment-delete-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        font-size: 14px;
    }
    .comment-delete-btn:hover {
        color: var(--primary-color);
    }

    .app-lock-toggle-wrapper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: rgba(30, 30, 30, 0.4);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        margin-bottom: 25px;
        font-size: 16px;
        font-weight: 500;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .app-lock-toggle-wrapper .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }
    .app-lock-toggle-wrapper .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .app-lock-toggle-wrapper .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #333;
        transition: .4s;
        border-radius: 24px;
    }
    .app-lock-toggle-wrapper .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    .app-lock-toggle-wrapper input:checked + .slider {
        background-color: var(--primary-color);
    }
    .app-lock-toggle-wrapper input:checked + .slider:before {
        transform: translateX(20px);
    }
    #pin-lock-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--bg-color);
        z-index: 10001;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .pin-lock-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 300px;
    }
    .pin-lock-prompt {
        font-size: 16px;
        color: var(--text-secondary);
        margin-top: 30px;
        margin-bottom: 20px;
    }
    .pin-display {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .pin-display span {
        width: 18px;
        height: 18px;
        background-color: var(--card-bg);
        border-radius: 50%;
        border: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
    }
    .pin-display span.filled {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    .pin-keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        width: 100%;
    }
    .pin-keypad button {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 28px;
        font-family: 'Orbitron', sans-serif;
        padding: 20px;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .pin-keypad button:hover, .pin-keypad button:active {
        background-color: var(--card-bg);
    }
    .pin-keypad button.keypad-blank {
        pointer-events: none;
    }
    .pin-lock-container .error-message {
        display: block;
        min-height: 20px;
        margin-top: 0;
    }
    @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }
    .pin-display.shake {
        animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
    }

    #upcoming-container {
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .upcoming-card {
        display: flex;
        gap: 15px;
        background-color: rgba(30, 30, 30, 0.4);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.05);
        transition: transform 0.3s ease;
    }
    .upcoming-card:hover { transform: translateY(-5px); }
    .upcoming-card .poster {
        width: 110px;
        flex-shrink: 0;
    }
    .upcoming-card .poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .upcoming-card .info {
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .upcoming-card .title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
    }
    .upcoming-card .countdown-timer {
        font-family: 'Orbitron', sans-serif;
        font-size: 16px;
        color: var(--primary-color);
        font-weight: 700;
        text-shadow: 0 0 8px var(--primary-glow);
    }
    .upcoming-card .meta {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 10px;
    }

    .upcoming-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        text-align: center;
        padding: 8px;
        font-size: 11px;
        font-weight: 600;
        backdrop-filter: blur(5px);
    }
    .upcoming-overlay i {
        margin-right: 5px;
        color: var(--primary-color);
    }

    /* --- Theme Page Styles --- */
    #themes-page { padding: 0 15px; }
    #themes-page .form-page .auth-form { padding: 20px 0; }
    .themes-section { margin-bottom: 30px; }
    .themes-section h2 { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 20px; }
    .themes-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .theme-option { cursor: pointer; text-align: center; }
    .theme-preview {
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 12px;
        border: 3px solid var(--border-color);
        margin-bottom: 10px;
        display: flex;
        overflow: hidden;
        position: relative;
        transition: all 0.3s ease;
    }
    .theme-preview .color-swatch {
        width: 50%;
        height: 100%;
    }
    .theme-preview .swatch-dark {
        background-color: #1c1c1c;
    }
    .theme-option .theme-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        transition: color 0.3s ease;
    }
    .theme-option:hover .theme-preview {
        border-color: var(--primary-color);
    }
    .theme-option:hover .theme-name {
        color: var(--text-primary);
    }
    .theme-option.selected .theme-preview {
        border-color: var(--primary-color);
        box-shadow: 0 0 15px var(--primary-glow);
    }
    .theme-option.selected .theme-name {
        color: var(--primary-color);
        font-weight: 600;
    }
    .theme-option.selected .theme-preview::after {
        content: '\f00c';
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        color: white;
        background-color: rgba(0,0,0,0.5);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    /* --- Trailer Modal --- */
    #trailer-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        z-index: 1300;
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(8px);
    }
    #trailer-modal.show {
        display: flex;
        animation: fadeIn 0.3s ease;
    }
    .trailer-modal-content {
        position: relative;
        width: 95%;
        max-width: 480px;
        aspect-ratio: 16/9;
        background-color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .trailer-modal-close-btn {
        position: absolute;
        top: -40px;
        right: 0;
        background: none;
        border: none;
        color: #fff;
        font-size: 28px;
        cursor: pointer;
        font-weight: 300;
    }
    #trailer-link {
        display: inline-block;
        padding: 15px 30px;
        background-color: var(--primary-color);
        color: white;
        text-decoration: none;
        border-radius: 50px;
        font-weight: 600;
    }

    /* Report Modal Styles */
    #report-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 1300;
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(8px);
    }
    #report-modal.show {
        display: flex;
        animation: fadeIn 0.3s ease;
    }
    .report-modal-content {
        background-color: var(--card-bg);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid var(--border-color);
        position: relative;
        width: 90%;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .report-modal-close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 28px;
        cursor: pointer;
    }
    #report-form {
        margin-top: 20px;
    }
    #report-form .input-group {
        margin-bottom: 15px;
    }
    #report-form .auth-input {
        text-align: left;
        padding-left: 20px;
    }
    /* Themes Page Styles */
    .themes-section h2 { margin-bottom: 20px; color: var(--text-secondary); font-size: 18px; }
    .themes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
    .theme-option { cursor: pointer; border-radius: 12px; overflow: hidden; border: 2px solid transparent; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; }
    .theme-option:hover { transform: translateY(-3px); background: rgba(255,255,255,0.08); }
    .theme-option.active { border-color: var(--primary-color); background: rgba(255,255,255,0.1); box-shadow: 0 0 15px var(--primary-glow); }
    .theme-preview { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); }
    .theme-name { font-size: 12px; color: var(--text-primary); text-align: center; }

    /* Advanced Player Styling */
    .plyr--video {
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        --plyr-color-main: var(--primary-color);
        --plyr-video-background: #000;
        font-family: 'Poppins', sans-serif;
    }
    .plyr__control--overlaid {
        background: var(--primary-color);
        box-shadow: 0 0 20px var(--primary-glow);
    }
    .plyr__control--overlaid:hover {
        background: var(--primary-color);
        transform: scale(1.1);
    }

    /* Mobile Dimensions & Layout Adjustments */
    @media (max-width: 768px) {
        .slider-container {
            height: 50vh !important; /* Taller slider for mobile immersive feel */
            max-height: 450px;
        }
        
        /* Content Grid: 3 columns for better density on mobile */
        .content-grid {
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 10px !important;
        }
        
        .movie-card {
            border-radius: 6px;
        }
        
        .movie-card .rating {
            font-size: 10px;
            padding: 2px 6px;
        }

        /* Episodes Section Arrangement */
        #series-player-episode-list .episode-list {
            grid-template-columns: 1fr !important; /* Single column vertical list */
            gap: 10px !important;
        }
        
        #series-player-episode-list .episode-item {
            flex-direction: row !important; /* Horizontal layout for episode card */
            align-items: center;
            height: auto;
        }
        
        #series-player-episode-list .episode-thumbnail {
            width: 120px !important;
            height: 68px !important; /* 16:9 approx */
            flex-shrink: 0;
            margin-right: 12px;
        }
        
        #series-player-episode-list .episode-details {
            padding: 0 !important;
            text-align: left;
        }
        
        #series-player-episode-list .episode-details .title {
            font-size: 14px !important;
            margin-bottom: 4px;
            white-space: normal !important; /* Allow wrapping */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* General Mobile Tweaks */
        h1 { font-size: 24px !important; }
        h2 { font-size: 20px !important; }
        .page-header { margin-bottom: 20px !important; }
        .navbar-logo { font-size: 20px !important; }
        
        /* Better Spacing */
        .page-container {
            padding-bottom: 80px; /* Space for bottom nav */
        }
    }
    /* Custom Advanced Player Styles */
    :root {
        --player-theme-color: #00aaff;
        --player-anim-speed: 0.3s;
    }
    .custom-player {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        background-color: #000;
        width: 100%;
        height: 100%;
    }
    .custom-player *:focus {
        outline: none !important;
        box-shadow: none !important;
    }
    .custom-player:fullscreen {
        border-radius: 0;
    }
    .custom-player .video-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .custom-player video {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: contain;
    }
    .custom-player video.video-fill {
        object-fit: cover;
    }
    .custom-player .watermark {
        position: absolute;
        bottom: 15px;
        right: 15px;
        height: 25px;
        opacity: 0.6;
        transition: opacity var(--player-anim-speed), bottom var(--player-anim-speed);
        pointer-events: none;
        z-index: 15;
    }
    .custom-player:hover .watermark, .custom-player.paused .watermark, .custom-player.seeking .watermark {
        bottom: 85px;
    }
    .custom-player:fullscreen .watermark {
        bottom: 95px;
    }
    .custom-player .seek-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        color: white;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.5s ease, transform 0.2s ease;
        pointer-events: none;
        z-index: 15;
        border-radius: 50%;
        width: 60px;
        height: 60px;
    }
    .custom-player .seek-indicator.show {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
    .custom-player .seek-indicator svg { width: 40px; height: 40px; fill: white; }
    .custom-player .seek-forward-indicator { right: 15%; left: auto; transform: translate(0, -50%) scale(0.8); }
    .custom-player .seek-backward-indicator { left: 15%; right: auto; transform: translate(0, -50%) scale(0.8); }
    .custom-player .controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        opacity: 0;
        transition: opacity var(--player-anim-speed) ease-in-out;
        padding: 10px 15px;
        z-index: 20;
    }
    .custom-player:hover .controls, .custom-player.paused .controls, .custom-player.seeking .controls {
        opacity: 1;
    }
    .custom-player .progress-container {
        position: relative;
        width: 100%;
        height: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .custom-player .progress-range {
        height: 5px;
        width: 100%;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 4px;
        transition: height 0.2s ease;
    }
    .custom-player .progress-container:hover .progress-range { height: 8px; }
    .custom-player .progress-bar {
        background: var(--player-theme-color);
        width: 0%;
        height: 100%;
        border-radius: 4px;
        position: relative;
    }
    .custom-player .progress-bar-thumb {
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%) scale(0);
        width: 16px;
        height: 16px;
        background-color: var(--player-theme-color);
        border-radius: 50%;
        transition: transform 0.2s ease;
    }
    .custom-player .progress-container:hover .progress-bar-thumb, .custom-player.seeking .progress-bar-thumb {
        transform: translateY(-50%) scale(1);
    }
    .custom-player .controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .custom-player .left-controls, .custom-player .right-controls {
        display: flex;
        align-items: center;
    }
    .custom-player .control-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 8px;
        transition: transform 0.2s ease;
        position: relative;
    }
    .custom-player .control-btn:hover { transform: scale(1.15); }
    .custom-player .control-btn:active { transform: scale(0.95); }
    .custom-player .control-btn svg { width: 24px; height: 24px; fill: white; }
    .custom-player .volume-container { display: flex; align-items: center; }
    .custom-player .volume-range {
        -webkit-appearance: none; appearance: none;
        width: 0; height: 5px; background: white; border-radius: 5px;
        opacity: 0; transition: width 0.3s ease, opacity 0.3s ease;
    }
    .custom-player .volume-container:hover .volume-range { width: 100px; opacity: 1; margin-left: 8px; }
    .custom-player .volume-range::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none;
        width: 15px; height: 15px; background: var(--player-theme-color);
        border-radius: 50%; cursor: pointer;
    }
    .custom-player .time-display { color: white; font-size: 14px; margin: 0 15px; }
    .custom-player .live-badge {
        display: none; background-color: #e74c3c; color: white;
        padding: 3px 8px; border-radius: 4px; font-size: 14px;
        font-weight: bold; margin-right: 15px;
    }
    .custom-player.live .live-badge { display: block; }
    .custom-player.live .progress-container, .custom-player.live .time-display { display: none; }
    
    .custom-player .aspect-ratio-btn {
        display: none;
    }
    .custom-player:fullscreen .aspect-ratio-btn {
        display: block;
    }

    .custom-player .settings-menu {
        position: absolute;
        bottom: 60px;
        right: 10px;
        background-color: rgba(28, 40, 51, 0.95);
        border-radius: 8px;
        width: 280px;
        color: white;
        display: none;
        z-index: 30;
        overflow: hidden;
        transition: opacity 0.3s, transform 0.3s;
        transform-origin: bottom right;
    }
    .custom-player .settings-menu.active { display: block; }
    .custom-player .settings-menu-inner { padding: 10px; }
    .custom-player .settings-menu h4 { 
        margin: 5px 0 10px; padding-bottom: 8px; 
        border-bottom: 1px solid #555; font-size: 16px; 
        display: flex; align-items: center;
    }
    .custom-player .setting-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px 5px; font-size: 14px; cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .custom-player .setting-item:hover { background-color: rgba(255, 255, 255, 0.1); }
    .custom-player .setting-item label { font-weight: bold; }
    .custom-player .setting-item .value { color: #aaa; }
    .custom-player .setting-item input[type="range"] { width: 120px; cursor: pointer; }
    .custom-player .submenu { display: none; }
    .custom-player .submenu.active { display: block; }
    .custom-player .submenu .speed-option { padding: 10px 15px; cursor: pointer; }
    .custom-player .submenu .speed-option:hover { background-color: rgba(255, 255, 255, 0.1); }
    .custom-player .submenu .speed-option.selected { font-weight: bold; color: var(--player-theme-color); }
    .custom-player .back-btn { cursor: pointer; margin-right: 10px; padding: 5px; }
    .custom-player .back-btn:hover { background-color: rgba(255,255,255,0.1); border-radius: 50%; }
    .custom-player .about-section { 
        padding: 10px 0; font-size: 12px; text-align: center; 
        border-top: 1px solid #555; margin-top: 10px; opacity: 0.7;
    }
</style>
</head>
<body>

    <div id="pin-lock-overlay" class="hidden">
        <div class="pin-lock-container">
            <div class="logo">
                <span class="movie-text">RANG</span><span class="hunt-text">MANCH</span>
            </div>
            <p class="pin-lock-prompt">Enter your PIN</p>
            <div class="pin-display" id="pin-lock-display">
                <span></span><span></span><span></span><span></span>
            </div>
            <p id="pin-lock-error" class="error-message"></p>
            <div class="pin-keypad" id="pin-lock-keypad">
                <button>1</button><button>2</button><button>3</button>
                <button>4</button><button>5</button><button>6</button>
                <button>7</button><button>8</button><button>9</button>
                <button class="keypad-blank"></button>
                <button>0</button>
                <button><i class="fas fa-delete-left"></i></button>
            </div>
        </div>
    </div>

    <div id="maintenance-page" class="hidden">
        <i class="fas fa-tools maintenance-icon"></i>
        <h1>Under Maintenance</h1>
        <p id="maintenance-message-text">We are currently performing scheduled maintenance. We will be back shortly. Thank you for your patience.</p>
    </div>

    <div id="loading-page">
        <div class="logo">
            <span class="movie-text">RANG</span><span class="hunt-text">MANCH</span>
        </div>
    </div>

    <div id="auth-container" class="hidden">
        <div id="login-page-pro" class="auth-page">
            <div class="auth-logo">
                <div class="logo">
                    <span class="movie-text">RANG</span><span class="hunt-text">MANCH</span>
                </div>
            </div>
            <div class="auth-form">
                <h1>Welcome Back</h1>
                <form id="login-form">
                    <div class="input-group"><input type="email" id="login-email" class="auth-input" placeholder="Email Address" required=""></div>
                    <div class="input-group"><input type="password" id="login-password" class="auth-input" placeholder="Password" required=""><i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('login-password', this)"></i></div>
                    <p id="login-error" class="error-message"></p>
                    <button type="submit" class="auth-btn">Login</button>
                </form>
                <button type="button" class="auth-btn" id="google-login-btn" style="margin-top:10px;"><i class="fab fa-google"></i> Continue with Google</button>
                <button type="button" class="auth-btn guest-btn" id="guest-login-btn">Login as Guest</button>
                <p class="auth-switch-link">Don't have an account? <a onclick="toggleAuthForms()">Sign Up</a></p>
            </div>
        </div>
        <div id="signup-page-pro" class="auth-page hidden">
            <div class="auth-logo">
                <div class="logo">
                     <span class="movie-text">RANG</span><span class="hunt-text">MANCH</span>
                </div>
            </div>
            <div class="auth-form">
                <h1>Create Account</h1>
                <form id="signup-form">
                    <div class="input-group"><input type="text" id="signup-name" class="auth-input" placeholder="Full Name" required=""></div>
                    <div class="input-group"><input type="email" id="signup-email" class="auth-input" placeholder="Email Address" required=""></div>
                    <div class="input-group"><input type="password" id="signup-password" class="auth-input" placeholder="Password" required=""><i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('signup-password', this)"></i></div>
                    <p id="signup-error" class="error-message"></p><button type="submit" class="auth-btn">Sign Up</button>
                </form>
                <button type="button" class="auth-btn" id="google-signup-btn" style="margin-top:10px;"><i class="fab fa-google"></i> Continue with Google</button>
                <p class="auth-switch-link">Already have an account? <a onclick="toggleAuthForms()">Login</a></p>
            </div>
        </div>
    </div>

<div id="app-wrapper" class="hidden">
    <button class="back-btn" id="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    <div id="home-page">
        <header class="header" id="home-header">
            <div class="logo">
                <span class="movie-text">RANG</span><span class="hunt-text">MANCH</span>
            </div>
            <div class="header-icons">
                <button class="search-btn" onclick="openSearch()"><i class="fas fa-search"></i><span>Search</span></button>
                <div class="icon-wrapper">
                    <i class="fas fa-bell" onclick="navigateTo('notifications')"></i>
                    <div id="unread-indicator" class="unread-indicator hidden"></div>
                </div>
            </div>
        </header>
        <div id="page-header" class="page-header hidden"><h1><i id="page-icon" class="fas fa-bookmark"></i> <span id="page-title">My Watchlist</span> <span class="brand-badge">RANGMANCH</span></h1></div>
        <main>
            <div id="home-content" class="page-content"></div>
            <div id="series-content" class="page-content hidden"></div>
            <div id="anime-content" class="page-content hidden"></div>
            <div id="watchlist-content" class="page-content hidden"></div>
            <div id="category-grid-content" class="page-content hidden"></div>
        </main>
    </div>

    <!-- NEW TV PAGE UI -->
    <div id="livetv-page" class="page-container hidden">
         <header class="header" id="livetv-header">
            <div class="logo">
                <span class="movie-text">RANG</span><span class="hunt-text">MANCH</span>    
            </div>
            <div class="header-icons">
            </div>
        </header>
        <div class="search-input-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input-full" id="livetv-search-input" placeholder="Search for TV channels...">
        </div>
        <div class="category-filters" id="livetv-category-filters">
        </div>
        <main id="livetv-content"></main>
    </div>

    

    <div id="notification-page" class="page-container hidden">
        <div class="notification-header">
            <h1>Notifications</h1>
        </div>
        <div id="notification-list-container" class="notification-list"></div>
    </div>
    <div id="profile-page" class="page-container hidden">
        <div class="profile-header-pro">
            <div class="profile-avatar-wrapper">
                <div id="profile-avatar-container" class="profile-avatar-pro"></div>
                <button id="change-avatar-btn"><i class="fas fa-camera"></i></button>
            </div>
            <h2 id="profile-user-name" class="profile-name"></h2>
            <p id="profile-user-email" class="profile-email"></p>
        </div>
        <div class="profile-stats">
            <div class="stat-item">
                <div id="joining-date-stat" class="stat-number">Loading...</div>
                <div class="stat-label">Member Since</div>
            </div>
        </div>
        <div class="profile-menu">
            <div class="profile-menu-group"><h3 class="group-title">My Account</h3>
                <a class="menu-item" onclick="navigateTo('myPlan')"><i class="icon fas fa-user-check"></i><span class="text">My Plan</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('watchlist')"><i class="icon fas fa-bookmark"></i><span class="text">My Watchlist</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('upcoming')"><i class="icon fas fa-clock"></i><span class="text">Upcoming</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('history')"><i class="icon fas fa-history"></i><span class="text">Watch History</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" id="movie-request-link" onclick="navigateTo('movieRequest')"><i class="icon fas fa-film"></i><span class="text">Movie Request</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('subscription')"><i class="icon fas fa-crown"></i><span class="text">Subscription</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('verifySubscription')"><i class="icon fas fa-check-circle"></i><span class="text">Verify Subscription</span><i class="chevron fas fa-chevron-right"></i></a>
            </div>
            <div class="profile-menu-group"><h3 class="group-title">Settings &amp; Support</h3>
                <a class="menu-item" id="account-settings-link" onclick="navigateTo('accountSettings')"><i class="icon fas fa-user-cog"></i><span class="text">Account Settings</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('themes')"><i class="icon fas fa-palette"></i><span class="text">Themes &amp; Appearance</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" id="app-lock-link" onclick="navigateTo('appLock')"><i class="icon fas fa-lock"></i><span class="text">App Lock</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" id="url-maker-link" onclick="navigateTo('urlMaker')"><i class="icon fas fa-link"></i><span class="text">Url Maker</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" id="redeem-code-link" onclick="navigateTo('redeem')"><i class="icon fas fa-ticket-alt"></i><span class="text">Redeem Code</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" id="report-bug-link" onclick="navigateTo('reportBug')"><i class="icon fas fa-bug"></i><span class="text">Report a Bug</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('help')"><i class="icon fas fa-question-circle"></i><span class="text">Help &amp; Support</span><i class="chevron fas fa-chevron-right"></i></a>
            </div>
            <div class="profile-menu-group"><h3 class="group-title">Legal</h3>
                <a class="menu-item" onclick="navigateTo('rules')"><i class="icon fas fa-gavel"></i><span class="text">Rules</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('privacy')"><i class="icon fas fa-shield-alt"></i><span class="text">Privacy Policy</span><i class="chevron fas fa-chevron-right"></i></a>
                <a class="menu-item" onclick="navigateTo('about')"><i class="icon fas fa-info-circle"></i><span class="text">About App</span><i class="chevron fas fa-chevron-right"></i></a>
            </div>
            <div class="profile-menu-group"><a class="menu-item logout-item" onclick="handleLogout()"><i class="icon fas fa-sign-out-alt"></i><span class="text">Logout</span><i class="chevron fas fa-chevron-right"></i></a></div>
        </div>
    </div>

    <div id="privacy-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>Privacy Policy</h1></div>
        <div class="static-page-content">
            <h2>Information We Collect</h2>
            <p>We may collect personal information that you provide to us, such as your name, email address, and profile picture when you create an account.</p>
            <h2>How We Use Your Information</h2>
            <p>We use the information we collect to operate, maintain, and provide you with the features and functionality of the Service. We may use your email address to send you Service-related notices.</p>
            <h2>Data Security</h2>
            <p>We care about the security of your information and use commercially reasonable safeguards to preserve the integrity and security of all information collected through the Service.</p>
            <p><strong>Last Updated: [Date]</strong></p>
        </div>
    </div>

    <div id="about-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>About RANGMANCH</h1></div>
        <div class="static-page-content">
            <h2>Welcome to RANGMANCH</h2>
            <p>RANGMANCH is your ultimate destination for discovering and enjoying a vast collection of movies, web series, and anime. Our platform is designed to provide a seamless and immersive entertainment experience right at your fingertips.</p>

            <h3>Our Mission</h3>
            <p>Our goal is to bring high-quality entertainment to everyone, everywhere. We constantly update our library to include the latest hits, timeless classics, and hidden gems across various genres and languages.</p>

            <h3>Credits</h3>
            <p>This application was brought to life by a dedicated team.</p>
            <ul>
                <li><strong>Developer:</strong> Vinayak</li>
                <li><strong>Athing:</strong> [Describe Athing's role or contribution here]</li>
            </ul>

             <p>Thank you for being a part of our community!</p>
        </div>
    </div>

    <div id="rules-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>Rules &amp; Regulations</h1></div>
        <div class="static-page-content">
            <h3>1. Subscription</h3>
            <p>Only genuine payments will be accepted for your subscription to be activated. Any fraudulent activity will lead to immediate account suspension.</p>

            <h3>2. Live TV Access</h3>
            <p>The Live TV feature is an exclusive benefit for Premium Members of RANGMANCH. An active premium subscription is required to access this service.</p>

            <h3>3. Spam &amp; Misuse</h3>
            <p>Spamming the "Report a Bug" feature, making inappropriate requests, or engaging in any suspicious activity is strictly prohibited. Violators will be permanently banned from the platform without prior notice.</p>
            
            <h3>4. Data Privacy</h3>
            <p>We are committed to protecting your privacy. Your data is safe with us. We do not access or collect any unnecessary personal data from your device. For more details, please review our Privacy Policy.</p>
        </div>
    </div>

    <div id="help-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>Help &amp; Support</h1></div>
        <div class="static-page-content">
            <h2>Frequently Asked Questions</h2>
            <p><strong>How do I request a movie?</strong><br>You can request a movie by going to your Profile page and tapping on "Movie Request". Fill in the details and submit.</p>
            <p><strong>How does Watch History work?</strong><br>Your watch history is automatically updated whenever you start playing a movie or show. You can view it from your Profile page.</p>
            <h2>Contact Us</h2>
            <p>If you have any other questions or need further assistance, please feel free to contact our support team at:<br><strong>[Your Support Email Here]</strong></p>
        </div>
    </div>

    <div id="history-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>Watch History</h1></div>
        <div id="history-container" class="watchlist-container-pro"></div>
    </div>

    <div id="upcoming-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>Coming Soon</h1></div>
        <div id="upcoming-container"></div>
    </div>

    <div id="movie-request-page" class="page-container hidden form-page">
         <div class="auth-form">
            <h1>Request a Movie</h1>
            <form id="movie-request-form">
                <div class="input-group"><input type="text" id="request-movie-name" class="auth-input" placeholder="Movie Name" required=""></div>
                <div class="input-group"><input type="number" id="request-movie-year" class="auth-input" placeholder="Year of Release (e.g., 2023)" required=""></div>
                <button type="submit" class="auth-btn">Submit Request</button>
            </form>
        </div>
    </div>

    <div id="report-bug-page" class="page-container hidden form-page">
        <div class="auth-form">
           <h1>Report a Bug</h1>
           <form id="report-bug-form">
               <div class="input-group">
                    <textarea id="report-bug-description" class="auth-input" placeholder="Please describe the issue in detail..." required=""></textarea>
                </div>
               <button type="submit" class="auth-btn">Submit Report</button>
           </form>
       </div>
    </div>

    <div id="subscription-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>Choose Your Plan</h1></div>
        <div id="subscription-plan-container" class="subscription-plan-grid"></div>
    </div>

    <div id="redeem-page" class="page-container hidden form-page">
         <div class="auth-form">
            <h1>Redeem a Code</h1>
            <form id="redeem-code-form">
                <div class="input-group">
                    <input type="text" id="redeem-code-input" class="auth-input" placeholder="Enter your code" required="">
                </div>
                <button type="submit" class="auth-btn">Redeem</button>
            </form>
        </div>
    </div>

    <div id="my-plan-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>My Plan Details</h1></div>
        <div id="my-plan-details-container"></div>
    </div>

    <div id="verify-subscription-page" class="page-container hidden form-page">
        <div class="page-header centered-header"><h1>Verify Subscription</h1></div>
        <div class="auth-form">
            <h1>Submit Verification</h1>
            <form id="verify-subscription-form">
                <div class="input-group">
                    <select id="verify-plan-select" class="auth-input" required>
                        <option value="" disabled selected>Select Plan</option>
                    </select>
                </div>
                <div class="input-group">
                    <button type="button" class="auth-btn" id="open-verification-btn">Open Verification Form</button>
                </div>
            </form>
            <p style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 10px;">After payment, submit your details for admin verification.</p>
        </div>
    </div>

    <div id="account-settings-page" class="page-container hidden form-page">
        <div class="auth-form">
            <h1>Account Settings</h1>
            <form id="account-settings-form">
                <div class="input-group"><input type="text" id="settings-name" class="auth-input" placeholder="Full Name" required=""></div>
                <div class="input-group"><input type="email" id="settings-email" class="auth-input" placeholder="Email Address" readonly=""></div>
                <p style="font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: -10px; margin-bottom: 20px;">Email cannot be changed.</p>

                <div class="input-group">
                    <p class="settings-label">Gender</p>
                    <div class="gender-radio-group">
                        <label>
                            <input type="radio" name="gender" value="male">
                            <span class="gender-radio-label">Male</span>
                        </label>
                        <label>
                            <input type="radio" name="gender" value="female">
                            <span class="gender-radio-label">Female</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="auth-btn">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="app-lock-page" class="page-container hidden form-page">
        <div class="page-header centered-header"><h1>App Lock</h1></div>
        <div class="auth-form">
            <form id="app-lock-form">
                <div class="app-lock-toggle-wrapper">
                    <span>Enable App Lock</span>
                    <label class="switch">
                        <input type="checkbox" id="app-lock-enabled-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="app-lock-pin-container" class="hidden">
                    <div class="input-group">
                        <input type="password" id="app-lock-pin" class="auth-input" placeholder="Enter 4-digit PIN" maxlength="4" pattern="\d{4}" inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <input type="password" id="app-lock-pin-confirm" class="auth-input" placeholder="Confirm 4-digit PIN" maxlength="4" pattern="\d{4}" inputmode="numeric">
                    </div>
                </div>
                <p id="app-lock-error" class="error-message"></p>
                <button type="submit" class="auth-btn">Save Settings</button>
            </form>
        </div>
    </div>

    <div id="themes-page" class="page-container hidden form-page">
        <div class="page-header centered-header"><h1>Themes &amp; Appearance</h1></div>
        <div class="auth-form">
             <div class="themes-section">
                <h2>Color Themes</h2>
                <div class="themes-grid" id="themes-grid-container">
                    <!-- Theme options will be generated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <div id="url-maker-page" class="page-container hidden">
        <div class="page-header centered-header"><h1>Url Maker</h1></div>
        <iframe id="url-maker-iframe" src="https://prouploader.blogspot.com/" style="width: 100%; height: calc(100vh - 70px); border: none;"></iframe>
    </div>

    <div class="detail-page" id="detail-page">
        <div class="detail-backdrop" id="detail-backdrop"></div>
        <div class="detail-content">
            <h1 class="detail-title" id="detail-title"></h1>
            <div class="detail-meta" id="detail-meta"></div>
            <div class="detail-actions">
                <button class="btn-play-full" id="play-btn">
                    <i class="fas fa-play"></i>
                    <span>PLAY</span>
                </button>
            </div>
            <div class="storyline-wrapper">
                <p class="detail-storyline" id="detail-storyline"></p>
            </div>
            <div class="secondary-actions-container">
                <div class="action-icon-btn" id="detail-trailer-btn"> <i class="fas fa-video"></i> <span>Trailer</span></div>
                <div class="action-icon-btn" id="detail-watchlist-btn"> <i class="fas fa-plus"></i> <span>My List</span></div>
                <div class="action-icon-btn" id="detail-report-btn"> <i class="fas fa-flag"></i> <span>Report</span></div>
            </div>
            <div class="cast-section" id="detail-cast-section">
                <div class="category-header" style="padding: 0; margin-bottom: 20px;">
                    <h2 class="category-title">Cast</h2>
                </div>
                <div class="cast-list" id="detail-cast-list"></div>
            </div>
            <div class="category-section" id="similar-section">
                <div class="category-header" style="padding: 0;">
                    <h2 class="category-title">More Like This</h2>
                </div>
                <div class="content-slider" id="similar-slider"></div>
            </div>
             <div class="comments-section" id="detail-comments-section">
                <h2 class="category-title">Comments</h2>
                <div class="comment-form-container">
                    <form class="comment-form" id="movie-comment-form">
                        <textarea class="comment-input" id="movie-comment-input" placeholder="Add a public comment..."></textarea>
                        <button type="submit" class="comment-submit-btn" id="movie-comment-submit-btn">Comment</button>
                    </form>
                </div>
                <div class="comments-list" id="movie-comments-list"></div>
            </div>
        </div>
    </div>

    <div class="detail-page" id="series-detail-page">
        <div class="detail-backdrop" id="series-detail-backdrop"></div>
        <div class="detail-content">
            <h1 class="detail-title" id="series-detail-title"></h1>
            <div class="detail-meta" id="series-detail-meta"></div>
            <div class="storyline-wrapper"> <p class="detail-storyline" id="series-detail-storyline"></p> </div>
            <div class="secondary-actions-container">
                 <div class="action-icon-btn" id="series-detail-watchlist-btn"> <i class="fas fa-plus"></i> <span>My List</span> </div>
                 <div class="action-icon-btn" id="series-detail-report-btn"> <i class="fas fa-flag"></i> <span>Report</span> </div>
            </div>
        </div>
        <div class="detail-tabs">
            <button class="tab-link active" onclick="openDetailTab(event, 'Episodes')">Episodes</button>
            <button class="tab-link" onclick="openDetailTab(event, 'Cast')">Cast</button>
            <button class="tab-link" onclick="openDetailTab(event, 'Similar')">More Like This</button>
            <button class="tab-link" onclick="openDetailTab(event, 'Comments')">Comments</button>
        </div>
        <div id="Episodes" class="tab-content" style="display: block;">
            <div id="seasons-container"></div>
        </div>
        <div id="Cast" class="tab-content">
            <div class="cast-section" style="margin-bottom: 0;">
                 <div class="cast-list" id="series-detail-cast-list"></div>
            </div>
        </div>
        <div id="Similar" class="tab-content">
            <div class="category-section" id="series-similar-section">
                <div class="content-slider" id="series-similar-slider"></div>
            </div>
        </div>
        <div id="Comments" class="tab-content">
             <div class="comments-section" id="series-comments-section">
                <div class="comment-form-container" style="margin-top: 20px;">
                    <form class="comment-form" id="series-comment-form">
                        <textarea class="comment-input" id="series-comment-input" placeholder="Add a public comment..."></textarea>
                        <button type="submit" class="comment-submit-btn" id="series-comment-submit-btn">Comment</button>
                    </form>
                </div>
                <div class="comments-list" id="series-comments-list"></div>
            </div>
        </div>
    </div>

    <div class="player-page" id="movie-player-page">
        <div class="player-wrapper">
            <button class="player-back-btn" onclick="exitPlayerAndGoBack()"><i class="fas fa-arrow-left"></i></button>
            <div class="player-loading-overlay"><div class="plyr__spinner"></div></div>
            <div class="custom-player paused">
                <div class="video-wrapper">
                    <video id="movie-player-element" playsinline="" preload="metadata"></video>
                </div>
                <div class="controls">
                    <div class="progress-container">
                        <div class="progress-range">
                            <div class="progress-bar">
                                <div class="progress-bar-thumb"></div>
                            </div>
                        </div>
                    </div>
                    <div class="controls-container">
                        <div class="left-controls">
                            <button class="control-btn play-pause-btn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></button>
                            <div class="volume-container">
                                <button class="control-btn volume-btn"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg></button>
                                <input type="range" class="volume-range" min="0" max="1" step="0.01" value="1">
                            </div>
                            <div class="live-badge">LIVE</div>
                            <div class="time-display">0:00 / 0:00</div>
                        </div>
                        <div class="right-controls">
                            <button class="control-btn pip-btn"><svg viewBox="0 0 24 24"><path d="M19 7h-8v6h8V7zm2-4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"></path></svg></button>
                            <button class="control-btn aspect-ratio-btn" title="Fill Screen">
                                <svg class="fit-icon" viewBox="0 0 24 24"><path d="M21 17h-2v2h-2v-4h4v2zm-4-8h2V7h2V3h-4v4zm-8-4H7v2H3v4h4V7zm2 14H7v-2H3v-4h4v4z"></path></svg>
                                <svg class="fill-icon" style="display: none;" viewBox="0 0 24 24"><path d="M19.5 5.5v13h-15v-13h15m0-2h-15c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2v-13c0-1.1-.9-2-2-2z"></path></svg>
                            </button>
                            <button class="control-btn settings-btn"><svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04 .32-.07 .65-.07 .98s.03 .66.07 .98l-2.11 1.65c-.19 .15-.24 .42-.12 -.64l2 3.46c.12 .22.39 .3.61 .22l2.49 1c.52 .4 1.08 .73 1.69 .98l.38 2.65c.03 .24.24 .42.49 .42h4c.25 0 .46 -.18.49 -.42l.38 -2.65c.61 -.25 1.17 -.59 -1.69 .98l2.49 1c.23 .09 .49 0 .61 -.22l2 -3.46c.12 -.22 .07 -.49 -.12 -.64l-2.11 -1.65zM12 15.5c-1.93 0 -3.5 -1.57 -3.5 -3.5s1.57 -3.5 3.5 -3.5 3.5 1.57 3.5 3.5 -1.57 3.5 -3.5 3.5z"></path></svg></button>
                            <button class="control-btn fullscreen-btn"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg></button>
                        </div>
                    </div>
                </div>
                <div class="settings-menu">
                    <div class="main-menu">
                        <div class="settings-menu-inner">
                            <h4>Settings</h4>
                            <div class="setting-item" data-menu="speed">
                                <label>Playback Speed</label>
                                <span class="value speed-value">Normal</span>
                            </div>
                            <div class="setting-item">
                                <label for="seek-time-movie">Seek Step (sec)</label>
                                <span class="seek-time-value">10s</span>
                            </div>
                            <input type="range" id="seek-time-movie" min="5" max="30" value="10" step="1" style="width: 100%; margin-top: 5px;">
                            <div class="about-section">RANGMANCH Player</div>
                        </div>
                    </div>
                    <div class="submenu" data-menu="speed">
                        <div class="settings-menu-inner">
                            <h4><svg class="back-btn" viewBox="0 0 24 24" width="24" height="24"><path fill="white" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>Playback Speed</h4>
                            <div class="speed-option" data-speed="0.5">0.5x</div>
                            <div class="speed-option" data-speed="0.75">0.75x</div>
                            <div class="speed-option selected" data-speed="1">Normal</div>
                            <div class="speed-option" data-speed="1.5">1.5x</div>
                            <div class="speed-option" data-speed="2">2.0x</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="player-error-overlay">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Could not play video.</p>
                <button class="error-back-btn" onclick="exitPlayerAndGoBack()">Go Back</button>
            </div>
            <div class="player-rotate-overlay">
                <i class="fas fa-mobile-alt"></i>
                <p>Rotate your device</p>
            </div>
        </div>
        <div class="movie-player-info">
            <h1 class="movie-player-title" id="movie-player-title"></h1>
            <div class="secondary-actions-container" id="movie-player-actions" style="margin-bottom: 20px;">
                <button class="action-icon-btn" id="player-like-btn"> <i class="far fa-thumbs-up"></i> <span class="action-count" id="player-like-count">0</span> </button>
                <button class="action-icon-btn" id="player-dislike-btn"> <i class="far fa-thumbs-down"></i> <span class="action-count" id="player-dislike-count">0</span> </button>
                <button class="action-icon-btn" id="player-watchlist-btn"> <i class="fas fa-plus"></i><span>My List</span> </button>
                <button class="action-icon-btn" id="player-report-btn"> <i class="fas fa-flag"></i><span>Report</span> </button>
            </div>
            <div class="autoplay-toggle-wrapper">
                <div class="autoplay-toggle">
                    <span>Autoplay</span>
                    <label class="switch">
                        <input type="checkbox" id="movie-autoplay-switch" checked="">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="movie-player-suggestions category-section">
                <div class="category-header" style="padding: 0;"><h2 class="category-title" style="font-size: 18px;">More Like This</h2></div>
                <div class="content-slider" id="movie-player-similar-slider"></div>
            </div>
        </div>
    </div>

    <div class="player-page" id="series-player-page">
        <div class="player-wrapper">
            <button class="player-back-btn" onclick="exitPlayerAndGoBack()"><i class="fas fa-arrow-left"></i></button>
            <div class="player-loading-overlay"><div class="plyr__spinner"></div></div>
            <div class="custom-player paused">
                <div class="video-wrapper">
                    <video id="series-player-element" playsinline="" preload="metadata"></video>
                </div>
                <div class="controls">
                    <div class="progress-container">
                        <div class="progress-range">
                            <div class="progress-bar">
                                <div class="progress-bar-thumb"></div>
                            </div>
                        </div>
                    </div>
                    <div class="controls-container">
                        <div class="left-controls">
                            <button class="control-btn play-pause-btn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></button>
                            <div class="volume-container">
                                <button class="control-btn volume-btn"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg></button>
                                <input type="range" class="volume-range" min="0" max="1" step="0.01" value="1">
                            </div>
                            <div class="live-badge">LIVE</div>
                            <div class="time-display">0:00 / 0:00</div>
                        </div>
                        <div class="right-controls">
                            <button class="control-btn pip-btn"><svg viewBox="0 0 24 24"><path d="M19 7h-8v6h8V7zm2-4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"></path></svg></button>
                            <button class="control-btn aspect-ratio-btn" title="Fill Screen">
                                <svg class="fit-icon" viewBox="0 0 24 24"><path d="M21 17h-2v2h-2v-4h4v2zm-4-8h2V7h2V3h-4v4zm-8-4H7v2H3v4h4V7zm2 14H7v-2H3v-4h4v4z"></path></svg>
                                <svg class="fill-icon" style="display: none;" viewBox="0 0 24 24"><path d="M19.5 5.5v13h-15v-13h15m0-2h-15c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2v-13c0-1.1-.9-2-2-2z"></path></svg>
                            </button>
                            <button class="control-btn settings-btn"><svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04 .32-.07 .65-.07 .98s.03 .66.07 .98l-2.11 1.65c-.19 .15-.24 .42-.12 -.64l2 3.46c.12 .22.39 .3.61 .22l2.49 1c.52 .4 1.08 .73 1.69 .98l.38 2.65c.03 .24.24 .42.49 .42h4c.25 0 .46 -.18.49 -.42l.38 -2.65c.61 -.25 1.17 -.59 -1.69 .98l2.49 1c.23 .09 .49 0 .61 -.22l2 -3.46c.12 -.22 .07 -.49 -.12 -.64l-2.11 -1.65zM12 15.5c-1.93 0 -3.5 -1.57 -3.5 -3.5s1.57 -3.5 3.5 -3.5 3.5 1.57 3.5 3.5 -1.57 3.5 -3.5 3.5z"></path></svg></button>
                            <button class="control-btn fullscreen-btn"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg></button>
                        </div>
                    </div>
                </div>
                <div class="settings-menu">
                    <div class="main-menu">
                        <div class="settings-menu-inner">
                            <h4>Settings</h4>
                            <div class="setting-item" data-menu="speed">
                                <label>Playback Speed</label>
                                <span class="value speed-value">Normal</span>
                            </div>
                            <div class="setting-item">
                                <label for="seek-time-series">Seek Step (sec)</label>
                                <span class="seek-time-value">10s</span>
                            </div>
                            <input type="range" id="seek-time-series" min="5" max="30" value="10" step="1" style="width: 100%; margin-top: 5px;">
                            <div class="about-section">RANGMANCH Player</div>
                        </div>
                    </div>
                    <div class="submenu" data-menu="speed">
                        <div class="settings-menu-inner">
                            <h4><svg class="back-btn" viewBox="0 0 24 24" width="24" height="24"><path fill="white" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>Playback Speed</h4>
                            <div class="speed-option" data-speed="0.5">0.5x</div>
                            <div class="speed-option" data-speed="0.75">0.75x</div>
                            <div class="speed-option selected" data-speed="1">Normal</div>
                            <div class="speed-option" data-speed="1.5">1.5x</div>
                            <div class="speed-option" data-speed="2">2.0x</div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="player-error-overlay">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Could not load this episode.</p>
                <button class="error-back-btn" onclick="exitPlayerAndGoBack()">Go Back</button>
            </div>
            <div class="player-rotate-overlay">
                <i class="fas fa-mobile-alt"></i>
                <p>Rotate your device</p>
            </div>
        </div>
        <div class="movie-player-info">
            <h1 class="movie-player-title" id="series-player-title"></h1>
            <div class="secondary-actions-container" id="series-player-actions">
                <button class="action-icon-btn" id="series-player-like-btn"> <i class="far fa-thumbs-up"></i> <span class="action-count" id="series-player-like-count">0</span> </button>
                <button class="action-icon-btn" id="series-player-dislike-btn"> <i class="far fa-thumbs-down"></i> <span class="action-count" id="series-player-dislike-count">0</span> </button>
                <button class="action-icon-btn" id="series-player-watchlist-btn"> <i class="fas fa-plus"></i><span>My List</span> </button>
                <button class="action-icon-btn" id="series-player-report-btn"> <i class="fas fa-flag"></i><span>Report</span> </button>
            </div>
            <div class="episodes-header">
                <h3>All Episodes</h3>
                <div class="autoplay-toggle">
                    <span>Autoplay</span>
                    <label class="switch">
                        <input type="checkbox" id="series-autoplay-switch" checked="">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div id="series-player-episode-list">
            </div>
        </div>
    </div>

    <div class="player-page" id="livetv-player-page">
        <div class="player-wrapper">
             <button class="player-back-btn" onclick="exitPlayerAndGoBack()"><i class="fas fa-arrow-left"></i></button>
            <div class="player-loading-overlay"><div class="plyr__spinner"></div></div>
            <div class="player-error-overlay">
                <i class="fas fa-broadcast-tower"></i>
                <p>Stream is currently unavailable.</p>
                <button class="error-back-btn" onclick="exitPlayerAndGoBack()">Go Back</button>
            </div>
            <div class="custom-player paused">
                <div class="video-wrapper">
                    <video id="livetv-player-element" playsinline="" preload="metadata"></video>
                </div>
                <div class="controls">
                    <div class="progress-container">
                        <div class="progress-range">
                            <div class="progress-bar">
                                <div class="progress-bar-thumb"></div>
                            </div>
                        </div>
                    </div>
                    <div class="controls-container">
                        <div class="left-controls">
                            <button class="control-btn play-pause-btn"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></button>
                            <div class="volume-container">
                                <button class="control-btn volume-btn"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg></button>
                                <input type="range" class="volume-range" min="0" max="1" step="0.01" value="1">
                            </div>
                            <div class="live-badge">LIVE</div>
                            <div class="time-display">0:00 / 0:00</div>
                        </div>
                        <div class="right-controls">
                            <button class="control-btn pip-btn"><svg viewBox="0 0 24 24"><path d="M19 7h-8v6h8V7zm2-4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"></path></svg></button>
                            <button class="control-btn aspect-ratio-btn" title="Fill Screen">
                                <svg class="fit-icon" viewBox="0 0 24 24"><path d="M21 17h-2v2h-2v-4h4v2zm-4-8h2V7h2V3h-4v4zm-8-4H7v2H3v4h4V7zm2 14H7v-2H3v-4h4v4z"></path></svg>
                                <svg class="fill-icon" style="display: none;" viewBox="0 0 24 24"><path d="M19.5 5.5v13h-15v-13h15m0-2h-15c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2v-13c0-1.1-.9-2-2-2z"></path></svg>
                            </button>
                            <button class="control-btn settings-btn"><svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04 .32-.07 .65-.07 .98s.03 .66.07 .98l-2.11 1.65c-.19 .15-.24 .42-.12 -.64l2 3.46c.12 .22.39 .3.61 .22l2.49 1c.52 .4 1.08 .73 1.69 .98l.38 2.65c.03 .24.24 .42.49 .42h4c.25 0 .46 -.18.49 -.42l.38 -2.65c.61 -.25 1.17 -.59 -1.69 .98l2.49 1c.23 .09 .49 0 .61 -.22l2 -3.46c.12 -.22 .07 -.49 -.12 -.64l-2.11 -1.65zM12 15.5c-1.93 0 -3.5 -1.57 -3.5 -3.5s1.57 -3.5 3.5 -3.5 3.5 1.57 3.5 3.5 -1.57 3.5 -3.5 3.5z"></path></svg></button>
                            <button class="control-btn fullscreen-btn"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg></button>
                        </div>
                    </div>
                </div>
                <div class="settings-menu">
                    <div class="main-menu">
                        <div class="settings-menu-inner">
                            <h4>Settings</h4>
                            <div class="setting-item" data-menu="speed">
                                <label>Playback Speed</label>
                                <span class="value speed-value">Normal</span>
                            </div>
                            <div class="setting-item">
                                <label for="seek-time-livetv">Seek Step (sec)</label>
                                <span class="seek-time-value">10s</span>
                            </div>
                            <input type="range" id="seek-time-livetv" min="5" max="30" value="10" step="1" style="width: 100%; margin-top: 5px;">
                            <div class="about-section">RANGMANCH Player</div>
                        </div>
                    </div>
                    <div class="submenu" data-menu="speed">
                        <div class="settings-menu-inner">
                            <h4><svg class="back-btn" viewBox="0 0 24 24" width="24" height="24"><path fill="white" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>Playback Speed</h4>
                            <div class="speed-option" data-speed="0.5">0.5x</div>
                            <div class="speed-option" data-speed="0.75">0.75x</div>
                            <div class="speed-option selected" data-speed="1">Normal</div>
                            <div class="speed-option" data-speed="1.5">1.5x</div>
                            <div class="speed-option" data-speed="2">2.0x</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="player-rotate-overlay">
                <i class="fas fa-mobile-alt"></i>
                <p>Rotate your device</p>
            </div>
        </div>
        <!-- Channel Recommendations Section -->
        <div id="livetv-player-recommendations" class="category-section" style="margin-top: 20px;">
            <div class="category-header">
                <h2 class="category-title">Recommended Channels</h2>
            </div>
            <div class="content-slider"></div>
        </div>
    </div>

    <div class="search-page" id="search-page">
        <div class="search-header">
            <button class="back-btn-search" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
            <h1>Search</h1>
        </div>
        <div class="search-input-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input-full" id="global-search-input" placeholder="Search for movies, series, genres...">
            <button class="search-clear-btn hidden" id="search-clear-btn" onclick="clearSearchInput()"><i class="fas fa-times-circle"></i></button>
        </div>
        <div class="search-content-wrapper">
            <div id="search-initial-state">
                <div class="search-suggestions-group" id="recent-searches-container">
                    <div class="suggestion-header">
                        <h3 class="suggestion-title"><i class="fas fa-history"></i> Recent Searches</h3>
                        <button class="clear-btn" onclick="clearAllRecentSearches()">Clear All</button>
                    </div>
                    <div id="recent-searches-list"></div>
                </div>
                <div class="search-suggestions-group" id="popular-categories-container">
                    <div class="suggestion-header">
                        <h3 class="suggestion-title"><i class="fas fa-tag"></i> Popular Categories</h3>
                    </div>
                    <div class="suggestion-tags-container" id="popular-categories-list"></div>
                </div>
            </div>
            <div class="search-results-container hidden" id="search-results-container"></div>
        </div>
    </div>

    <nav class="bottom-nav" id="bottom-nav">
        <button class="nav-item active" id="nav-home" onclick="navigateTo('home')"><i class="fas fa-home"></i> Home</button>
        <button class="nav-item" id="nav-series" onclick="navigateTo('series')"><i class="fas fa-tv"></i> Series</button>
        <button class="nav-item" id="nav-livetv" onclick="navigateTo('livetv')"><i class="fas fa-wifi"></i> TV</button>
        <button class="nav-item" id="nav-anime" onclick="navigateTo('anime')"><i class="fas fa-ghost"></i> Anime</button>
        <button class="nav-item" id="nav-watchlist" onclick="navigateTo('watchlist')"><i class="fas fa-bookmark"></i> Watchlist</button>
        <button class="nav-item" id="nav-profile" onclick="navigateTo('profile')"><i class="fas fa-user"></i> Profile</button>
    </nav>
    <div id="toast-notification" class="toast-notification"></div>

    <div class="modal-backdrop" id="modal-backdrop"></div>
    <div id="gender-choice-modal">
        <h3>Choose Your Identity</h3>
        <div class="gender-choices">
            <button class="gender-btn" data-gender="male"><i class="fas fa-mars"></i><span>Male</span></button>
            <button class="gender-btn" data-gender="female"><i class="fas fa-venus"></i><span>Female</span></button>
        </div>
    </div>
    <div id="avatar-change-modal">
        <h3 id="avatar-modal-title">Choose a New Avatar</h3>
        <div class="avatar-choices" id="modal-avatar-choices"></div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="hidden">
        <div class="payment-modal-content">
            <button class="payment-modal-close-btn" onclick="closePaymentModal()">&times;</button>
            <h3 id="payment-modal-title">Scan to Pay</h3>
            <img id="payment-qr-code-img" src="" alt="QR Code">
            <p style="color: var(--text-secondary); font-size: 14px; margin: 15px 0;">After paying, please fill the details below:</p>
            <form id="payment-details-form">
                <div class="input-group">
                    <input type="text" id="payment-name" class="auth-input" placeholder="Your Name" required>
                </div>
                <div class="input-group">
                    <input type="number" id="payment-age" class="auth-input" placeholder="Your Age" required>
                </div>
                <div class="input-group">
                    <input type="text" id="payment-screenshot-url" class="auth-input" placeholder="Payment Screenshot URL" required>
                </div>
                <div class="input-group">
                    <input type="text" id="payment-transaction-id" class="auth-input" placeholder="Transaction ID" required>
                </div>
                <div class="input-group">
                    <input type="number" id="payment-amount" class="auth-input" placeholder="Amount Paid" step="0.01" required>
                </div>
                <div class="input-group">
                    <select id="payment-method" class="auth-input" required>
                        <option value="" disabled selected>Payment Method</option>
                        <option value="UPI">UPI</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Wallet">Wallet</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button type="submit" class="auth-btn">Submit Details</button>
            </form>
        </div>
    </div>

    <!-- Trailer Modal -->
    <div id="trailer-modal">
        <div class="trailer-modal-content">
            <button class="trailer-modal-close-btn" onclick="closeTrailer()">&times;</button>
            <a id="trailer-link" href="#" target="_blank">Watch Trailer</a>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal">
        <div class="report-modal-content">
            <button class="report-modal-close-btn" onclick="closeReportModal()">&times;</button>
            <h3>Report Content</h3>
            <form id="report-form">
                <div class="input-group">
                    <input type="text" id="report-title" class="auth-input" placeholder="Content Title" readonly>
                </div>
                <div class="input-group">
                    <select id="report-reason" class="auth-input" required>
                        <option value="" disabled selected>Select a reason</option>
                        <option value="copyright">Copyright Infringement</option>
                        <option value="inappropriate">Inappropriate Content</option>
                        <option value="broken">Broken Link/Video</option>
                        <option value="other">Other Issue</option>
                    </select>
                </div>
                <div class="input-group">
                    <textarea id="report-description" class="auth-input" placeholder="Please describe the issue in detail..." required></textarea>
                </div>
                <button type="submit" class="auth-btn">Submit Report</button>
            </form>
        </div>
    </div>

</div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAdvmI8mRyxEdBlnE0vDF-IW1eTxvR8fzw",
  authDomain: "gt-store-774fe.firebaseapp.com",
  databaseURL: "https://gt-store-774fe-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "gt-store-774fe",
  storageBucket: "gt-store-774fe.firebasestorage.app",
  messagingSenderId: "237273289443",
  appId: "1:237273289443:web:eae46a81c1ab7519f86bd6",
  measurementId: "G-RK3P4FNCPG"
};
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    const maintenancePage = document.getElementById('maintenance-page');
    const loadingPage = document.getElementById('loading-page');
    const authContainer = document.getElementById('auth-container');
    const appWrapper = document.getElementById('app-wrapper');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const guestLoginBtn = document.getElementById('guest-login-btn');

    const ALL_PAGE_IDS = ['home-page', 'detail-page', 'series-detail-page', 'movie-player-page', 'series-player-page', 'livetv-player-page', 'search-page', 'profile-page', 'notification-page', 'movie-request-page', 'account-settings-page', 'privacy-page', 'help-page', 'history-page', 'report-bug-page', 'subscription-page', 'redeem-page', 'my-plan-page', 'verify-subscription-page', 'app-lock-page', 'upcoming-page', 'about-page', 'themes-page', 'livetv-page', 'rules-page', 'url-maker-page'];
    const contentCache = {};

    // Data Migration: MovieHunt -> Rangmanch
    (function migrateData() {
        const keys = ['theme', 'watchlist', 'recent_searches', 'last_notif_ts', 'dismissed_notifs', 'app_lock_enabled', 'app_lock_pin'];
        keys.forEach(k => {
            const oldK = 'moviehunt_' + k;
            const newK = 'rangmanch_' + k;
            if (localStorage.getItem(oldK) && !localStorage.getItem(newK)) {
                localStorage.setItem(newK, localStorage.getItem(oldK));
                localStorage.removeItem(oldK);
            }
        });
    })();

    const themes = {
        'classic-red': { name: 'Classic Red', color: '#e50914' },
        'ocean-blue': { name: 'Ocean Blue', color: '#007BFF' },
        'forest-green': { name: 'Forest Green', color: '#28a745' },
        'royal-purple': { name: 'Royal Purple', color: '#8A2BE2' },
        'sunset-orange': { name: 'Sunset Orange', color: '#FF8C00' },
        'cyber-pink': { name: 'Cyber Pink', color: '#FF00FF' },
        'neutral-white': { 
            name: 'Neutral White', 
            color: '#333333', 
            bg: '#f4f4f9', 
            cardBg: 'rgba(255, 255, 255, 0.9)', 
            text: '#1a1d24', 
            textSec: '#555', 
            glass: 'rgba(0, 0, 0, 0.05)', 
            glassBorder: 'rgba(0, 0, 0, 0.1)',
            bgImage: 'none'
        }
    };

    function applyTheme(themeData) {
        const color = themeData.color;
        const glowColor = color + '80';
        
        document.documentElement.style.setProperty('--primary-color', color);
        document.documentElement.style.setProperty('--primary-glow', glowColor);
        document.documentElement.style.setProperty('--plyr-color-main', color);

        // Apply extended properties or defaults
        document.documentElement.style.setProperty('--bg-color', themeData.bg || '#0b0b0b');
        document.documentElement.style.setProperty('--card-bg', themeData.cardBg || 'rgba(30, 30, 30, 0.6)');
        document.documentElement.style.setProperty('--text-primary', themeData.text || '#ffffff');
        document.documentElement.style.setProperty('--text-secondary', themeData.textSec || '#a0a0a0');
        document.documentElement.style.setProperty('--glass-bg', themeData.glass || 'rgba(255, 255, 255, 0.08)');
        document.documentElement.style.setProperty('--glass-border', themeData.glassBorder || 'rgba(255, 255, 255, 0.1)');
        
        if (themeData.bgImage) {
            document.documentElement.style.setProperty('--bg-image', themeData.bgImage);
        } else {
            // Default dark gradient
            document.documentElement.style.setProperty('--bg-image', 'radial-gradient(circle at 10% 20%, rgba(229, 9, 20, 0.15) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(40, 40, 40, 0.5) 0%, transparent 40%)');
        }
    }

    function loadAndApplyTheme() {
        const savedTheme = localStorage.getItem('rangmanch_theme') || 'classic-red';
        if (themes[savedTheme]) {
            applyTheme(themes[savedTheme]);
        }
    }
    loadAndApplyTheme();


    function renderThemesPage() {
        const container = document.getElementById('themes-grid-container');
        if (!container) return;
        container.innerHTML = '';

        const currentTheme = localStorage.getItem('rangmanch_theme') || 'classic-red';

        Object.keys(themes).forEach(key => {
            const theme = themes[key];
            const div = document.createElement('div');
            div.className = `theme-option ${key === currentTheme ? 'active' : ''}`;
            div.onclick = () => selectTheme(key);

            const preview = document.createElement('div');
            preview.className = 'theme-preview';
            preview.style.backgroundColor = theme.color;

            const name = document.createElement('span');
            name.className = 'theme-name';
            name.textContent = theme.name;

            div.appendChild(preview);
            div.appendChild(name);
            container.appendChild(div);
        });
    }

    function selectTheme(key) {
        if (themes[key]) {
            localStorage.setItem('rangmanch_theme', key);
            applyTheme(themes[key]);
            renderThemesPage(); // Re-render to update active state
            showToast(`Theme changed to ${themes[key].name}`);
        }
    }


    function hideAllPages() {
        ALL_PAGE_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = 'none';
                if (el.classList.contains('page-container')) {
                    el.classList.add('hidden');
                }
            }
        });
        document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
    }

    let maleAvatars = [], femaleAvatars = [];
    let allContent = [], currentContent = null, sliderInterval = null, currentSlide = 0;
    let countdownIntervals = [];
    let watchlist = JSON.parse(localStorage.getItem('rangmanch_watchlist')) || [];
    let recentSearches = JSON.parse(localStorage.getItem('rangmanch_recent_searches')) || [];
    let navigationHistory = ['home'];
    let allLiveTvChannels = [], allCategories = [];
    let allNotifications = [];
    let lastSeenNotifTimestamp = localStorage.getItem('rangmanch_last_notif_ts') || 0;
    let dismissedNotifications = JSON.parse(localStorage.getItem('rangmanch_dismissed_notifs')) || [];
    let joinTimeInterval = null;
    let liveTvPlayer = null;
    let hls = null;
    let moviePlayer = null;
    let seriesPlayer = null;
    let newUserSignupData = null;
    let autoplayTimeout = null;
    let moviePlayerSimilarContent = [];
    let currentUserSubscriptionStatus = 'none';
    let currentUserProfile = null;
    let planCountdownInterval = null;
    let currentPlanTitle = ''; // To hold the selected plan title

    const playerConfig = null;

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('global-search-input').addEventListener('input', performSearch);
        const livetvSearchEl = document.getElementById('livetv-search-input'); if (livetvSearchEl) livetvSearchEl.addEventListener('input', performLiveTvSearch);
        setupProfileAvatarChanger();
        setupSignupOnboardingModals();
        document.getElementById('payment-details-form').addEventListener('submit', handlePaymentSubmit);
        document.getElementById('report-form').addEventListener('submit', handleReportSubmit);
        const gl = document.getElementById('google-login-btn'); if (gl) gl.addEventListener('click', handleGoogleSignIn);
        const gs = document.getElementById('google-signup-btn'); if (gs) gs.addEventListener('click', handleGoogleSignIn);
        auth.getRedirectResult().then((result) => {
            if (result && result.user) { finalizeGoogleUser(result.user); }
        }).catch(error => { /* ignore */ });
    });

    database.ref('maintenance').on('value', snapshot => {
        const settings = snapshot.val();
        if (settings && settings.enabled) {
            document.getElementById('maintenance-message-text').textContent = settings.message || 'The app is currently down for maintenance. Please check back later.';
            maintenancePage.classList.remove('hidden');
            loadingPage.classList.add('hidden');
            authContainer.classList.add('hidden');
            appWrapper.classList.add('hidden');
        } else {
            maintenancePage.classList.add('hidden');
            initializeAppLockCheck();
        }
    });

    function initializeAppLockCheck() {
        const isLockEnabled = localStorage.getItem('rangmanch_app_lock_enabled') === 'true';
        const pin = localStorage.getItem('rangmanch_app_lock_pin');

        if (isLockEnabled && pin) {
            document.getElementById('pin-lock-overlay').classList.remove('hidden');
            setupPinLockScreen();
        } else {
            checkAuthState();
        }
    }

    let enteredPin = '';
    function setupPinLockScreen() {
        const displaySpans = document.querySelectorAll('#pin-lock-display span');
        const keypad = document.getElementById('pin-lock-keypad');
        const errorEl = document.getElementById('pin-lock-error');
        const displayContainer = document.getElementById('pin-lock-display');
        const correctPin = localStorage.getItem('rangmanch_app_lock_pin');

        keypad.onclick = e => {
            const button = e.target.closest('button');
            if (!button || button.classList.contains('keypad-blank')) return;

            errorEl.textContent = '';
            const key = button.textContent.trim();

            if (button.querySelector('.fa-delete-left')) {
                if (enteredPin.length > 0) {
                    enteredPin = enteredPin.slice(0, -1);
                }
            } else if (/\d/.test(key) && enteredPin.length < 4) {
                enteredPin += key;
            }

            displaySpans.forEach((span, index) => {
                span.classList.toggle('filled', index < enteredPin.length);
            });

            if (enteredPin.length === 4) {
                if (enteredPin === correctPin) {
                    document.getElementById('pin-lock-overlay').classList.add('hidden');
                    checkAuthState();
                } else {
                    errorEl.textContent = 'Incorrect PIN. Try again.';
                    displayContainer.classList.add('shake');
                    setTimeout(() => {
                        enteredPin = '';
                        displaySpans.forEach(span => span.classList.remove('filled'));
                        displayContainer.classList.remove('shake');
                    }, 800);
                }
            }
        };
    }

    function loadAvatarOptionsFromDB() {
        const fallbackMaleAvatars = [ "https://static.vecteezy.com/system/resources/previews/053/669/517/non_2x/a-cartoon-avatar-of-a-male-gamer-free-vector.jpg", "https://static.vecteezy.com/system/resources/previews/059/637/014/non_2x/young-man-with-dark-hair-wearing-a-hoodie-casual-character-portrait-png.png", "https://static.vecteezy.com/system/resources/previews/059/641/443/non_2x/digital-male-avatar-character-with-dark-hair-and-friendly-expression-for-online-platforms-png.png", "https://static.vecteezy.com/system/resources/previews/059/641/891/non_2x/young-man-with-glasses-illustration-on-transparent-background-for-online-profiles-and-branding-png.png", "https://static.vecteezy.com/system/resources/previews/059/639/027/non_2x/smiling-young-man-digital-portrait-with-stylish-hair-and-casual-shirt-for-personal-branding-png.png", "https://static.vecteezy.com/system/resources/previews/059/642/135/non_2x/stylish-young-man-illustration-with-short-dark-hair-and-engaging-expression-png.png" ];
        const fallbackFemaleAvatars = [ "https://static.vecteezy.com/system/resources/previews/048/053/063/non_2x/a-pastel-dream-stylized-avatar-with-purple-and-pink-hair-png.png", "https://static.vecteezy.com/system/resources/previews/059/640/706/non_2x/young-woman-portrait-in-casual-hoodie-with-long-dark-hair-and-friendly-expression-png.png" ];
        maleAvatars = [...fallbackMaleAvatars];
        femaleAvatars = [...fallbackFemaleAvatars];
        database.ref('app_settings/avatars').once('value').then(snapshot => {
            const avatars = snapshot.val();
            if (avatars) {
                const m = avatars.male ? Object.values(avatars.male) : null;
                const f = avatars.female ? Object.values(avatars.female) : null;
                maleAvatars = m && m.length ? m : maleAvatars;
                femaleAvatars = f && f.length ? f : femaleAvatars;
            }
        }).catch(error => {
            console.error("Could not load avatars from DB, using fallback:", error);
        });
    }

    function checkAuthState() {
        auth.onAuthStateChanged(user => {
            if (newUserSignupData) return;
            if (user) {
                database.ref('users/' + user.uid).on('value', snapshot => {
                    currentUserProfile = snapshot.val();
                    authContainer.classList.add('hidden');
                    appWrapper.classList.remove('hidden');
                    updateUserProfileUI(user);
                    handleGuestUI(user.isAnonymous);
                    if(!allContent.length) loadInitialContent();
                    loadNotifications(user);
                    loadAvatarOptionsFromDB();
                });
            } else {
                currentUserProfile = null;
                authContainer.classList.remove('hidden');
                appWrapper.classList.add('hidden');
                allContent = []; watchlist = []; allNotifications = [];
                if (joinTimeInterval) clearInterval(joinTimeInterval);
                if (planCountdownInterval) clearInterval(planCountdownInterval);
                hideLoadingScreen();
            }
        });
    }


    function handleGuestUI(isGuest) {
        const accountSettingsLink = document.getElementById('account-settings-link');
        const movieRequestLink = document.getElementById('movie-request-link');
        const changeAvatarBtn = document.getElementById('change-avatar-btn');
        const reportBugLink = document.getElementById('report-bug-link');
        const redeemCodeLink = document.getElementById('redeem-code-link');
        const urlMakerLink = document.getElementById('url-maker-link');

        const displayStyle = isGuest ? 'none' : 'flex';

        if (accountSettingsLink) accountSettingsLink.style.display = displayStyle;
        if (movieRequestLink) movieRequestLink.style.display = displayStyle;
        if (reportBugLink) reportBugLink.style.display = displayStyle;
        if (redeemCodeLink) redeemCodeLink.style.display = displayStyle;
        if (urlMakerLink) urlMakerLink.style.display = displayStyle;
        if (changeAvatarBtn) changeAvatarBtn.style.display = isGuest ? 'none' : 'flex';
    }

    function hideLoadingScreen() { loadingPage.classList.add('fade-out'); setTimeout(() => { loadingPage.style.display = 'none'; }, 500); }

    loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const errorEl = document.getElementById('login-error'); auth.signInWithEmailAndPassword(email, password).catch(error => { errorEl.textContent = error.message; errorEl.style.display = 'block'; }); });

    guestLoginBtn.addEventListener('click', () => {
        auth.signInAnonymously().catch(error => {
            console.error("Guest login failed:", error);
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = "Could not log in as guest. Please enable Anonymous Sign-in in your Firebase console.";
            errorEl.style.display = 'block';
        });
    });

    async function finalizeGoogleUser(user) {
        if (!user) return;
        const snap = await database.ref('users/' + user.uid).once('value');
        if (!snap.exists()) {
            await database.ref('users/' + user.uid).set({
                displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'User'),
                email: user.email || '',
                photoURL: user.photoURL || '',
                gender: null,
                subscriptionStatus: 'none',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        }
        showToast("Signed in with Google");
    }

    function googleAuthErrorMessage(error) {
        const c = error && error.code ? String(error.code) : '';
        if (c.includes('operation-not-allowed')) return 'Enable Google provider in Firebase Auth';
        if (c.includes('unauthorized-domain')) return 'Add this domain to Firebase authorized domains';
        if (c.includes('network-request-failed')) return 'Network error. Check connection';
        if (c.includes('invalid-api-key')) return 'Invalid Firebase API key';
        if (c.includes('popup-closed-by-user')) return 'Popup closed before completing sign-in';
        return 'Google sign-in failed: ' + (error && error.message ? error.message : 'Unknown error');
    }

    function handleGoogleSignIn() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        const ua = navigator.userAgent || '';
        const isFile = location.protocol === 'file:';
        const isIOS = /iPad|iPhone|iPod/.test(ua);
        const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
        const isInApp = /(FBAN|FBAV|Instagram|Line|Twitter|WhatsApp)/i.test(ua);
        if (isFile || isIOS || isSafari || isInApp) {
            showToast('Opening Google Sign-In...');
            auth.signInWithRedirect(provider).catch(err => {
                showToast(googleAuthErrorMessage(err));
            });
            return;
        }
        auth.signInWithPopup(provider).then((result) => {
            finalizeGoogleUser(result.user);
        }).catch(error => {
            const code = error && error.code ? String(error.code) : '';
            if (code.includes('popup-blocked') || code.includes('operation-not-supported') || code.includes('cancelled-popup-request')) {
                showToast('Opening Google Sign-In...');
                auth.signInWithRedirect(provider).catch(err => {
                    showToast(googleAuthErrorMessage(err));
                });
            } else {
                showToast(googleAuthErrorMessage(error));
            }
        });
    }

    signupForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const errorEl = document.getElementById('signup-error');

        auth.createUserWithEmailAndPassword(email, password).then(userCredential => {
            const user = userCredential.user;
            startSignupOnboarding(user, name, email);
        }).catch(error => {
            errorEl.textContent = error.message;
            errorEl.style.display = 'block';
        });
    });

    function startSignupOnboarding(user, name, email) {
        newUserSignupData = { user, name, email };
        loadAvatarOptionsFromDB();
        authContainer.classList.add('hidden');
        document.getElementById('modal-backdrop').classList.add('show');
        document.getElementById('gender-choice-modal').classList.add('show');
    }

    function setupSignupOnboardingModals() {
        document.querySelectorAll('#gender-choice-modal .gender-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (!newUserSignupData) return;

                const gender = e.currentTarget.dataset.gender;
                newUserSignupData.gender = gender;

                const genderModal = document.getElementById('gender-choice-modal');
                const avatarModal = document.getElementById('avatar-change-modal');
                const avatarArray = gender === 'male' ? maleAvatars : femaleAvatars;

                document.getElementById('avatar-modal-title').textContent = `Choose a ${gender.charAt(0).toUpperCase() + gender.slice(1)} Avatar`;
                populateAvatarChoices('modal-avatar-choices', avatarArray);

                genderModal.classList.remove('show');
                avatarModal.classList.add('show');
            });
        });

        document.getElementById('modal-avatar-choices').addEventListener('click', (e) => {
            if (!newUserSignupData) return;

            const choice = e.target.closest('.avatar-choice');
            if (!choice) return;

            const avatarUrl = choice.dataset.avatar;
            const { user, name, email, gender } = newUserSignupData;

            user.updateProfile({
                displayName: name,
                photoURL: avatarUrl
            }).then(() => {
                return database.ref('users/' + user.uid).set({
                    displayName: name,
                    email: email,
                    photoURL: avatarUrl,
                    gender: gender,
                    subscriptionStatus: 'none',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
            }).then(() => {
                newUserSignupData = null;
                document.getElementById('avatar-change-modal').classList.remove('show');
                document.getElementById('modal-backdrop').classList.remove('show');
                checkAuthState();
            }).catch(error => {
                showToast("Error creating profile: " + error.message);
                console.error("Signup finalization error:", error);
                newUserSignupData = null;
                auth.signOut();
            });
        });
    }

    function handleLogout() { if(joinTimeInterval) clearInterval(joinTimeInterval); if(planCountdownInterval) clearInterval(planCountdownInterval); auth.signOut(); }
    function toggleAuthForms() { document.getElementById('login-page-pro').classList.toggle('hidden'); document.getElementById('signup-page-pro').classList.toggle('hidden'); document.getElementById('login-error').style.display = 'none'; document.getElementById('signup-error').style.display = 'none'; }
    function togglePasswordVisibility(inputId, icon) { const input = document.getElementById(inputId); if (input.type === "password") { input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } else { input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); } }

    function updateUserProfileUI(user) {
        if (!user) return;

        if (user.isAnonymous) {
            document.getElementById('profile-user-name').textContent = 'Guest User';
            document.getElementById('profile-user-email').textContent = 'Sign up for a full experience!';
            document.getElementById('profile-avatar-container').innerHTML = `<img src="https://i.ibb.co/FkdVCKQb/1001809860.jpg" alt="Guest Avatar" loading="lazy">`;
            document.getElementById('joining-date-stat').textContent = 'Just now';
            if (joinTimeInterval) clearInterval(joinTimeInterval);
            currentUserSubscriptionStatus = 'none';
            return;
        }

        const userName = (currentUserProfile && currentUserProfile.displayName) || user.displayName || user.email.split('@')[0];
        const userEmail = user.email;
        const userAvatar = (currentUserProfile && currentUserProfile.photoURL) || user.photoURL || "https://static.vecteezy.com/system/resources/previews/002/387/693/large_2x/user-profile-icon-free-vector.jpg";
        document.getElementById('profile-user-name').textContent = userName;
        document.getElementById('profile-user-email').textContent = userEmail;
        const avatarContainer = document.getElementById('profile-avatar-container');
        avatarContainer.innerHTML = `<img src="${userAvatar}" alt="Profile Avatar" loading="lazy">`;

        currentUserSubscriptionStatus = (currentUserProfile && currentUserProfile.subscriptionStatus) ? currentUserProfile.subscriptionStatus : 'none';

        if (joinTimeInterval) clearInterval(joinTimeInterval);
        const creationTime = new Date(user.metadata.creationTime).getTime();
        const statElement = document.getElementById('joining-date-stat');

        function updateJoinTime() {
            const now = Date.now();
            const msPerDay = 1000 * 60 * 60 * 24;
            const elapsed = now - creationTime;
            const days = Math.floor(elapsed / msPerDay);

            if (days > 1) {
                statElement.textContent = `${days} days`;
            } else if (days === 1) {
                 statElement.textContent = `1 day`;
            } else {
                statElement.textContent = `Today`;
            }
        }
        updateJoinTime();
        joinTimeInterval = setInterval(updateJoinTime, 60000);
    }

    function populateAvatarChoices(containerId, avatarArray, selectedUrl = null) {
        const container = document.getElementById(containerId);
        if(!container) return;
        if (!avatarArray || avatarArray.length === 0) {
            container.innerHTML = `<p style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1;">No avatars available for this gender.</p>`;
            return;
        }
        container.innerHTML = avatarArray.map(url =>
            `<div class="avatar-choice ${url === selectedUrl ? 'selected' : ''}" data-avatar="${url}"><img src="${url}" alt="Avatar" loading="lazy"></div>`
        ).join('');
    }

    function setupProfileAvatarChanger() {
        const changeBtn = document.getElementById('change-avatar-btn');
        const genderModal = document.getElementById('gender-choice-modal');
        const avatarModal = document.getElementById('avatar-change-modal');
        const backdrop = document.getElementById('modal-backdrop');
        const choicesContainer = document.getElementById('modal-avatar-choices');

        const openGenderModal = () => { backdrop.classList.add('show'); genderModal.classList.add('show'); };
        const closeAllModals = () => { genderModal.classList.remove('show'); avatarModal.classList.remove('show'); backdrop.classList.remove('show'); };
        const showAvatarChoicesForGender = (gender) => {
            const user = auth.currentUser;
            if (!user) return;
            const avatarArray = gender === 'male' ? maleAvatars : femaleAvatars;
            document.getElementById('avatar-modal-title').textContent = `Choose a ${gender.charAt(0).toUpperCase() + gender.slice(1)} Avatar`;
            populateAvatarChoices('modal-avatar-choices', avatarArray, user.photoURL);
            genderModal.classList.remove('show');
            avatarModal.classList.add('show');
        };

        changeBtn.addEventListener('click', () => {
            if (newUserSignupData) return;
            const user = auth.currentUser;
            if (!user || user.isAnonymous) return;
            database.ref('users/' + user.uid + '/gender').once('value').then(snapshot => {
                const gender = snapshot.val();
                if (gender) { backdrop.classList.add('show'); showAvatarChoicesForGender(gender); }
                else { openGenderModal(); }
            });
        });

        backdrop.addEventListener('click', closeAllModals);

        document.querySelectorAll('#gender-choice-modal .gender-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (newUserSignupData) return;
                const gender = e.currentTarget.dataset.gender;
                const user = auth.currentUser;
                if(user) { database.ref('users/' + user.uid).update({ gender: gender }); }
                showAvatarChoicesForGender(gender);
            });
        });

        choicesContainer.addEventListener('click', (e) => {
            if (newUserSignupData) return;
            const choice = e.target.closest('.avatar-choice');
            if (!choice) return;
            const newAvatarUrl = choice.dataset.avatar;
            const user = auth.currentUser;
            if (!user || user.photoURL === newAvatarUrl) { closeAllModals(); return; };
            user.updateProfile({ photoURL: newAvatarUrl }).then(() => {
                database.ref('users/' + user.uid).update({ photoURL: newAvatarUrl }).then(() => {
                    showToast("Avatar updated!");
                    updateUserProfileUI(user);
                    closeAllModals();
                });
            }).catch(error => {
                showToast("Error updating avatar: " + error.message);
                closeAllModals();
            });
        });
    }

    function showToast(message) { const toast = document.getElementById('toast-notification'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

    function loadNotifications(currentUser) {
        if (!currentUser) return;
        database.ref('notifications').orderByChild('timestamp').on('value', snapshot => {
            const userNotifications = [];
            snapshot.forEach(childSnapshot => {
                const notif = { id: childSnapshot.key, ...childSnapshot.val() };
                if (dismissedNotifications.includes(notif.id)) {
                    return;
                }
                if (notif.target === 'all' || notif.target === currentUser.uid) {
                    userNotifications.push(notif);
                }
            });
            allNotifications = userNotifications.reverse();
            checkUnreadNotifications();
            if(document.getElementById('notification-page').style.display === 'block') {
                renderNotificationsPage();
            }
        });
    }

    function checkUnreadNotifications() { const indicator = document.getElementById('unread-indicator'); if (allNotifications.length > 0 && allNotifications[0].timestamp > lastSeenNotifTimestamp) { indicator.classList.remove('hidden'); } else { indicator.classList.add('hidden'); } }

    function renderNotificationsPage() {
        const container = document.getElementById('notification-list-container');
        container.innerHTML = '';
        if (allNotifications.length === 0) {
            container.innerHTML = `<div class="empty-state" style="min-height: calc(100vh - 200px); display: flex; flex-direction: column; justify-content: center;"><i class="fas fa-bell-slash empty-icon"></i><p>No Notifications Yet</p><span>New updates will appear here.</span></div>`;
            return;
        }
        allNotifications.forEach((notif, index) => {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'notification-card-wrapper list-item-animate';
            cardWrapper.style.animationDelay = `${index * 0.05}s`;
            cardWrapper.innerHTML = createNotificationCardHTML(notif);
            container.appendChild(cardWrapper);
            const cardElement = cardWrapper.querySelector('.notification-card');
            addSwipeListeners(cardElement);
        });
        if (allNotifications.length > 0) {
            lastSeenNotifTimestamp = allNotifications[0].timestamp;
            localStorage.setItem('rangmanch_last_notif_ts', lastSeenNotifTimestamp);
            checkUnreadNotifications();
        }
    }

    function createNotificationCardHTML(notif) { const timeAgo = formatTimeAgo(notif.timestamp); const isUnread = notif.timestamp > lastSeenNotifTimestamp; let imageHTML = notif.moviePoster ? `<img src="${notif.moviePoster}" alt="Movie Poster" loading="lazy">` : `<i class="fas ${notif.icon || 'fa-bell'} icon"></i>`; let footerHTML = notif.movieId ? `<button class="watch-now-btn" onclick="event.stopPropagation(); handleNotificationClick('${notif.id}', '${notif.movieId}')">Watch Now</button>` : '<div></div>'; return ` <div class="notification-card-actions"><button class="delete-btn" onclick="dismissNotification(this, '${notif.id}')"><i class="fas fa-trash-alt"></i></button></div> <div class="notification-card" data-id="${notif.id}" onclick="handleNotificationClick('${notif.id}', '${notif.movieId || ''}')"> <div class="notif-card-image">${imageHTML}</div> <div class="notif-card-content"> <div class="notif-card-header"> <h3>${notif.title}</h3> ${isUnread ? '<div class="unread-dot-card"></div>' : ''} </div> <p class="notif-card-message">${notif.message}</p> <div class="notif-card-footer"> <span class="time">${timeAgo}</span> ${footerHTML} </div> </div> </div>`; }
    function handleNotificationClick(notifId, movieId) { if (!movieId) return; const movie = allContent.find(m => m.id === movieId); if (movie) { (seriesTypes.includes(movie.type)) ? showSeriesDetail(movie) : showDetail(movie); } else { showToast("Sorry, this content could not be found."); } }
    function dismissNotification(btn, notifId) { const wrapper = btn.closest('.notification-card-wrapper'); if (!wrapper) return; if (!dismissedNotifications.includes(notifId)) { dismissedNotifications.push(notifId); localStorage.setItem('rangmanch_dismissed_notifs', JSON.stringify(dismissedNotifications)); } wrapper.style.transition = 'transform 0.3s ease, opacity 0.3s ease'; wrapper.style.transform = 'scale(0.9)'; wrapper.style.opacity = '0'; setTimeout(() => { wrapper.remove(); allNotifications = allNotifications.filter(n => n.id !== notifId); if (allNotifications.length === 0) { renderNotificationsPage(); } }, 300); }
    function addSwipeListeners(card) { let startX, currentX, diffX = 0; const SWIPE_THRESHOLD = -80; card.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; card.style.transition = 'none'; }, { passive: true }); card.addEventListener('touchmove', (e) => { currentX = e.touches[0].clientX; diffX = currentX - startX; if (diffX < 0) { card.style.transform = `translateX(${diffX}px)`; } }, { passive: true }); card.addEventListener('touchend', () => { card.style.transition = 'transform 0.3s ease'; if (diffX < SWIPE_THRESHOLD) { card.style.transform = 'translateX(-100%)'; const dismissBtn = card.parentElement.querySelector('.delete-btn'); setTimeout(() => { if (dismissBtn) dismissBtn.click(); }, 100); } else { card.style.transform = 'translateX(0)'; } diffX = 0; }); }

    function saveComment(event, contentId, inputElementId) {
        event.preventDefault();
        const user = auth.currentUser;
        if (!user || user.isAnonymous) {
            showToast("You must be logged in to comment.");
            return;
        }

        const commentInput = document.getElementById(inputElementId);
        const text = commentInput.value.trim();

        if (!text) {
            showToast("Comment cannot be empty.");
            return;
        }

        const commentData = {
            uid: user.uid,
            userName: currentUserProfile.displayName || 'User',
            userAvatar: currentUserProfile.photoURL || user.photoURL,
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        database.ref('comments/' + contentId).push(commentData)
            .then(() => {
                commentInput.value = '';
                showToast("Comment posted!");
            })
            .catch(error => {
                showToast("Error posting comment: " + error.message);
            });
    }

    function loadComments(contentId, listElementId) {
        const commentsList = document.getElementById(listElementId);
        if (!commentsList) return;

        const commentsRef = database.ref('comments/' + contentId).orderByChild('timestamp');
        commentsRef.on('value', snapshot => {
            commentsList.innerHTML = '';
            if (!snapshot.exists()) {
                commentsList.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">Be the first to comment.</p>`;
                return;
            }

            const comments = [];
            snapshot.forEach(childSnapshot => {
                comments.push({ id: childSnapshot.key, ...childSnapshot.val() });
            });

            comments.reverse().forEach((comment, index) => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item list-item-animate';
                commentItem.style.animationDelay = `${index * 0.05}s`;

                const user = auth.currentUser;
                let deleteBtnHtml = '';
                if (user && user.uid === comment.uid) {
                    deleteBtnHtml = `<div class="comment-actions"><button class="comment-delete-btn" onclick="deleteComment('${contentId}', '${comment.id}')"><i class="fas fa-trash"></i></button></div>`;
                }

                commentItem.innerHTML = `
                    <div class="comment-avatar">
                        <img src="${comment.userAvatar || 'https://i.ibb.co/yBNK21P/avatar1.jpg'}" alt="User Avatar" loading="lazy">
                    </div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-user-name">${comment.userName}</span>
                            <span class="comment-timestamp">${formatTimeAgo(comment.timestamp)}</span>
                            ${deleteBtnHtml}
                        </div>
                        <p class="comment-text">${comment.text}</p>
                    </div>
                `;
                commentsList.appendChild(commentItem);
            });
        });
    }

    function deleteComment(contentId, commentId) {
        if (confirm("Are you sure you want to delete this comment?")) {
            database.ref(`comments/${contentId}/${commentId}`).remove()
                .then(() => showToast("Comment deleted."))
                .catch(error => showToast("Error deleting comment: " + error.message));
        }
    }

    function formatTimeAgo(timestamp) { if (!timestamp) return 'Just now'; const now = new Date(); const seconds = Math.floor((now - timestamp) / 1000); let interval = seconds / 31536000; if (interval > 1) return new Date(timestamp).toLocaleDateString(); interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago"; return Math.floor(seconds) < 5 ? 'Just now' : Math.floor(seconds) + " seconds ago"; }

    async function loadContent(type) {
        if (contentCache[type]) return contentCache[type];

        const snapshot = await database.ref(type).once('value');
        if (!snapshot.exists()) return [];

        const contentData = snapshot.val();
        const typeName = type === 'webseries' ? 'webseries' : (type === 'anime' ? 'anime' : (type === 'anime_movies' ? 'anime_movie' : 'movie'));

        const contentArray = Object.keys(contentData).map(key => ({
            id: key, ...contentData[key], type: typeName
        }));

        contentCache[type] = contentArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        return contentCache[type];
    }

    async function loadLiveTvChannels() {
        if (allLiveTvChannels.length > 0) return;
        try {
            const snapshot = await database.ref('livetv').once('value');
            if (!snapshot.exists()) {
                console.log("No live TV channels found in the database.");
                allLiveTvChannels = [];
                return;
            }
            const channelsData = snapshot.val();
            allLiveTvChannels = Object.keys(channelsData).map(key => ({
                id: key,
                ...channelsData[key]
            })).sort((a, b) => a.name.localeCompare(b.name));
        } catch (error) {
            console.error("Error loading live TV channels:", error);
            allLiveTvChannels = [];
        }
    }

    async function loadInitialContent() {
        const [movies, webseries, anime, animeMovies, _] = await Promise.all([
            loadContent('movies'),
            loadContent('webseries'),
            loadContent('anime'),
            loadContent('anime_movies'),
            loadLiveTvChannels()
        ]);
        allContent = [...movies, ...webseries, ...anime, ...animeMovies];

        const categories = [...new Set(allContent.map(item => item.category).filter(cat => cat))];
        allCategories = [...new Set([...allCategories, ...categories])].sort();

        const currentNav = navigationHistory[navigationHistory.length - 1] || 'home';
        navigateTo(currentNav, true);
        hideLoadingScreen();
    }

    function clearAllMainContent() {
        document.getElementById('home-content').innerHTML = '';
        document.getElementById('series-content').innerHTML = '';
        document.getElementById('anime-content').innerHTML = '';
        document.getElementById('watchlist-content').innerHTML = '';
        document.getElementById('category-grid-content').innerHTML = '';
    }

    function navigateTo(pageInfo, isFromHistory = false) {
        if (planCountdownInterval) clearInterval(planCountdownInterval);
    
        // --- PREMIUM CHECK FOR ALL PREMIUM CONTENT ---
        if (typeof pageInfo === 'object' && pageInfo.page === 'detail' && pageInfo.id) {
            const item = allContent.find(c => c.id === pageInfo.id);
            if (item && item.tier === 'premium') {
                const user = auth.currentUser;
                if (!user || user.isAnonymous) {
                    showToast("Please sign in to access premium content.");
                    return;
                }
                if (!currentUserProfile || currentUserProfile.subscriptionStatus === 'none' || !currentUserProfile.subscriptionExpiry || currentUserProfile.subscriptionExpiry <= Date.now()) {
                    showToast("A premium subscription is required to access this content.");
                    navigateTo('subscription');
                    return;
                }
            }
        }

        if (pageInfo === 'livetv' || (typeof pageInfo === 'object' && pageInfo.page === 'livetv')) {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                showToast("Please sign in to access Live TV.");
                return;
            }
            if (!currentUserProfile || currentUserProfile.subscriptionStatus === 'none' || !currentUserProfile.subscriptionExpiry || currentUserProfile.subscriptionExpiry <= Date.now()) {
                showToast("A premium subscription is required to access Live TV.");
                navigateTo('subscription');
                return;
            }
        }
        // --- END PREMIUM CHECK ---

        const page = (typeof pageInfo === 'object') ? pageInfo.page : pageInfo;
        const currentPageInfo = navigationHistory[navigationHistory.length - 1];
        if (!isFromHistory) {
             const isSamePage = (typeof currentPageInfo === 'object')
                ? (currentPageInfo.page === page && currentPageInfo.category === pageInfo.category)
                : currentPageInfo === page;
            if (!isSamePage) {
                if (navigationHistory.length > 10) navigationHistory.shift();
                navigationHistory.push(pageInfo);
            }
        }

        hideAllPages();
        clearAllCountdowns();

        document.getElementById('back-btn').style.display = 'none';
        document.getElementById('bottom-nav').style.display = 'flex';
        document.body.style.overflowY = 'auto'; // Default state
        if (sliderInterval) clearInterval(sliderInterval);

        const pageHeader = document.getElementById('page-header');
        pageHeader.classList.add('hidden');
        pageHeader.classList.remove('centered-header');
        pageHeader.querySelector('i').style.display = 'inline-block';
        pageHeader.querySelector('.brand-badge').style.display = '';
        document.getElementById('home-header').style.display = 'none';
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        const activeNavItem = document.getElementById(`nav-${page}`);
        if (activeNavItem) activeNavItem.classList.add('active');

        const mainPagesWithNoBackBtn = ['home', 'series', 'anime', 'watchlist', 'profile', 'livetv'];
        if (!mainPagesWithNoBackBtn.includes(page)) {
            document.getElementById('back-btn').style.display = 'block';
            document.getElementById('bottom-nav').style.display = 'none';
        }

        switch (page) {
            case 'home':
                document.getElementById('home-page').style.display = 'block';
                document.getElementById('home-header').style.display = 'flex';
                document.getElementById('home-content').classList.remove('hidden');
                document.getElementById('home-content').className = 'page-content';
                renderHomePage();
                break;
            case 'series':
                document.getElementById('home-page').style.display = 'block';
                document.getElementById('series-content').classList.remove('hidden');
                renderSeriesPage();
                break;
            case 'anime':
                document.getElementById('home-page').style.display = 'block';
                document.getElementById('anime-content').classList.remove('hidden');
                renderAnimePage();
                break;
            case 'watchlist':
                document.getElementById('home-page').style.display = 'block';
                document.getElementById('watchlist-content').classList.remove('hidden');
                renderWatchlistPage();
                break;
            case 'profile': document.getElementById('profile-page').classList.remove('hidden'); document.getElementById('profile-page').style.display = 'block'; break;
            case 'livetv': document.getElementById('livetv-page').classList.remove('hidden'); document.getElementById('livetv-page').style.display = 'flex'; renderLiveTvPage(); break;
            case 'notifications': document.getElementById('notification-page').classList.remove('hidden'); document.getElementById('notification-page').style.display = 'block'; document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active')); renderNotificationsPage(); break;
            case 'movieRequest': document.getElementById('movie-request-page').classList.remove('hidden'); document.getElementById('movie-request-page').style.display = 'block'; renderMovieRequestPage(); break;
            case 'reportBug': document.getElementById('report-bug-page').classList.remove('hidden'); document.getElementById('report-bug-page').style.display = 'block'; renderReportBugPage(); break;
            case 'subscription': document.getElementById('subscription-page').classList.remove('hidden'); document.getElementById('subscription-page').style.display = 'block'; renderSubscriptionPage(); break;
            case 'redeem': document.getElementById('redeem-page').classList.remove('hidden'); document.getElementById('redeem-page').style.display = 'block'; renderRedeemPage(); break;
            case 'myPlan': document.getElementById('my-plan-page').classList.remove('hidden'); document.getElementById('my-plan-page').style.display = 'block'; renderMyPlanPage(); break;
            case 'verifySubscription': document.getElementById('verify-subscription-page').classList.remove('hidden'); document.getElementById('verify-subscription-page').style.display = 'block'; renderVerifySubscriptionPage(); break;
            case 'accountSettings': document.getElementById('account-settings-page').classList.remove('hidden'); document.getElementById('account-settings-page').style.display = 'block'; renderAccountSettingsPage(); break;
            case 'appLock': document.getElementById('app-lock-page').classList.remove('hidden'); document.getElementById('app-lock-page').style.display = 'block'; renderAppLockPage(); break;
            case 'themes': document.getElementById('themes-page').classList.remove('hidden'); document.getElementById('themes-page').style.display = 'block'; renderThemesPage(); break;
            case 'urlMaker': document.getElementById('url-maker-page').classList.remove('hidden'); document.getElementById('url-maker-page').style.display = 'block'; break;
            case 'upcoming': document.getElementById('upcoming-page').classList.remove('hidden'); document.getElementById('upcoming-page').style.display = 'block'; renderUpcomingPage(); break;
            case 'privacy': document.getElementById('privacy-page').classList.remove('hidden'); document.getElementById('privacy-page').style.display = 'block'; break;
            case 'about': document.getElementById('about-page').classList.remove('hidden'); document.getElementById('about-page').style.display = 'block'; break;
            case 'rules': document.getElementById('rules-page').classList.remove('hidden'); document.getElementById('rules-page').style.display = 'block'; break;
            case 'help': document.getElementById('help-page').classList.remove('hidden'); document.getElementById('help-page').style.display = 'block'; break;
            case 'history': document.getElementById('history-page').classList.remove('hidden'); document.getElementById('history-page').style.display = 'block'; renderHistoryPage(); break;
        }
        if (page !== 'search') window.scrollTo(0, 0);
    }

    window.addEventListener('scroll', () => { const header = document.getElementById('home-header'); if(header) { if (window.scrollY > 10) { header.classList.add('scrolled'); } else { header.classList.remove('scrolled'); } } });

    function renderMovieRequestPage() {
        const form = document.getElementById('movie-request-form');
        if (!form) return;
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = false; submitButton.textContent = 'Submit Request';
        form.reset();

        form.onsubmit = (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user || user.isAnonymous) { showToast("You must be signed in to request a movie."); return; }
            const movieName = document.getElementById('request-movie-name').value.trim();
            const movieYear = document.getElementById('request-movie-year').value.trim();
            if (!movieName || !movieYear) { showToast("Please fill out all fields."); return; }
            submitButton.disabled = true; submitButton.textContent = 'Submitting...';
            const requestData = { movieName, movieYear, requestedBy: user.email, uid: user.uid, timestamp: firebase.database.ServerValue.TIMESTAMP };
            database.ref('movie_requests').push(requestData)
                .then(() => { showToast("Request submitted successfully!"); goBack(); })
                .catch(error => { showToast("Error: " + error.message); submitButton.disabled = false; submitButton.textContent = 'Submit Request';});
        };
    }

    function renderReportBugPage() {
        const form = document.getElementById('report-bug-form');
        if (!form) return;
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = false; submitButton.textContent = 'Submit Report';
        form.reset();

        form.onsubmit = (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user || user.isAnonymous) { showToast("You must be signed in to report a bug."); return; }
            const description = document.getElementById('report-bug-description').value.trim();
            if (!description) { showToast("Please describe the issue."); return; }

            submitButton.disabled = true; submitButton.textContent = 'Submitting...';
            const reportData = { description, reportedBy: user.email, uid: user.uid, timestamp: firebase.database.ServerValue.TIMESTAMP };
            database.ref('bug_reports').push(reportData)
                .then(() => { showToast("Bug report sent. Thank you!"); goBack(); })
                .catch(error => { showToast("Error: " + error.message); submitButton.disabled = false; submitButton.textContent = 'Submit Report'; });
        };
    }

    function renderSubscriptionPage() {
        const container = document.getElementById('subscription-plan-container');
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading plans...</p>';
        database.ref('subscription_plans').once('value').then(snapshot => {
            if (!snapshot.exists()) {
                container.innerHTML = `<div class="empty-state" style="min-height: calc(100vh - 300px); display:flex; flex-direction:column; justify-content:center;"><i class="fas fa-box-open empty-icon"></i><p>No Subscription Plans Available</p><span>Please check back later.</span></div>`;
                return;
            }
            
            container.innerHTML = '';
            let plans = [];
            snapshot.forEach(child => { plans.push({ id: child.key, ...child.val() }); });

            plans.sort((a,b) => a.timestamp - b.timestamp).forEach((plan, index) => {
                const planCard = document.createElement('div');
                planCard.className = 'subscription-plan-card';
                if (index === 1) { // Example: highlight the second plan
                    planCard.classList.add('highlighted');
                }
                const descText = plan.description || '';
                const descriptionHtml = `<ul>${descText.split('\n').filter(line => line.trim()).map(line => `<li><i class="fas fa-check"></i> ${line}</li>`).join('')}</ul>`;
                const rateText = `${plan.price} <span>/${plan.duration_days} days</span>`;
                const qrUrl = plan.qrImageUrl ? plan.qrImageUrl : 'qrImageUrl.jpeg';

                planCard.innerHTML = `
                    <div class="plan-header">
                        <h2 class="plan-title">${plan.name}</h2>
                        <p class="plan-rate">${rateText}</p>
                    </div>
                    <div class="plan-description">${descriptionHtml}</div>
                    <button class="choose-plan-btn" onclick="showPaymentModal('${qrUrl}', '${plan.name}')">Choose Plan</button>
                `;
                container.appendChild(planCard);
            });
        }).catch(error => {
            container.innerHTML = `<div class="empty-state"><p>Could not load plans.</p></div>`;
            console.error("Error loading subscription plans: ", error);
        });
    }

    function renderVerifySubscriptionPage() {
        const select = document.getElementById('verify-plan-select');
        const btn = document.getElementById('open-verification-btn');
        if (!select || !btn) return;
        select.innerHTML = `<option value="" disabled selected>Select Plan</option>`;
        database.ref('subscription_plans').once('value').then(snapshot => {
            if (!snapshot.exists()) {
                select.innerHTML = `<option value="" disabled>No plans available</option>`;
                return;
            }
            const options = [];
            snapshot.forEach(child => {
                const id = child.key;
                const p = child.val();
                options.push(`<option value="${id}">${p.name}</option>`);
            });
            select.innerHTML = `<option value="" disabled selected>Select Plan</option>` + options.join('');
        });
        btn.onclick = async () => {
            const planId = select.value;
            if (!planId) { showToast("Please select a plan."); return; }
            const snap = await database.ref(`subscription_plans/${planId}`).once('value');
            if (!snap.exists()) { showToast("Plan not found."); return; }
            const p = snap.val();
            const name = p && p.name ? p.name : 'Plan';
            const qr = p && p.qrImageUrl ? p.qrImageUrl : 'qrImageUrl.jpeg';
            showPaymentModal(qr, name);
        };
    }

    function showPaymentModal(qrImageUrl, planTitle) {
        if (!auth.currentUser || auth.currentUser.isAnonymous) {
            showToast("Please sign in to subscribe.");
            return;
        }
        currentPlanTitle = planTitle;
        const modal = document.getElementById('payment-modal');
        document.getElementById('payment-modal-title').textContent = `Pay for ${planTitle} Plan`;
        const qrImgEl = document.getElementById('payment-qr-code-img');
        if (qrImageUrl) {
            qrImgEl.src = qrImageUrl;
            qrImgEl.style.display = '';
        } else {
            qrImgEl.src = '';
            qrImgEl.style.display = 'none';
        }
        
        modal.classList.remove('hidden');
        // Use a tiny timeout to allow the display property to change before starting the transition
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
    }

    function closePaymentModal() {
        const modal = document.getElementById('payment-modal');
        modal.classList.remove('show');
        // Wait for the animation to finish before hiding it completely
        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('payment-details-form').reset();
        }, 300);
    }

    function handlePaymentSubmit(event) {
        event.preventDefault();
        const user = auth.currentUser;
        if (!user) {
            showToast("You must be logged in.");
            return;
        }

        const name = document.getElementById('payment-name').value.trim();
        const age = document.getElementById('payment-age').value.trim();
        const screenshotUrl = document.getElementById('payment-screenshot-url').value.trim();
        const transactionId = document.getElementById('payment-transaction-id').value.trim();
        const amountStr = document.getElementById('payment-amount').value.trim();
        const method = document.getElementById('payment-method').value;

        if (!name || !age || !screenshotUrl || !transactionId || !amountStr || !method) {
            showToast("Please fill out all fields.");
            return;
        }
        const amount = parseFloat(amountStr);
        if (Number.isNaN(amount) || amount <= 0) {
            showToast("Please enter a valid amount.");
            return;
        }

        const paymentData = {
            uid: user.uid,
            email: user.email,
            name: name,
            age: age,
            screenshotUrl: screenshotUrl,
            plan: currentPlanTitle,
            transactionId: transactionId,
            method: method,
            amount: amount,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            status: 'pending' // For admin review
        };

        database.ref('payments').push(paymentData)
            .then(() => {
                showToast("Details submitted for verification!");
                closePaymentModal();
            })
            .catch(error => {
                showToast("Error submitting details: " + error.message);
            });
    }

    function renderRedeemPage() {
        const form = document.getElementById('redeem-code-form');
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = false;
        submitButton.textContent = 'Redeem';
        form.reset();

        form.onsubmit = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const codeInput = document.getElementById('redeem-code-input');
            const code = codeInput.value.trim().toUpperCase();
            if (!code) {
                showToast("Please enter a code.");
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Verifying...';

            const codeRef = database.ref('redeem_codes').child(code);
            try {
                const snapshot = await codeRef.once('value');
                if (snapshot.exists() && snapshot.val().active === true) {
                    const planDurationDays = snapshot.val().duration_days || 30;
                    const expiryTimestamp = Date.now() + (planDurationDays * 24 * 60 * 60 * 1000);

                    const updates = {};
                    updates[`/users/${user.uid}/subscriptionStatus`] = snapshot.val().plan || 'premium';
                    updates[`/users/${user.uid}/subscriptionExpiry`] = expiryTimestamp;
                    updates[`/redeem_codes/${code}/active`] = false;
                    updates[`/redeem_codes/${code}/redeemedBy`] = user.email;
                    updates[`/redeem_codes/${code}/redeemedAt`] = firebase.database.ServerValue.TIMESTAMP;

                    await database.ref().update(updates);
                    showToast("Code redeemed successfully! Your plan is now active.");
                    goBack();
                } else {
                    showToast("Invalid or already used code.");
                    submitButton.disabled = false;
                    submitButton.textContent = 'Redeem';
                }
            } catch (error) {
                showToast("Error redeeming code. Please try again.");
                console.error("Redeem error: ", error);
                submitButton.disabled = false;
                submitButton.textContent = 'Redeem';
            }
        };
    }

    function renderMyPlanPage() {
        const container = document.getElementById('my-plan-details-container');
        if (planCountdownInterval) clearInterval(planCountdownInterval);
        const user = auth.currentUser;
        if (!user || user.isAnonymous) {
            container.innerHTML = `<p class="empty-state">Please log in to view your plan details.</p>`;
            return;
        }

        const status = (currentUserProfile && currentUserProfile.subscriptionStatus) || 'none';
        const expiryTimestamp = (currentUserProfile && currentUserProfile.subscriptionExpiry) || null;
        const isPremium = status !== 'none' && expiryTimestamp && expiryTimestamp > Date.now();

        let planDetailsHTML = `
            <div class="detail-card">
                <div class="detail-row">
                    <span class="detail-label">Username</span>
                    <span class="detail-value">${(currentUserProfile && currentUserProfile.displayName) || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email</span>
                    <span class="detail-value" style="text-transform: none;">${user.email}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Current Plan</span>
                    <span class="detail-value">${isPremium ? `<span class="premium-badge">${status}</span>` : 'Free Tier'}</span>
                </div>
        `;

        if(isPremium) {
             const expiryDate = new Date(expiryTimestamp);
             const formattedExpiry = expiryDate.toLocaleString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
             });

            planDetailsHTML += `
                <div class="detail-row">
                    <span class="detail-label">Expires On</span>
                    <span class="detail-value">${formattedExpiry}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Time Remaining</span>
                    <span class="detail-value" id="plan-countdown-timer">Loading...</span>
                </div>
            `;
        }

        planDetailsHTML += '</div>';

        if (!isPremium) {
            planDetailsHTML += '<button class="auth-btn upgrade-btn" onclick="navigateTo(\'subscription\')">Upgrade to Premium</button>';
        } else {
            planDetailsHTML += '<p style="text-align:center; color: var(--text-secondary); padding: 15px;">You have access to all premium content. Enjoy!</p>';
        }

        container.innerHTML = planDetailsHTML;

        if (isPremium) {
            const timerElement = document.getElementById('plan-countdown-timer');

            const updateCountdown = () => {
                const now = new Date().getTime();
                const distance = expiryTimestamp - now;

                if (distance < 0) {
                    clearInterval(planCountdownInterval);
                    timerElement.textContent = "Plan Expired";
                    database.ref('users/' + user.uid).update({ subscriptionStatus: 'none' });
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerElement.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            };

            updateCountdown();
            planCountdownInterval = setInterval(updateCountdown, 1000);
        }
    }

    function renderAccountSettingsPage() {
        const user = auth.currentUser;
        if (!user || user.isAnonymous) { goBack(); return; }
        document.getElementById('settings-name').value = (currentUserProfile && currentUserProfile.displayName) || '';
        document.getElementById('settings-email').value = user.email;
        database.ref('users/' + user.uid + '/gender').once('value').then(snapshot => {
            const gender = snapshot.val();
            if(gender) {
                const radio = document.querySelector(`input[name="gender"][value="${gender}"]`);
                if (radio) radio.checked = true;
            }
        });
        const form = document.getElementById('account-settings-form');
        form.onsubmit = (e) => {
            e.preventDefault();
            const newName = document.getElementById('settings-name').value;
            const newGender = document.querySelector('input[name="gender"]:checked')?.value;
            user.updateProfile({ displayName: newName }).then(() => {
                database.ref('users/' + user.uid).update({
                    displayName: newName,
                    gender: newGender
                }).then(() => {
                    showToast("Profile updated successfully!");
                    updateUserProfileUI(user);
                    goBack();
                });
            }).catch(error => { showToast("Error updating profile: " + error.message); });
        };
    }

    function renderAppLockPage() {
        const isLockEnabled = localStorage.getItem('rangmanch_app_lock_enabled') === 'true';
        const toggleSwitch = document.getElementById('app-lock-enabled-switch');
        const pinContainer = document.getElementById('app-lock-pin-container');
        const form = document.getElementById('app-lock-form');
        const pinInput = document.getElementById('app-lock-pin');
        const pinConfirmInput = document.getElementById('app-lock-pin-confirm');
        const errorEl = document.getElementById('app-lock-error');

        toggleSwitch.checked = isLockEnabled;
        pinContainer.classList.toggle('hidden', !toggleSwitch.checked);
        errorEl.textContent = '';
        errorEl.style.display = 'none';
        pinInput.value = '';
        pinConfirmInput.value = '';

        toggleSwitch.onchange = () => {
            pinContainer.classList.toggle('hidden', !toggleSwitch.checked);
            if (!toggleSwitch.checked) {
                errorEl.textContent = '';
                errorEl.style.display = 'none';
            }
        };

        form.onsubmit = (e) => {
            e.preventDefault();
            errorEl.textContent = '';
            errorEl.style.display = 'none';

            if (toggleSwitch.checked) {
                const pin = pinInput.value;
                const confirmPin = pinConfirmInput.value;

                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    errorEl.textContent = 'PIN must be exactly 4 digits.';
                    errorEl.style.display = 'block';
                    return;
                }
                if (pin !== confirmPin) {
                    errorEl.textContent = 'PINs do not match.';
                    errorEl.style.display = 'block';
                    return;
                }

                localStorage.setItem('rangmanch_app_lock_enabled', 'true');
                localStorage.setItem('rangmanch_app_lock_pin', pin);
                showToast("App Lock enabled.");
                goBack();
            } else {
                localStorage.removeItem('rangmanch_app_lock_enabled');
                localStorage.removeItem('rangmanch_app_lock_pin');
                showToast("App Lock disabled.");
                goBack();
            }
        };
    }



    function goBack() {
        clearAllCountdowns();
        if (planCountdownInterval) clearInterval(planCountdownInterval);
        if (liveTvPlayer) { liveTvPlayer.destroy(); liveTvPlayer = null; }
        if (hls) { hls.destroy(); hls = null; }
        if (moviePlayer) { moviePlayer.destroy(); moviePlayer = null; }
        if (seriesPlayer) { seriesPlayer.destroy(); seriesPlayer = null; }
        document.getElementById('livetv-player-element').src = '';
        document.getElementById('movie-player-element').src = '';
        document.getElementById('series-player-element').src = '';

        document.body.style.overflowY = 'auto'; // Restore scrolling

        if (navigationHistory.length <= 1) {
            navigateTo('home', true);
            return;
        }

        navigationHistory.pop();
        const previousPage = navigationHistory[navigationHistory.length - 1];

        if (typeof previousPage === 'object') {
            if (previousPage.type === 'detail' || previousPage.type === 'series_detail') {
                 const item = allContent.find(c => c.id === previousPage.id);
                if(item) {
                    if(seriesTypes.includes(item.type)) showSeriesDetail(item, true);
                    else showDetail(item, true);
                }
            } else if (previousPage.type === 'livetv_category') {
                navigateTo('livetv', true);
            }
        } else if (typeof previousPage === 'string') {
            navigateTo(previousPage, true);
        } else {
            navigateTo('home', true);
        }
    }
    function toggleWatchlist(item) { if (!item) return; const index = watchlist.findIndex(w => w.id === item.id); if (index > -1) { watchlist.splice(index, 1); showToast("Removed from My List"); } else { watchlist.push(item); showToast("Added to My List"); } localStorage.setItem('rangmanch_watchlist', JSON.stringify(watchlist)); updateDetailWatchlistButton(item); updatePlayerWatchlistButton(item); updateSeriesDetailWatchlistButton(item); updateSeriesPlayerWatchlistButton(item); if (document.querySelector('#nav-watchlist.active')) renderWatchlistPage(); }
    function removeFromWatchlist(index) { watchlist.splice(index, 1); localStorage.setItem('rangmanch_watchlist', JSON.stringify(watchlist)); renderWatchlistPage(); }

    function playContent(item) {
        const user = auth.currentUser;
        if (item.tier === 'premium') {
            if (!user || user.isAnonymous) {
                showToast("Please sign in to watch premium content.");
                return;
            }
            if (currentUserProfile && currentUserProfile.subscriptionStatus !== 'none' && currentUserProfile.subscriptionExpiry > Date.now()) {
                const link = item.link; if (link) { addToWatchHistory(item); showMoviePlayer(item); } else { showToast('No content available to play.'); }
            } else {
                showToast("Subscribe to watch premium content.");
                navigateTo('subscription');
                return;
            }
        } else {
            const link = item.link; if (link) { addToWatchHistory(item); showMoviePlayer(item); } else { showToast('No content available to play.'); }
        }
    }

    function setupDoubleTapSeek(player) {
        if (!player) return;
        const container = player.elements && player.elements.container ? player.elements.container : (player.closest ? player.closest('.custom-player') : null);
        const media = (player.media) || (player.elements && player.elements.media) || (container ? container.querySelector('video') : (player.tagName === 'VIDEO' ? player : null));
        let lastTap = 0;
        let tapTimeout;
        
        container.addEventListener('touchstart', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            
            if (tapLength < 300 && tapLength > 0) {
                // Double tap detected
                clearTimeout(tapTimeout);
                e.preventDefault();
                
                const touchX = e.changedTouches[0].clientX;
                const width = container.offsetWidth;
                
                // Show animation overlay
                const overlay = document.createElement('div');
                overlay.className = 'seek-overlay';
                overlay.style.position = 'absolute';
                overlay.style.top = '50%';
                overlay.style.transform = 'translateY(-50%)';
                overlay.style.color = 'white';
                overlay.style.fontSize = '24px';
                overlay.style.fontWeight = 'bold';
                overlay.style.textShadow = '0 0 10px rgba(0,0,0,0.5)';
                overlay.style.zIndex = '5';
                overlay.style.padding = '20px';
                overlay.style.background = 'rgba(0,0,0,0.3)';
                overlay.style.borderRadius = '50%';
                overlay.style.pointerEvents = 'none';
                overlay.style.animation = 'fadeout 0.5s forwards';
                
                // Define keyframes for fadeout if not exists
                if (!document.getElementById('seek-anim-style')) {
                    const style = document.createElement('style');
                    style.id = 'seek-anim-style';
                    style.innerHTML = `@keyframes fadeout { 0% { opacity: 1; transform: translateY(-50%) scale(0.8); } 100% { opacity: 0; transform: translateY(-50%) scale(1.2); } }`;
                    document.head.appendChild(style);
                }

                if (touchX < width / 3) {
                    // Left side - Rewind
                    if (player.rewind) player.rewind(10); else if (media) media.currentTime = Math.max(0, media.currentTime - 10);
                    overlay.innerHTML = '<i class="fas fa-backward"></i> -10s';
                    overlay.style.left = '20%';
                } else if (touchX > width * 2 / 3) {
                    // Right side - Forward
                    if (player.forward) player.forward(10); else if (media) media.currentTime = Math.min(media.duration || (media.currentTime + 10), media.currentTime + 10);
                    overlay.innerHTML = '+10s <i class="fas fa-forward"></i>';
                    overlay.style.right = '20%';
                } else {
                    return; // Middle tap, do nothing (or pause/play handled by Plyr)
                }
                
                container.appendChild(overlay);
                setTimeout(() => overlay.remove(), 500);
            }
            lastTap = currentTime;
        }, { passive: false });
    }

    function setupVolumeBrightnessGestures(player) {
        if (!player) return;
        const container = player.elements && player.elements.container ? player.elements.container : (player.closest ? player.closest('.custom-player') : null);
        const media = (player.media) || (player.elements && player.elements.media) || (container ? container.querySelector('video, audio') : (player.tagName === 'VIDEO' ? player : null));
        if (!container) return;
        if (media) { media.style.filter = media.style.filter || 'brightness(1)'; }
        player._brightness = player._brightness || 1;
        let startX = 0, startY = 0, region = 'middle';
        const step = 0.08;
        const threshold = 15;
        let lastY = 0;
        
        function showLevelOverlay(label, value) {
            const overlay = document.createElement('div');
            overlay.style.position = 'absolute';
            overlay.style.left = '50%';
            overlay.style.top = '20%';
            overlay.style.transform = 'translate(-50%, -50%)';
            overlay.style.background = 'rgba(0,0,0,0.5)';
            overlay.style.color = '#fff';
            overlay.style.padding = '10px 14px';
            overlay.style.borderRadius = '8px';
            overlay.style.fontSize = '14px';
            overlay.style.zIndex = '6';
            overlay.style.pointerEvents = 'none';
            overlay.textContent = `${label}: ${value}%`;
            container.appendChild(overlay);
            setTimeout(() => overlay.remove(), 700);
        }
        
        container.addEventListener('touchstart', (e) => {
            const t = e.changedTouches[0];
            startX = t.clientX;
            startY = t.clientY;
            lastY = startY;
            const width = container.offsetWidth;
            region = startX < width / 2 ? 'left' : 'right';
        }, { passive: true });
        
        container.addEventListener('touchmove', (e) => {
            const t = e.changedTouches[0];
            const dy = lastY - t.clientY;
            if (Math.abs(dy) < threshold) return;
            lastY = t.clientY;
            if (region === 'right') {
                let vol = player.volume !== undefined ? player.volume : (media ? media.volume : 1);
                vol += dy > 0 ? step : -step;
                vol = Math.max(0, Math.min(1, vol));
                if (player.volume !== undefined) player.volume = vol; else if (media) media.volume = vol;
                showLevelOverlay('Volume', Math.round(vol * 100));
            } else if (region === 'left' && media) {
                let b = player._brightness;
                b += dy > 0 ? step : -step;
                b = Math.max(0.5, Math.min(1.5, b));
                player._brightness = b;
                const existing = media.style.filter || '';
                const parts = existing.split(' ').filter(p => !p.startsWith('brightness('));
                parts.push(`brightness(${b})`);
                media.style.filter = parts.join(' ').trim();
                showLevelOverlay('Brightness', Math.round(b * 100));
            }
        }, { passive: true });
        
        container.addEventListener('dblclick', (e) => {
            const width = container.offsetWidth;
            if (e.clientX < width / 3) {
                if (player.rewind) player.rewind(10); else if (media) media.currentTime = Math.max(0, media.currentTime - 10);
            } else if (e.clientX > width * 2 / 3) {
                if (player.forward) player.forward(10); else if (media) media.currentTime = Math.min(media.duration || (media.currentTime + 10), media.currentTime + 10);
            }
        });
    }
    function setupPlayerFullscreenRotation(player) {
        if (!player) return;
        player.on('enterfullscreen', () => {
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (isTouchDevice && screen.orientation && typeof screen.orientation.lock === 'function') {
                screen.orientation.lock('landscape').catch(err => {
                    console.warn("Could not lock screen to landscape. This is expected on some devices. User can still rotate manually.", err.message);
                });
            }
        });
        player.on('exitfullscreen', () => {
            if (screen.orientation && typeof screen.orientation.unlock === 'function') {
                try {
                    screen.orientation.unlock();
                } catch (err) { /* Fails silently if not locked, which is fine */ }
            }
        });
    }

    const advancedPlayerRefs = { movie: null, series: null, livetv: null };
    function initAdvancedPlayerUI(pageId, pageKey, playerInstance) {
        advancedPlayerRefs[pageKey] = playerInstance;
        const page = document.getElementById(pageId);
        if (!page) return;
        const container = page.querySelector('.custom-player');
        if (!container) return;
        if (container.dataset.init === '1') return;
        container.dataset.init = '1';
        const video = container.querySelector('video');
        const playPauseBtn = container.querySelector('.play-pause-btn');
        const progressContainer = container.querySelector('.progress-container');
        const progressBar = container.querySelector('.progress-bar');
        const timeDisplay = container.querySelector('.time-display');
        const fullscreenBtn = container.querySelector('.fullscreen-btn');
        const pipBtn = container.querySelector('.pip-btn');
        const settingsBtn = container.querySelector('.settings-btn');
        const settingsMenu = container.querySelector('.settings-menu');
        const settingItems = container.querySelectorAll('.setting-item[data-menu]');
        const backBtns = container.querySelectorAll('.back-btn');
        const speedOptions = container.querySelectorAll('.speed-option');
        const currentSpeedDisplay = container.querySelector('.speed-value');
        const seekTimeSlider = container.querySelector(`#seek-time-${pageKey}`);
        const seekTimeValue = container.querySelector('.seek-time-value');
        const volumeBtn = container.querySelector('.volume-btn');
        const volumeRange = container.querySelector('.volume-range');
        const aspectRatioBtn = container.querySelector('.aspect-ratio-btn');
        const fitIcon = aspectRatioBtn.querySelector('.fit-icon');
        const fillIcon = aspectRatioBtn.querySelector('.fill-icon');
        const playIcon = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>`;
        const pauseIcon = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
        function formatTime(t) { const m = Math.floor(t / 60); const s = Math.floor(t % 60).toString().padStart(2, '0'); return `${m}:${s}`; }
        function updateProgress() {
            const player = advancedPlayerRefs[pageKey] || video;
            const d = player.duration;
            const ct = player.currentTime;
            if (isFinite(d) && d > 0) {
                progressBar.style.width = `${(ct / d) * 100}%`;
                timeDisplay.textContent = `${formatTime(ct)} / ${formatTime(d)}`;
                container.classList.remove('live');
            } else {
                container.classList.add('live');
            }
        }
        let isScrubbing = false;
        function scrub(e) {
            const player = advancedPlayerRefs[pageKey] || video;
            if (!player || !isFinite(player.duration)) return;
            const rect = progressContainer.getBoundingClientRect();
            let pos = (e.clientX - rect.left) / rect.width;
            pos = Math.max(0, Math.min(1, pos));
            player.currentTime = pos * player.duration;
        }
        video.addEventListener('play', () => { playPauseBtn.innerHTML = pauseIcon; container.classList.remove('paused'); });
        video.addEventListener('pause', () => { playPauseBtn.innerHTML = playIcon; container.classList.add('paused'); });
        playPauseBtn.addEventListener('click', () => { const player = advancedPlayerRefs[pageKey] || video; if (!player) return; if (player.paused) player.play(); else player.pause(); });
        progressContainer.addEventListener('mousedown', (e) => { isScrubbing = true; container.classList.add('seeking'); scrub(e); });
        document.addEventListener('mousemove', (e) => { if (isScrubbing) scrub(e); });
        document.addEventListener('mouseup', () => { if (isScrubbing) { isScrubbing = false; container.classList.remove('seeking'); } });
        video.addEventListener('timeupdate', updateProgress);
        video.addEventListener('canplay', updateProgress);
        video.addEventListener('durationchange', updateProgress);
        let lastVolume = 1;
        volumeBtn.addEventListener('click', () => { const player = advancedPlayerRefs[pageKey] || video; if (!player) return; player.muted = !player.muted; volumeRange.value = player.muted ? 0 : lastVolume; });
        volumeRange.addEventListener('input', (e) => { const player = advancedPlayerRefs[pageKey] || video; if (!player) return; const v = parseFloat(e.target.value); player.volume = v; player.muted = v === 0; if (v > 0) lastVolume = v; });
        fullscreenBtn.addEventListener('click', async () => {
            try {
                if (!document.fullscreenElement) {
                    await container.requestFullscreen({ navigationUI: 'hide' });
                    if (screen.orientation && screen.orientation.lock) { try { await screen.orientation.lock('landscape'); } catch (e) {} }
                } else {
                    await document.exitFullscreen();
                    if (screen.orientation && screen.orientation.unlock) { try { screen.orientation.unlock(); } catch (e) {} }
                }
            } catch (err) {}
        });
        pipBtn.addEventListener('click', () => {
            if (document.pictureInPictureEnabled) {
                if (document.pictureInPictureElement) document.exitPictureInPicture(); else video.requestPictureInPicture().catch(() => {});
            }
        });
        aspectRatioBtn.addEventListener('click', () => {
            const isFill = video.classList.toggle('video-fill');
            fitIcon.style.display = isFill ? 'none' : 'block';
            fillIcon.style.display = isFill ? 'block' : 'none';
        });
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                video.classList.remove('video-fill');
                fitIcon.style.display = 'block';
                fillIcon.style.display = 'none';
                if (screen.orientation && screen.orientation.unlock) { try { screen.orientation.unlock(); } catch (e) {} }
            }
        });
        settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsMenu.classList.toggle('active'); });
        settingItems.forEach(item => { item.addEventListener('click', () => { const id = item.dataset.menu; container.querySelector('.main-menu').style.display = 'none'; container.querySelector(`.submenu[data-menu="${id}"]`).classList.add('active'); }); });
        backBtns.forEach(btn => { btn.addEventListener('click', () => { btn.closest('.submenu').classList.remove('active'); container.querySelector('.main-menu').style.display = 'block'; }); });
        speedOptions.forEach(option => {
            option.addEventListener('click', () => {
                const player = advancedPlayerRefs[pageKey] || video;
                if (!player) return;
                player.playbackRate = parseFloat(option.dataset.speed);
                speedOptions.forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                currentSpeedDisplay.textContent = option.textContent;
                option.closest('.submenu').classList.remove('active');
                container.querySelector('.main-menu').style.display = 'block';
            });
        });
        if (seekTimeSlider && seekTimeValue) seekTimeSlider.addEventListener('input', (e) => { seekTimeValue.textContent = `${parseInt(e.target.value, 10)}s`; });
        document.addEventListener('click', (e) => { if (!settingsMenu.contains(e.target) && e.target !== settingsBtn) settingsMenu.classList.remove('active'); });
    }

    function switchMovieInPlayer(item) {
        currentContent = item;
        addToWatchHistory(item);
        const page = document.getElementById('movie-player-page');
        const videoElement = page.querySelector('#movie-player-element');
        const errorOverlay = page.querySelector('.player-error-overlay');
        const loadingOverlay = page.querySelector('.player-loading-overlay');

        errorOverlay.classList.remove('show');
        loadingOverlay.classList.add('show');

        try { videoElement.pause(); } catch (e) {}
        videoElement.removeAttribute('src'); videoElement.load();
        const link = item.link || '';
        videoElement.onerror = () => { errorOverlay.classList.add('show'); loadingOverlay.classList.remove('show'); };
        const useHls = link.includes('.m3u8') && typeof Hls !== 'undefined' && Hls.isSupported();
        if (useHls) {
            const hlsLocal = new Hls();
            hlsLocal.loadSource(link);
            hlsLocal.attachMedia(videoElement);
            hlsLocal.on(Hls.Events.MANIFEST_PARSED, () => { loadingOverlay.classList.remove('show'); videoElement.play().catch(() => {}); });
        } else {
            videoElement.src = link;
            videoElement.addEventListener('loadedmetadata', () => { loadingOverlay.classList.remove('show'); videoElement.play().catch(() => {}); }, { once: true });
        }
        videoElement.addEventListener('playing', () => loadingOverlay.classList.remove('show'));
        videoElement.addEventListener('ended', () => {
            if(document.getElementById('movie-autoplay-switch').checked) {
                const nextItem = moviePlayerSimilarContent[0];
                if (nextItem) switchMovieInPlayer(nextItem);
            }
        });
        setupDoubleTapSeek(videoElement);
        setupVolumeBrightnessGestures(videoElement);
        initAdvancedPlayerUI('movie-player-page', 'movie', videoElement);

        document.getElementById('movie-player-title').textContent = item.title;
        document.getElementById('player-watchlist-btn').onclick = () => toggleWatchlist(item);
        document.getElementById('player-report-btn').onclick = () => showReportModal(item);

        document.getElementById('player-like-btn').onclick = () => handleContentInteraction('like', item);
        document.getElementById('player-dislike-btn').onclick = () => handleContentInteraction('dislike', item);
        loadInteractionStatus(item, 'player');

        updatePlayerWatchlistButton(item);

        const similarSlider = document.getElementById('movie-player-similar-slider');
        similarSlider.innerHTML = '';
        moviePlayerSimilarContent = allContent.filter(c => c.id !== item.id && (c.type === 'movie' || c.type === 'anime_movie') && (c.category === item.category)).slice(0, 10);

        if(moviePlayerSimilarContent.length > 0) {
             moviePlayerSimilarContent.forEach(content => {
                const card = createContentCard(content, true);
                card.onclick = (e) => {
                    const targetCard = e.currentTarget;
                    targetCard.classList.add('card-clicked');
                    setTimeout(() => {
                        switchMovieInPlayer(content);
                        targetCard.classList.remove('card-clicked');
                    }, 150);
                };
                similarSlider.appendChild(card);
            });
        }
    }

    function showMoviePlayer(item) {
        hideAllPages();
        document.getElementById('bottom-nav').style.display = 'none';
        document.getElementById('movie-player-page').style.display = 'flex';
        switchMovieInPlayer(item);
    }

    function exitPlayerAndGoBack() {
        if (liveTvPlayer) { liveTvPlayer.destroy(); liveTvPlayer = null; }
        if (hls) { hls.destroy(); hls = null; }
        if (moviePlayer) { moviePlayer.destroy(); moviePlayer = null; }
        if (seriesPlayer) { seriesPlayer.destroy(); seriesPlayer = null; }

        document.getElementById('livetv-player-element').src = '';
        document.getElementById('movie-player-element').src = '';
        document.getElementById('series-player-element').src = '';

        goBack();
    }

    function getYouTubeEmbedUrl(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? `https://www.youtube.com/watch?v=${match[2]}` : null;
    }
    
    function showTrailer(url) {
        const embedUrl = getYouTubeEmbedUrl(url);
        if (embedUrl) {
            const trailerLink = document.getElementById('trailer-link');
            trailerLink.href = embedUrl;
            document.getElementById('trailer-modal').classList.add('show');
        } else {
            showToast('No valid trailer link is available for this title.');
        }
    }
    
    function closeTrailer() {
        document.getElementById('trailer-modal').classList.remove('show');
        document.getElementById('trailer-link').href = '#';
    }

    // Report functionality
    function showReportModal(item) {
        const modal = document.getElementById('report-modal');
        document.getElementById('report-title').value = item.title;
        modal.classList.add('show');
    }

    function closeReportModal() {
        const modal = document.getElementById('report-modal');
        modal.classList.remove('show');
        document.getElementById('report-form').reset();
    }

    function handleReportSubmit(event) {
        event.preventDefault();
        const user = auth.currentUser;
        if (!user) {
            showToast("You must be logged in to report content.");
            return;
        }

        const title = document.getElementById('report-title').value;
        const reason = document.getElementById('report-reason').value;
        const description = document.getElementById('report-description').value.trim();

        if (!reason || !description) {
            showToast("Please fill out all fields.");
            return;
        }

        const reportData = {
            title: title,
            reason: reason,
            description: description,
            reportedBy: user.email,
            uid: user.uid,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        database.ref('content_reports').push(reportData)
            .then(() => {
                showToast("Report submitted successfully!");
                closeReportModal();
            })
            .catch(error => {
                showToast("Error submitting report: " + error.message);
            });
    }

    async function renderHomePage() {
        const container = document.getElementById('home-content');
        clearAllMainContent();
        container.innerHTML = `<div class="slider-container" id="slider-container"></div>`;

        const movies = allContent.filter(item => item.type === 'movie' || item.type === 'anime_movie');
        const series = allContent.filter(item => item.type === 'webseries');

        updateSlider(movies);
        await renderTrendingSection(container);
        await renderUpcomingSectionOnHome(container);

        if (series.length > 0) {
            const section = document.createElement('div');
            section.className = 'category-section';
            section.innerHTML = `<div class="category-header"><h2 class="category-title">Popular Series</h2><a href="#" class="see-all-btn" onclick="event.preventDefault(); navigateTo('series')">See All &gt;</a></div><div class="content-slider"></div>`;
            const slider = section.querySelector('.content-slider');
            series.slice(0, 10).forEach(item => slider.appendChild(createBackdropCard(item)));
            container.appendChild(section);
        }

        updateCategories(movies, 'movie', container);
        updateCategories(movies, 'anime_movie', container);
    }

    async function renderTrendingSection(container) {
        try {
            const snapshot = await database.ref('trending').once('value');
            const trendingData = snapshot.val();
            if (!trendingData) return;

            const trendingContent = [];
            const ranks = Object.keys(trendingData).sort((a, b) => a - b);
            const allMovieTypes = allContent.filter(item => item.type === 'movie' || item.type === 'anime_movie');

            for (const rank of ranks) {
                const contentId = trendingData[rank];
                const contentItem = allMovieTypes.find(item => item.id === contentId);
                if (contentItem) {
                    trendingContent.push({ ...contentItem, rank: parseInt(rank) });
                }
            }
            if (trendingContent.length === 0) return;

            const section = document.createElement('div');
            section.id = 'trending-section';
            section.className = 'category-section';
            section.innerHTML = `<div class="category-header"><h2 class="category-title">Top Trending</h2></div><div class="content-slider"></div>`;
            const slider = section.querySelector('.content-slider');
            trendingContent.forEach(item => {
                slider.appendChild(createTrendingCard(item, item.rank));
            });
            container.appendChild(section);
        } catch (error) {
            console.error("Error fetching or rendering trending section:", error);
        }
    }

    async function renderUpcomingSectionOnHome(container) {
        try {
            const snapshot = await database.ref('upcoming').orderByChild('releaseTimestamp').limitToFirst(10).once('value');
            if (!snapshot.exists()) return;

            const upcomingItems = [];
            snapshot.forEach(child => {
                upcomingItems.push({ id: child.key, ...child.val() });
            });
            if (upcomingItems.length === 0) return;

            const section = document.createElement('div');
            section.className = 'category-section';
            section.innerHTML = `<div class="category-header"><h2 class="category-title">Coming Soon</h2><a href="#" class="see-all-btn" onclick="event.preventDefault(); navigateTo('upcoming')">See All &gt;</a></div><div class="content-slider"></div>`;

            const slider = section.querySelector('.content-slider');
            upcomingItems.forEach(item => {
                slider.appendChild(createUpcomingHomeCard(item));
            });
            container.appendChild(section);
        } catch (error) {
            console.error("Error rendering upcoming section on home:", error);
        }
    }

    function createUpcomingHomeCard(item) {
        const card = document.createElement('div');
        card.className = 'content-card';
        card.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                showToast(`"${item.title}" is releasing soon!`);
                e.currentTarget.classList.remove('card-clicked');
            }, 150);
        };

        const releaseDate = new Date(item.releaseTimestamp);
        const formattedDate = releaseDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        card.innerHTML = `
            <img src="${item.poster}" alt="${item.title}" loading="lazy">
            <div class="upcoming-overlay">
                <i class="fas fa-clock"></i> Releasing on ${formattedDate}
            </div>`;
        return card;
    }

    function createBadge(item) {
        if (item.isNew) { return `<div class="new-badge-ribbon"><span>New</span></div>`; }
        if (item.qualityBadge && item.qualityBadge !== 'none') { return `<div class="new-badge-ribbon"><span>${item.qualityBadge}</span></div>`; }
        return '';
    }

    const seriesTypes = ['webseries', 'anime'];

    function createTrendingCard(item, rank) {
        const card = document.createElement('div');
        card.className = 'trending-card';
        card.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                seriesTypes.includes(item.type) ? showSeriesDetail(item) : showDetail(item);
            }, 150);
        };
        const badgeHtml = createBadge(item);
        let premiumCrown = item.tier === 'premium' ? '<i class="fas fa-crown premium-crown"></i>' : '';
        let languageBadgeHtml = item.language ? `<div class="language-badge">${item.language}</div>` : '';
        card.innerHTML = `<img src="${item.poster}" alt="${item.title}" loading="lazy">${badgeHtml}${premiumCrown}${languageBadgeHtml}<span class="trending-rank">${rank}</span><span class="trending-title">${item.title}</span>`;
        return card;
    }

    function updateCategories(content, contentType, container) {
        const categories = [...new Set(content.map(item => item.category).filter(cat => cat && cat.toLowerCase() !== 'anime'))];

        categories.forEach(categoryName => {
            const categoryContent = content
                .filter(item => item.category === categoryName && item.type === contentType)
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (categoryContent.length === 0) return;

            const section = document.createElement('div');
            section.className = 'category-section';
            section.innerHTML = `<div class="category-header"><h2 class="category-title">${categoryName}</h2><a href="#" class="see-all-btn" onclick="event.preventDefault(); renderCategoryPage('${categoryName}', '${contentType}')">See All &gt;</a></div><div class="content-slider"></div>`;

            const slider = section.querySelector('.content-slider');
            categoryContent.slice(0, 10).forEach(item => slider.appendChild(createContentCard(item)));
            container.appendChild(section);
        });
    }

    function createContentCard(item) {
        const card = document.createElement('div');
        card.className = 'content-card';
        card.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                seriesTypes.includes(item.type) ? showSeriesDetail(item) : showDetail(item);
            }, 150);
        };
        let badgeHtml = createBadge(item);
        let premiumCrown = item.tier === 'premium' ? '<i class="fas fa-crown premium-crown"></i>' : '';
        let languageBadgeHtml = item.language ? `<div class="language-badge">${item.language}</div>` : '';
        card.innerHTML = `<img src="${item.poster}" alt="${item.title}" loading="lazy">${badgeHtml}${premiumCrown}${languageBadgeHtml}<div class="content-card-overlay"><span class="content-card-title">${item.title}</span></div>`;
        return card;
    }

    function createBackdropCard(item) {
        const card = document.createElement('div');
        card.className = 'backdrop-card';
        card.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                showSeriesDetail(item);
            }, 150);
        };
        let badgeHtml = createBadge(item);
        let premiumCrown = item.tier === 'premium' ? '<i class="fas fa-crown premium-crown"></i>' : '';
        let languageBadgeHtml = item.language ? `<div class="language-badge">${item.language}</div>` : '';
        card.innerHTML = `<img src="${item.backdrop || item.poster}" alt="${item.title}" loading="lazy">${badgeHtml}${premiumCrown}${languageBadgeHtml}<div class="content-card-overlay"><span class="content-card-title">${item.title}</span></div>`;
        return card;
    }

    function updateSlider(content) {
        const sliderContainer = document.getElementById('slider-container');
        sliderContainer.innerHTML = `<div class="slider" id="slider"></div><div class="slider-indicators" id="slider-indicators"></div>`;
        const slider = document.getElementById('slider'), indicators = document.getElementById('slider-indicators');
        const recentItems = content.slice(0, 6);
        if (recentItems.length === 0) { sliderContainer.style.display = 'none'; return; }
        sliderContainer.style.display = 'block';
        slider.innerHTML = '';
        indicators.innerHTML = '';
        recentItems.forEach((item, index) => {
            const slide = document.createElement('div');
            slide.className = 'slide';
            const languageInfo = item.language ? ` ${item.language}` : '';
            slide.innerHTML = `<img src="${item.backdrop || item.poster}" alt="${item.title}" loading="lazy"><div class="slide-overlay"><div class="slide-title">${item.title}</div><div class="slide-meta"> ${item.rating || 'N/A'}  ${item.year || 'Unknown'}${languageInfo}</div></div>`;
            slide.onclick = (e) => {
                e.currentTarget.classList.add('card-clicked');
                setTimeout(() => {
                    seriesTypes.includes(item.type) ? showSeriesDetail(item) : showDetail(item);
                }, 150);
            };
            slider.appendChild(slide);
            const indicator = document.createElement('div');
            indicator.className = `indicator ${index === 0 ? 'active' : ''}`;
            indicator.onclick = () => goToSlide(index);
            indicators.appendChild(indicator);
        });
        startSlider(recentItems.length);
        goToSlide(0);
    }

    function showDetail(item, isFromHistory = false) {
        if (!isFromHistory) { navigationHistory.push({ type: 'detail', id: item.id }); }
        currentContent = item;
        if (sliderInterval) clearInterval(sliderInterval);

        hideAllPages();

        document.getElementById('detail-backdrop').innerHTML = `<img src="${item.backdrop || item.poster}" alt="" loading="lazy">`;
        document.getElementById('detail-title').textContent = item.title;
        document.getElementById('detail-meta').innerHTML = ` ${item.rating || 'N/A'}  ${item.year || 'Unknown Year'}`;
        document.getElementById('play-btn').onclick = () => playContent(item);
        document.getElementById('detail-storyline').textContent = item.storyline || 'No storyline available.';
        document.getElementById('detail-trailer-btn').onclick = () => { if (item.trailer && item.trailer.trim()) { showTrailer(item.trailer); } else { showToast('No trailer available for this title.'); } };
        document.getElementById('detail-watchlist-btn').onclick = () => toggleWatchlist(item);
        document.getElementById('detail-report-btn').onclick = () => showReportModal(item);

        const commentForm = document.getElementById('movie-comment-form');
        const commentInput = document.getElementById('movie-comment-input');
        const commentSubmitBtn = document.getElementById('movie-comment-submit-btn');
        const user = auth.currentUser;
        if (user && user.isAnonymous) {
            commentInput.placeholder = 'Please sign in to comment.';
            commentInput.disabled = true;
            commentSubmitBtn.disabled = true;
        } else {
            commentInput.placeholder = 'Add a public comment...';
            commentInput.disabled = false;
            commentSubmitBtn.disabled = false;
            commentForm.onsubmit = (e) => saveComment(e, item.id, 'movie-comment-input');
        }
        loadComments(item.id, 'movie-comments-list');

        const castList = document.getElementById('detail-cast-list');
        const castSection = document.getElementById('detail-cast-section');
        castList.innerHTML = '';
        if (item.cast) {
            const castArray = Object.values(item.cast);
            if (castArray.length > 0) {
                castSection.style.display = 'block';
                castArray.forEach(actor => {
                    const castItem = document.createElement('div');
                    castItem.className = 'cast-item';
                    castItem.innerHTML = `<img src="${actor.image || 'https://i.ibb.co/yqg0Y3h/placeholder-avatar.jpg'}" alt="${actor.name}" loading="lazy"><p>${actor.name}</p>`;
                    castList.appendChild(castItem);
                });
            } else {
                castSection.style.display = 'none';
            }
        } else {
            castSection.style.display = 'none';
        }

        const similarSlider = document.getElementById('similar-slider');
        similarSlider.innerHTML = '';
        const similarContent = allContent.filter(c => c.id !== item.id && (c.type === 'movie' || c.type === 'anime_movie') && (c.category === item.category)).slice(0, 10);
        if (similarContent.length > 0) {
            document.getElementById('similar-section').style.display = 'block';
            similarContent.forEach(content => similarSlider.appendChild(createContentCard(content)));
        } else {
            document.getElementById('similar-section').style.display = 'none';
        }

        updateDetailWatchlistButton(item);
        document.getElementById('detail-page').style.display = 'block';
        document.getElementById('back-btn').style.display = 'block';
        document.getElementById('bottom-nav').style.display = 'none';
        window.scrollTo(0, 0);
    }

    function renderCategoryPage(categoryName, contentType, isFromHistory = false) {
        if (!isFromHistory) { navigationHistory.push({ type: 'category', page: 'categoryGrid', category: categoryName, contentType: contentType }); }
        hideAllPages();
        clearAllMainContent();

        document.getElementById('home-page').style.display = 'block';
        document.getElementById('home-header').style.display = 'none';

        const container = document.getElementById('category-grid-content');
        container.innerHTML = '';
        container.className = 'page-content content-grid';
        container.classList.remove('hidden');

        const pageHeader = document.getElementById('page-header');
        pageHeader.classList.remove('hidden');
        pageHeader.classList.add('centered-header');
        pageHeader.querySelector('i').style.display = 'none';
        document.getElementById('page-title').textContent = categoryName;
        document.getElementById('back-btn').style.display = 'block';
        document.getElementById('bottom-nav').style.display = 'none';

        const categoryContent = allContent.filter(item => item.category === categoryName && item.type === contentType);
        if (categoryContent.length > 0) {
            categoryContent.forEach((item, index) => {
                const card = createContentCard(item);
                card.style.animationDelay = `${index * 0.05}s`;
                card.classList.add('list-item-animate');
                container.appendChild(card);
            });
        } else {
            container.innerHTML = `<div class="empty-state"><p>No items found in ${categoryName}</p></div>`;
        }
        window.scrollTo(0, 0);
    }

    function renderWatchlistPage() {
        const container = document.getElementById('watchlist-content');
        clearAllMainContent();

        if (watchlist.length === 0) {
            container.className = 'page-content is-empty-page';
            container.innerHTML = `<div class="empty-state" style="min-height: calc(100vh - 200px); display: flex; flex-direction: column; justify-content: center;"><i class="fas fa-bookmark empty-icon"></i><p>Your Watchlist is Empty</p><span>Add movies and series to see them here.</span></div>`;
        } else {
            container.className = 'page-content watchlist-container-pro';
            [...watchlist].reverse().forEach((item, index) => {
                const reversedIndex = watchlist.length - 1 - index;
                const card = createProfessionalWatchlistCard(item, reversedIndex);
                card.style.animationDelay = `${index * 0.05}s`;
                container.appendChild(card);
            });
        }
    }

    function createProfessionalWatchlistCard(item, index) {
        const card = document.createElement('div');
        card.className = 'watchlist-card-pro list-item-animate';
        card.onclick = (e) => {
             e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                seriesTypes.includes(item.type) ? showSeriesDetail(item) : showDetail(item);
            }, 150);
        };
        const languageInfo = item.language ? ` &bull; ${item.language}` : '';
        card.innerHTML = `<button class="remove-btn-pro" onclick="event.stopPropagation(); removeFromWatchlist(${index})"><i class="fas fa-times"></i></button><div class="poster"><img src="${item.poster}" alt="${item.title}" loading="lazy"></div><div class="info"><h3 class="title">${item.title}</h3><p class="meta">${item.year || 'N/A'} &bull; ${item.genre || 'Movie'}${languageInfo} &bull;  ${item.rating || 'N/A'}</p><i class="fas fa-play-circle play-icon"></i></div>`;
        return card;
    }

    function openSearch() {
        hideAllPages();
        const searchPage = document.getElementById('search-page');
        searchPage.style.display = 'flex';
        searchPage.classList.add('active');
        document.getElementById('global-search-input').focus();
        document.getElementById('global-search-input').value = '';
        performSearch();
    }

    function renderInitialSearchState() { document.getElementById('search-initial-state').classList.remove('hidden'); document.getElementById('search-results-container').classList.add('hidden'); document.getElementById('search-results-container').innerHTML = ''; const recentContainer = document.getElementById('recent-searches-container'); const popularContainer = document.getElementById('popular-categories-container'); const recentList = document.getElementById('recent-searches-list'); recentList.innerHTML = ''; if (recentSearches.length > 0) { recentContainer.classList.remove('hidden'); popularContainer.classList.add('hidden'); recentSearches.forEach(term => { const item = document.createElement('div'); item.className = 'recent-search-item'; item.innerHTML = `<i class="fas fa-history icon"></i><span class="text">${term}</span><button class="remove-btn" onclick="event.stopPropagation(); removeSearchTerm('${term}')"><i class="fas fa-times"></i></button>`; item.onclick = () => searchByTag(term); recentList.appendChild(item); }); } else { recentContainer.classList.add('hidden'); popularContainer.classList.remove('hidden'); } const categoriesList = document.getElementById('popular-categories-list'); if(categoriesList.children.length === 0){ categoriesList.innerHTML = ''; const popularCategories = [...allCategories].slice(0, 8); popularCategories.forEach(category => { const tag = document.createElement('div'); tag.className = 'suggestion-tag'; tag.textContent = category; tag.onclick = () => searchByTag(category); categoriesList.appendChild(tag); }); } }

    function createSearchResultCard(item) {
        const card = document.createElement('div');
        card.className = 'search-result-card';
        card.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                seriesTypes.includes(item.type) ? showSeriesDetail(item) : showDetail(item);
            }, 150);
        };
        const languageInfo = item.language ? ` &bull; ${item.language}` : '';
        card.innerHTML = `<div class="search-result-poster"><img src="${item.poster}" alt="${item.title}" loading="lazy"></div><div class="search-result-info"><h3 class="search-result-title">${item.title}</h3><p class="search-result-meta">${item.year || ''} &bull; ${item.genre || item.type}${languageInfo}</p><p class="search-result-storyline">${item.storyline || 'No description available.'}</p></div>`;
        return card;
    }

    function performSearch() { const input = document.getElementById('global-search-input'); const clearBtn = document.getElementById('search-clear-btn'); const term = input.value.toLowerCase().trim(); const resultsContainer = document.getElementById('search-results-container'); const initialStateContainer = document.getElementById('search-initial-state'); clearBtn.classList.toggle('hidden', term.length === 0); if (term.length === 0) { renderInitialSearchState(); return; } initialStateContainer.classList.add('hidden'); resultsContainer.classList.remove('hidden'); const results = allContent.filter(item => item.title.toLowerCase().includes(term) || (item.category?.toLowerCase().includes(term)) || (item.genre?.toLowerCase().includes(term))); if (results.length === 0) { resultsContainer.innerHTML = `<div class="empty-state"><i class="fas fa-box-open empty-icon"></i><p>No Results Found For "${input.value}"</p><span>Try searching for something else.</span></div>`; } else { resultsContainer.innerHTML = ''; results.forEach(item => resultsContainer.appendChild(createSearchResultCard(item))); } }
    function clearSearchInput() { const input = document.getElementById('global-search-input'); input.value = ''; performSearch(); input.focus(); }
    let searchDebounceTimeout; document.getElementById('global-search-input').addEventListener('keyup', (event) => { clearTimeout(searchDebounceTimeout); if (event.key === 'Enter') { saveSearchTerm(event.target.value.trim()); } else { searchDebounceTimeout = setTimeout(() => { const term = event.target.value.trim(); if(term.length > 2) saveSearchTerm(term); }, 1500); } });
    function searchByTag(term) { document.getElementById('global-search-input').value = term; performSearch(); saveSearchTerm(term); }
    function saveSearchTerm(term) { if (!term || term.length < 2) return; recentSearches = recentSearches.filter(t => t.toLowerCase() !== term.toLowerCase()); recentSearches.unshift(term); if (recentSearches.length > 6) recentSearches.pop(); localStorage.setItem('rangmanch_recent_searches', JSON.stringify(recentSearches)); }
    function removeSearchTerm(term) { recentSearches = recentSearches.filter(t => t !== term); localStorage.setItem('rangmanch_recent_searches', JSON.stringify(recentSearches)); renderInitialSearchState(); }
    function clearAllRecentSearches() { recentSearches = []; localStorage.removeItem('rangmanch_recent_searches'); renderInitialSearchState(); }
    function goToSlide(index){ currentSlide = index; document.getElementById('slider').style.transform = `translateX(-${100 * currentSlide}%)`; document.querySelectorAll('#slider-indicators .indicator').forEach((ind, i) => ind.classList.toggle('active', i === currentSlide)); }
    function startSlider(count){ if(sliderInterval) clearInterval(sliderInterval); if(count > 0) sliderInterval=setInterval(() => { currentSlide=(currentSlide+1)%count; goToSlide(currentSlide)}, 5000); }
    function updateDetailWatchlistButton(item) { const btn = document.getElementById('detail-watchlist-btn'); if (!btn || !item) return; const icon = btn.querySelector('i'); const isIn = watchlist.some(w => w.id === item.id); if (isIn) { btn.classList.add('active'); icon.className = 'fas fa-check'; } else { btn.classList.remove('active'); icon.className = 'fas fa-plus'; } }
    function updatePlayerWatchlistButton(item) { const btn = document.getElementById('player-watchlist-btn'); if (!btn || !item) return; const icon = btn.querySelector('i'); const isIn = watchlist.some(w => w.id === item.id); if (isIn) { btn.classList.add('active'); icon.className = 'fas fa-check'; } else { btn.classList.remove('active'); icon.className = 'fas fa-plus'; } }

    async function loadInteractionStatus(item, playerPrefix) {
        const user = auth.currentUser;
        const likeBtn = document.getElementById(`${playerPrefix}-like-btn`);
        const dislikeBtn = document.getElementById(`${playerPrefix}-dislike-btn`);
        const likeCountEl = document.getElementById(`${playerPrefix}-like-count`);
        const dislikeCountEl = document.getElementById(`${playerPrefix}-dislike-count`);

        likeBtn.classList.remove('active');
        likeBtn.querySelector('i').className = 'far fa-thumbs-up';
        dislikeBtn.classList.remove('active');
        dislikeBtn.querySelector('i').className = 'far fa-thumbs-down';
        likeCountEl.textContent = '...';
        dislikeCountEl.textContent = '...';

        if (!item) return;

        const contentRef = database.ref(`${item.type}s/${item.id}`);
        contentRef.on('value', snapshot => {
            const data = snapshot.val();
            likeCountEl.textContent = data?.likes || 0;
            dislikeCountEl.textContent = data?.dislikes || 0;
        });

        if (user) {
            const userInteractionRef = database.ref(`user_interactions/${user.uid}/${item.id}`);
            userInteractionRef.on('value', snapshot => {
                const interaction = snapshot.val();
                likeBtn.classList.remove('active');
                likeBtn.querySelector('i').className = 'far fa-thumbs-up';
                dislikeBtn.classList.remove('active');
                dislikeBtn.querySelector('i').className = 'far fa-thumbs-down';

                if (interaction === 'like') {
                    likeBtn.classList.add('active');
                    likeBtn.querySelector('i').className = 'fas fa-thumbs-up';
                } else if (interaction === 'dislike') {
                    dislikeBtn.classList.add('active');
                    dislikeBtn.querySelector('i').className = 'fas fa-thumbs-down';
                }
            });
        }
    }

    async function handleContentInteraction(action, item) {
        if (!item || !auth.currentUser) {
            showToast("You must be logged in to vote.");
            return;
        }
        const user = auth.currentUser;
        const contentId = item.id;
        const contentType = item.type;
        const contentRef = database.ref(`${contentType}s/${contentId}`);
        const userInteractionRef = database.ref(`user_interactions/${user.uid}/${contentId}`);

        try {
            const snapshot = await userInteractionRef.once('value');
            const currentInteraction = snapshot.val();
            let updates = {};

            if (currentInteraction === action) {
                updates[`${action}s`] = firebase.database.ServerValue.increment(-1);
                await userInteractionRef.remove();
            } else {
                if (currentInteraction) {
                    updates[`${currentInteraction}s`] = firebase.database.ServerValue.increment(-1);
                }
                updates[`${action}s`] = firebase.database.ServerValue.increment(1);
                await userInteractionRef.set(action);
            }
            await contentRef.update(updates);
        } catch (err) {
            console.error("Error updating likes/dislikes:", err);
            showToast("Could not save your vote. Please try again.");
        }
    }
    function addToWatchHistory(item) { const user = auth.currentUser; if (!user || !item) return; const historyRef = database.ref(`watch_history/${user.uid}/${item.id}`); historyRef.set({ id: item.id, timestamp: firebase.database.ServerValue.TIMESTAMP }); }

    function renderHistoryPage() {
        const user = auth.currentUser;
        if (!user) return;
        const container = document.getElementById('history-container');
        container.innerHTML = ' ';
        const historyRef = database.ref(`watch_history/${user.uid}`).orderByChild('timestamp');
        historyRef.once('value', snapshot => {
            if (!snapshot.exists()) {
                container.innerHTML = `<div class="empty-state" style="min-height: calc(100vh - 200px); display: flex; flex-direction: column; justify-content: center;"><i class="fas fa-history empty-icon"></i><p>No Watch History</p><span>Content you watch will appear here.</span></div>`;
                return;
            }
            const historyItems = [];
            snapshot.forEach(childSnapshot => {
                historyItems.push(childSnapshot.val());
            });
            historyItems.reverse().forEach((historyItem, index) => {
                const fullContentItem = allContent.find(content => content.id === historyItem.id);
                if (fullContentItem) {
                    const card = createProfessionalWatchlistCard(fullContentItem);
                    card.style.animationDelay = `${index * 0.05}s`;
                    const removeBtn = card.querySelector('.remove-btn-pro');
                    if (removeBtn) {
                        card.removeChild(removeBtn);
                    }
                    card.onclick = (e) => {
                        e.currentTarget.classList.add('card-clicked');
                        setTimeout(() => {
                           (seriesTypes.includes(fullContentItem.type)) ? showSeriesDetail(fullContentItem) : showDetail(fullContentItem);
                        }, 150);
                    };
                    container.appendChild(card);
                }
            });
        });
    }

    async function renderAnimePage() {
        const container = document.getElementById('anime-content');
        clearAllMainContent();
        container.className = 'page-content';
        const pageHeader = document.getElementById('page-header');
        pageHeader.classList.remove('hidden');
        pageHeader.classList.add('centered-header');
        pageHeader.querySelector('i').className = 'fas fa-ghost';
        pageHeader.querySelector('i').style.display = 'inline-block';
        document.getElementById('page-title').textContent = 'Anime';
        pageHeader.querySelector('.brand-badge').style.display = 'none';
        const animeContent = allContent.filter(item => item.type === 'anime' || item.type === 'anime_movie').sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
        container.innerHTML = `
            <div class="search-input-wrapper" style="margin-bottom: 15px;">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input-full" id="anime-search-input" placeholder="Search Anime...">
            </div>
            <div class="category-filters" id="anime-category-filters"></div>
            <div id="anime-featured-and-categories"></div>
            <div id="anime-list-container" class="content-grid hidden"></div>
        `;
        const fcContainer = document.getElementById('anime-featured-and-categories');
        const filtersContainer = document.getElementById('anime-category-filters');
        const listContainer = document.getElementById('anime-list-container');
        if (animeContent.length === 0) {
            container.className = 'page-content is-empty-page';
            container.innerHTML = `<div class="empty-state" style="min-height: calc(100vh - 200px); display: flex; flex-direction: column; justify-content: center;"><i class="fas fa-ghost empty-icon"></i><p>No Anime Found</p><span>Check back later for new anime titles.</span></div>`;
            return;
        }
        const featuredAnime = animeContent[0];
        const featuredCard = document.createElement('div');
        featuredCard.className = 'featured-series-card';
        featuredCard.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                seriesTypes.includes(featuredAnime.type) ? showSeriesDetail(featuredAnime) : showDetail(featuredAnime);
            }, 150);
        };
        featuredCard.innerHTML = `
            <img src="${featuredAnime.backdrop || featuredAnime.poster}" class="backdrop" alt="" loading="lazy">
            <div class="overlay">
                <h2 class="title">${featuredAnime.title}</h2>
                <p class="meta"> ${featuredAnime.rating || 'N/A'}  ${featuredAnime.year || 'Unknown'}</p>
            </div>`;
        fcContainer.appendChild(featuredCard);
        const animeCategories = [...new Set(animeContent.map(s => s.category).filter(c => c && c.toLowerCase() !== 'anime'))];
        animeCategories.forEach(categoryName => {
            const categoryContent = animeContent.filter(item => item.category === categoryName);
            if (categoryContent.length === 0) return;
            const section = document.createElement('div');
            section.className = 'category-section';
            section.id = `anime-cat-${String(categoryName).replace(/[^a-z0-9]+/gi, '')}`;
            const seeAllType = categoryContent.some(i => i.type === 'anime') ? 'anime' : 'anime_movie';
            section.innerHTML = `<div class="category-header"><h2 class="category-title">${categoryName}</h2><a href="#" class="see-all-btn" onclick="event.preventDefault(); renderCategoryPage('${categoryName}', '${seeAllType}')">See All &gt;</a></div><div class="content-slider"></div>`;
            const slider = section.querySelector('.content-slider');
            categoryContent.slice(0, 10).forEach(item => slider.appendChild(createContentCard(item)));
            fcContainer.appendChild(section);
        });
        filtersContainer.innerHTML = '';
        animeCategories.forEach(categoryName => {
            const filter = document.createElement('button');
            filter.className = 'filter-chip';
            filter.innerHTML = `<i class="fas fa-tags"></i> ${categoryName}`;
            filter.onclick = () => {
                const input = document.getElementById('anime-search-input');
                if (input) input.value = '';
                listContainer.classList.add('hidden');
                fcContainer.classList.remove('hidden');
                const targetId = `anime-cat-${String(categoryName).replace(/[^a-z0-9]+/gi, '')}`;
                document.getElementById(targetId)?.scrollIntoView({ behavior: 'smooth' });
                document.querySelector('#anime-category-filters .filter-chip.active')?.classList.remove('active');
                filter.classList.add('active');
            };
            filtersContainer.appendChild(filter);
        });
        if (filtersContainer.firstChild) filtersContainer.firstChild.classList.add('active');
        function renderAnimeList(list) {
            listContainer.innerHTML = '';
            if (list.length === 0) {
                listContainer.className = 'content-grid is-empty-page';
                listContainer.innerHTML = `<div class="empty-state" style="min-height: calc(50vh);"><i class="fas fa-ghost empty-icon"></i><p>No Anime Found</p></div>`;
                return;
            }
            list.forEach((item, index) => {
                const card = createContentCard(item);
                card.style.animationDelay = `${index * 0.05}s`;
                card.classList.add('list-item-animate');
                listContainer.appendChild(card);
            });
        }
        document.getElementById('anime-search-input').addEventListener('input', (e) => {
            const q = e.target.value.trim().toLowerCase();
            if (!q) {
                listContainer.classList.add('hidden');
                fcContainer.classList.remove('hidden');
                return;
            }
            const filtered = animeContent.filter(i => (i.title || '').toLowerCase().includes(q));
            fcContainer.classList.add('hidden');
            listContainer.classList.remove('hidden');
            renderAnimeList(filtered);
        });
    }

    async function renderSeriesPage() {
        const container = document.getElementById('series-content');
        clearAllMainContent();

        
        

        container.className = 'page-content';

const pageHeader = document.getElementById('page-header');
        pageHeader.classList.remove('hidden');
        pageHeader.classList.add('centered-header');
        pageHeader.querySelector('i').className = 'fas fa-tv';
        pageHeader.querySelector('i').style.display = 'inline-block';
        document.getElementById('page-title').textContent = 'Series';
        pageHeader.querySelector('.brand-badge').style.display = 'none';

        const series = allContent.filter(item => item.type === 'webseries');
        container.innerHTML = `
            <div class="search-input-wrapper" style="margin-bottom: 15px;">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input-full" id="series-search-input" placeholder="Search Series...">
            </div>
            <div class="category-filters" id="series-category-filters"></div>
            <div id="series-featured-and-categories"></div>
            <div id="series-list-container" class="content-grid hidden"></div>
        `;
        const fcContainer = document.getElementById('series-featured-and-categories');
        const filtersContainer = document.getElementById('series-category-filters');
        const listContainer = document.getElementById('series-list-container');

        if (series.length === 0) {
            container.className = 'page-content is-empty-page';
            container.innerHTML = `<div class="empty-state" style="min-height: calc(100vh - 200px); display: flex; flex-direction: column; justify-content: center;"><i class="fas fa-film empty-icon"></i><p>No Series Found</p><span>Check back later for new series.</span></div>`;
            return;
        }

        const featuredSeries = series[0];
        const featuredCard = document.createElement('div');
        featuredCard.className = 'featured-series-card';
        featuredCard.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                showSeriesDetail(featuredSeries);
            }, 150);
        };
        featuredCard.innerHTML = `
            <img src="${featuredSeries.backdrop || featuredSeries.poster}" class="backdrop" alt="" loading="lazy">
            <div class="overlay">
                <h2 class="title">${featuredSeries.title}</h2>
                <p class="meta"> ${featuredSeries.rating || 'N/A'}  ${featuredSeries.year || 'Unknown'}</p>
            </div>`;
        fcContainer.appendChild(featuredCard);

        const seriesCategories = [...new Set(series.map(s => s.category).filter(c => c && c.toLowerCase() !== 'anime'))];
        seriesCategories.forEach(categoryName => {
            const categoryContent = series.filter(item => item.category === categoryName);
            if (categoryContent.length === 0) return;
            const section = document.createElement('div');
            section.className = 'category-section';
            section.id = `series-cat-${String(categoryName).replace(/[^a-z0-9]+/gi, '')}`;
            section.innerHTML = `<div class="category-header"><h2 class="category-title">${categoryName}</h2><a href="#" class="see-all-btn" onclick="event.preventDefault(); renderCategoryPage('${categoryName}', 'webseries')">See All &gt;</a></div><div class="content-slider"></div>`;
            const slider = section.querySelector('.content-slider');
            categoryContent.slice(0, 10).forEach(item => slider.appendChild(createBackdropCard(item)));
            fcContainer.appendChild(section);
        });
        filtersContainer.innerHTML = '';
        seriesCategories.forEach(categoryName => {
            const filter = document.createElement('button');
            filter.className = 'filter-chip';
            filter.innerHTML = `<i class="fas fa-tags"></i> ${categoryName}`;
            filter.onclick = () => {
                const input = document.getElementById('series-search-input');
                if (input) input.value = '';
                listContainer.classList.add('hidden');
                fcContainer.classList.remove('hidden');
                const targetId = `series-cat-${String(categoryName).replace(/[^a-z0-9]+/gi, '')}`;
                document.getElementById(targetId)?.scrollIntoView({ behavior: 'smooth' });
                document.querySelector('#series-category-filters .filter-chip.active')?.classList.remove('active');
                filter.classList.add('active');
            };
            filtersContainer.appendChild(filter);
        });
        if (filtersContainer.firstChild) filtersContainer.firstChild.classList.add('active');
        
        function renderSeriesList(list) {
            listContainer.innerHTML = '';
            if (list.length === 0) {
                listContainer.className = 'content-grid is-empty-page';
                listContainer.innerHTML = `<div class="empty-state" style="min-height: calc(50vh);"><i class="fas fa-film empty-icon"></i><p>No Series Found</p></div>`;
                return;
            }
            list.forEach((item, index) => {
                const card = createContentCard(item);
                card.style.animationDelay = `${index * 0.05}s`;
                card.classList.add('list-item-animate');
                listContainer.appendChild(card);
            });
        }
        document.getElementById('series-search-input').addEventListener('input', (e) => {
            const q = e.target.value.trim().toLowerCase();
            if (!q) {
                listContainer.classList.add('hidden');
                fcContainer.classList.remove('hidden');
                return;
            }
            const filtered = series.filter(i => (i.title || '').toLowerCase().includes(q));
            fcContainer.classList.add('hidden');
            listContainer.classList.remove('hidden');
            renderSeriesList(filtered);
        });
    }

    function openDetailTab(evt, tabName) {
        const page = evt.target.closest('.detail-page');
        page.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        page.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
        page.querySelector(`#${tabName}`).style.display = 'block';
        evt.currentTarget.classList.add('active');
    }

    function showSeriesDetail(item, isFromHistory = false) {
        if (!isFromHistory) { navigationHistory.push({ type: 'series_detail', id: item.id }); }
        currentContent = item;
        if (sliderInterval) clearInterval(sliderInterval);

        hideAllPages();

        document.getElementById('series-detail-backdrop').innerHTML = `<img src="${item.backdrop || item.poster}" alt="" loading="lazy">`;
        document.getElementById('series-detail-title').textContent = item.title;
        document.getElementById('series-detail-meta').innerHTML = ` ${item.rating || 'N/A'}  ${item.year || 'Unknown Year'}`;
        document.getElementById('series-detail-storyline').textContent = item.storyline || 'No storyline available.';
        document.getElementById('series-detail-report-btn').onclick = () => showReportModal(item);
        document.getElementById('series-detail-watchlist-btn').onclick = () => toggleWatchlist(item);

        renderSeasonsAndEpisodes(item);
        updateSeriesDetailWatchlistButton(item);

        const castList = document.getElementById('series-detail-cast-list');
        castList.innerHTML = '';
        if (item.cast) {
            const castArray = Object.values(item.cast);
            if (castArray.length > 0) {
                castArray.forEach(actor => {
                    const castItem = document.createElement('div');
                    castItem.className = 'cast-item';
                    castItem.innerHTML = `<img src="${actor.image || 'https://i.ibb.co/yqg0Y3h/placeholder-avatar.jpg'}" alt="${actor.name}" loading="lazy"><p>${actor.name}</p>`;
                    castList.appendChild(castItem);
                });
            } else {
                 castList.innerHTML = '<p style="padding: 15px; color: var(--text-secondary); text-align: center;">No cast information available.</p>';
            }
        } else {
             castList.innerHTML = '<p style="padding: 15px; color: var(--text-secondary); text-align: center;">No cast information available.</p>';
        }

        const commentForm = document.getElementById('series-comment-form');
        const commentInput = document.getElementById('series-comment-input');
        const commentSubmitBtn = document.getElementById('series-comment-submit-btn');
        const user = auth.currentUser;
        if (user && user.isAnonymous) {
            commentInput.placeholder = 'Please sign in to comment.';
            commentInput.disabled = true;
            commentSubmitBtn.disabled = true;
        } else {
            commentInput.placeholder = 'Add a public comment...';
            commentInput.disabled = false;
            commentSubmitBtn.disabled = false;
            commentForm.onsubmit = (e) => saveComment(e, item.id, 'series-comment-input');
        }
        loadComments(item.id, 'series-comments-list');

        const similarSlider = document.getElementById('series-similar-slider');
        similarSlider.innerHTML = '';
        const similarSection = document.getElementById('series-similar-section');
        const similarContent = allContent.filter(c => c.id !== item.id && (seriesTypes.includes(c.type)) && (c.category === item.category)).slice(0, 10);
        if (similarContent.length > 0) {
            similarSection.style.display = 'block';
            similarContent.forEach(content => similarSlider.appendChild(createBackdropCard(content)));
        } else {
            similarSection.style.display = 'none';
        }

        document.getElementById('series-detail-page').style.display = 'block';
        document.getElementById('back-btn').style.display = 'block';
        document.getElementById('bottom-nav').style.display = 'none';

        document.querySelectorAll('#series-detail-page .tab-link').forEach((link, index) => link.classList.toggle('active', index === 0));
        document.querySelectorAll('#series-detail-page .tab-content').forEach((content, index) => content.style.display = index === 0 ? 'block' : 'none');

        window.scrollTo(0, 0);
    }

    function renderSeasonsAndEpisodes(seriesItem) {
        const seasonsContainer = document.getElementById('seasons-container');
        seasonsContainer.innerHTML = '';

        let episodesArray = seriesItem.episodes;
        if (episodesArray && !Array.isArray(episodesArray)) {
            episodesArray = Object.values(episodesArray);
        }

        if (!episodesArray || episodesArray.length === 0) {
            seasonsContainer.innerHTML = '<p style="padding: 15px; color: var(--text-secondary); text-align: center;">No episodes available for this series.</p>';
            return;
        }

        const validEpisodes = episodesArray.filter(ep => ep.season != null);
        if (validEpisodes.length === 0) {
            seasonsContainer.innerHTML = '<p style="padding: 15px; color: var(--text-secondary); text-align: center;">No episodes available for this series.</p>';
            return;
        }

        const seasons = validEpisodes.reduce((acc, ep) => { (acc[ep.season] = acc[ep.season] || []).push(ep); return acc; }, {});
        const seasonNumbers = Object.keys(seasons).sort((a,b) => a - b);

        const tabs = document.createElement('div'); tabs.className = 'season-tabs';
        const episodeListsContainer = document.createElement('div');

        seasonNumbers.forEach((seasonNum, index) => {
            const tab = document.createElement('div'); tab.className = 'season-tab'; tab.textContent = `Season ${seasonNum}`; tab.dataset.season = seasonNum;
            if (index === 0) tab.classList.add('active');
            tabs.appendChild(tab);

            const episodeList = document.createElement('div'); episodeList.className = 'episode-list'; episodeList.id = `season-${seasonNum}-episodes`;
            if (index > 0) episodeList.classList.add('hidden');

            seasons[seasonNum].sort((a,b) => a.episode - b.episode).forEach(ep => {
                const episodeItem = document.createElement('div'); episodeItem.className = 'episode-item';
                episodeItem.innerHTML = `
                    <div class="episode-thumbnail">
                        <img src="${ep.thumbnail || seriesItem.poster}" alt="${ep.title}" loading="lazy">
                        <div class="play-icon-wrapper"><i class="fas fa-play-circle"></i></div>
                    </div>
                    <div class="episode-details">
                        <div class="title">${ep.episode}. ${ep.title || 'Episode ' + ep.episode}</div>
                        <p class="ep-desc">${ep.description || ''}</p>
                    </div>`;
                episodeItem.onclick = () => playSeriesEpisode(seriesItem, ep);
                episodeList.appendChild(episodeItem);
            });
            episodeListsContainer.appendChild(episodeList);
        });

        tabs.addEventListener('click', (e) => { if (e.target.matches('.season-tab')) { tabs.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); document.querySelectorAll('#seasons-container .episode-list').forEach(list => list.classList.add('hidden')); document.getElementById(`season-${e.target.dataset.season}-episodes`).classList.remove('hidden'); } });
        seasonsContainer.appendChild(tabs);
        seasonsContainer.appendChild(episodeListsContainer);
    }

    function findNextEpisode(seriesItem, currentEpisode) {
        if (!seriesItem.episodes) return null;
        let episodesArray = Array.isArray(seriesItem.episodes) ? seriesItem.episodes : Object.values(seriesItem.episodes);
        episodesArray.sort((a, b) => a.season - b.season || a.episode - b.episode);
        const currentIndex = episodesArray.findIndex(ep => ep.season === currentEpisode.season && ep.episode === currentEpisode.episode);
        if (currentIndex > -1 && currentIndex < episodesArray.length - 1) {
            return episodesArray[currentIndex + 1];
        }
        return null;
    }

    function playSeriesEpisode(seriesItem, episode) {
        const user = auth.currentUser;

        if (seriesItem.tier === 'premium') {
            if (!user || user.isAnonymous) {
                showToast("Please sign in to watch premium content.");
                return;
            }
            if (!currentUserProfile || currentUserProfile.subscriptionStatus === 'none' || !currentUserProfile.subscriptionExpiry || currentUserProfile.subscriptionExpiry <= Date.now()) {
                showToast("Subscribe to watch premium content.");
                navigateTo('subscription');
                return;
            }
        }

        currentContent = seriesItem;
        addToWatchHistory(seriesItem);
        hideAllPages();
        document.getElementById('bottom-nav').style.display = 'none';
        document.getElementById('series-player-page').style.display = 'flex';
        switchSeriesEpisodeInPlayer(seriesItem, episode);
    }

    function switchSeriesEpisodeInPlayer(seriesItem, episode) {
        const page = document.getElementById('series-player-page');
        const videoElement = page.querySelector('#series-player-element');
        const errorOverlay = page.querySelector('.player-error-overlay');
        const loadingOverlay = page.querySelector('.player-loading-overlay');

        errorOverlay.classList.remove('show');
        loadingOverlay.classList.add('show');

        if (seriesPlayer) { seriesPlayer.destroy(); seriesPlayer = null; }

        videoElement.src = episode.link;
        videoElement.onerror = () => { errorOverlay.classList.add('show'); loadingOverlay.classList.remove('show'); };

        seriesPlayer = new Plyr(videoElement, playerConfig);
        setupPlayerFullscreenRotation(seriesPlayer);
        setupDoubleTapSeek(seriesPlayer);
        setupVolumeBrightnessGestures(seriesPlayer);
        initAdvancedPlayerUI('series-player-page', 'series', seriesPlayer);
        seriesPlayer.on('playing', () => loadingOverlay.classList.remove('show'));
        seriesPlayer.on('ended', () => {
            if (document.getElementById('series-autoplay-switch').checked) {
                const nextEp = findNextEpisode(seriesItem, episode);
                if (nextEp) switchSeriesEpisodeInPlayer(seriesItem, nextEp);
                else showToast("You've finished the series!");
            }
        });
        setupPlayerFullscreenRotation(seriesPlayer);
        seriesPlayer.play();

        document.getElementById('series-player-title').textContent = `${seriesItem.title} - S${episode.season} E${episode.episode}: ${episode.title || ''}`;

        document.getElementById('series-player-watchlist-btn').onclick = () => toggleWatchlist(seriesItem);
        document.getElementById('series-player-report-btn').onclick = () => showReportModal(seriesItem);
        document.getElementById('series-player-like-btn').onclick = () => handleContentInteraction('like', seriesItem);
        document.getElementById('series-player-dislike-btn').onclick = () => handleContentInteraction('dislike', seriesItem);

        loadInteractionStatus(seriesItem, 'series-player');
        updateSeriesPlayerWatchlistButton(seriesItem);

        let episodesArray = Array.isArray(seriesItem.episodes) ? seriesItem.episodes : Object.values(seriesItem.episodes);
        const episodeListContainer = document.getElementById('series-player-episode-list');
        episodeListContainer.innerHTML = '';
        const list = document.createElement('div');
        list.className = 'episode-list';

        episodesArray.sort((a,b) => a.season - b.season || a.episode - b.episode).forEach(ep => {
            const epItem = document.createElement('div');
            epItem.className = 'episode-item';
            if (ep.episode === episode.episode && ep.season === episode.season) epItem.classList.add('active');
            epItem.innerHTML = `
                <div class="episode-thumbnail">
                    <img src="${ep.thumbnail || seriesItem.poster}" alt="" loading="lazy">
                    <div class="play-icon-wrapper"><i class="fas fa-play-circle"></i></div>
                </div>
                <div class="episode-details">
                    <div class="title">E${ep.episode}: ${ep.title || 'Episode ' + ep.episode}</div>
                </div>`;
            epItem.onclick = () => switchSeriesEpisodeInPlayer(seriesItem, ep);
            list.appendChild(epItem);
        });
        episodeListContainer.appendChild(list);
    }

    function updateSeriesPlayerWatchlistButton(item) {
        const btn = document.getElementById('series-player-watchlist-btn'); if (!btn || !item) return;
        const icon = btn.querySelector('i'); const isIn = watchlist.some(w => w.id === item.id);
        if (isIn) { btn.classList.add('active'); icon.className = 'fas fa-check'; } else { btn.classList.remove('active'); icon.className = 'fas fa-plus'; }
    }

    function updateSeriesDetailWatchlistButton(item) {
        const btn = document.getElementById('series-detail-watchlist-btn'); if (!btn || !item) return;
        const icon = btn.querySelector('i'); const isIn = watchlist.some(w => w.id === item.id);
        if (isIn) { btn.classList.add('active'); icon.className = 'fas fa-check'; } else { btn.classList.remove('active'); icon.className = 'fas fa-plus'; }
    }

    function createTvGridCard(channel) {
        const card = document.createElement('div');
        card.className = 'livetv-channel-card';
        card.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                showLiveTvPlayer(channel);
            }, 150);
        };
        let languageBadgeHtml = channel.language ? `<div class="language-badge">${channel.language}</div>` : '';

        card.innerHTML = `
            ${languageBadgeHtml}
            <div class="logo-wrapper">
                <img src="${channel.logoUrl}" alt="${channel.name}" loading="lazy">
            </div>
            <span class="channel-name">${channel.name}</span>`;
        return card;
    }

    function createTvRecommendationCard(channel) {
        const card = document.createElement('div');
        card.className = 'livetv-channel-card';
        card.onclick = (e) => {
            e.currentTarget.classList.add('card-clicked');
            setTimeout(() => {
                showLiveTvPlayer(channel);
            }, 150);
        };
        card.innerHTML = `
            <div class="logo-wrapper">
                <img src="${channel.logoUrl}" alt="${channel.name}" loading="lazy">
            </div>
            <span class="channel-name">${channel.name}</span>`;
        return card;
    }


    function performLiveTvSearch() {
        const searchTerm = document.getElementById('livetv-search-input').value.toLowerCase();
        const contentContainer = document.getElementById('livetv-content');
        const filtersContainer = document.getElementById('livetv-category-filters');

        if (!searchTerm) {
            renderLiveTvPage(); // Restore original view if search is cleared
            return;
        }

        const filteredChannels = allLiveTvChannels.filter(channel => channel.name.toLowerCase().includes(searchTerm));

        contentContainer.innerHTML = '';
        filtersContainer.innerHTML = ''; // Hide category filters during search

        if (filteredChannels.length > 0) {
            const grid = document.createElement('div');
            grid.className = 'livetv-grid';
            grid.style.paddingTop = '15px';
            filteredChannels.forEach(channel => {
                grid.appendChild(createTvGridCard(channel));
            });
            contentContainer.appendChild(grid);
        } else {
            contentContainer.innerHTML = `<div class="empty-state" style="padding-top: 50px;"><i class="fas fa-search empty-icon"></i><p>No Channels Found</p><span>Try searching for something else.</span></div>`;
        }
    }


    function renderLiveTvPage() {
        document.getElementById('livetv-search-input').value = '';
        const contentContainer = document.getElementById('livetv-content');
        const filtersContainer = document.getElementById('livetv-category-filters');
        contentContainer.innerHTML = '';
        filtersContainer.innerHTML = '';

        if (allLiveTvChannels.length === 0) {
            contentContainer.innerHTML = `<div class="empty-state" style="padding-top: 50px;"><i class="fas fa-broadcast-tower empty-icon"></i><p>No TV Channels Available</p><span>Check back later for live TV.</span></div>`;
            return;
        }

        const categories = [...new Set(allLiveTvChannels.map(c => c.category))].sort();
        const categoryIcons = { 'News': 'fa-newspaper', 'Sports': 'fa-basketball-ball', 'Entertainment': 'fa-film', 'Music': 'fa-music', 'Movies': 'fa-ticket-alt' };

        categories.forEach(cat => {
            const filter = document.createElement('button');
            filter.className = 'filter-chip';
            filter.innerHTML = `<i class="fas ${categoryIcons[cat] || 'fa-tv'}"></i> ${cat}`;
            filter.onclick = () => {
                document.getElementById(`tv-cat-${cat.replace(/\s/g, '')}`).scrollIntoView({ behavior: 'smooth' });
                document.querySelector('.filter-chip.active')?.classList.remove('active');
                filter.classList.add('active');
            };
            filtersContainer.appendChild(filter);

            const section = document.createElement('div');
            section.className = 'livetv-category-section';
            section.id = `tv-cat-${cat.replace(/\s/g, '')}`;
            section.innerHTML = `
                <div class="category-header">
                    <h2 class="category-title">${cat}</h2>
                    <a href="#" class="see-all-btn" onclick="event.preventDefault(); renderLiveTvCategoryPage('${cat}')">See All &gt;</a>
                </div>
                <div class="livetv-grid"></div>`;

            const grid = section.querySelector('.livetv-grid');
            const channels = allLiveTvChannels.filter(c => c.category === cat);
            channels.slice(0, 6).forEach(channel => {
                grid.appendChild(createTvGridCard(channel));
            });
            contentContainer.appendChild(section);
        });

        if (filtersContainer.firstChild) {
            filtersContainer.firstChild.classList.add('active');
        }
    }

    function renderLiveTvCategoryPage(categoryName) {
        navigationHistory.push({ type: 'livetv_category', category: categoryName });
        hideAllPages();
        clearAllMainContent();

        document.getElementById('home-page').style.display = 'block';
        document.getElementById('home-header').style.display = 'none';

        const container = document.getElementById('category-grid-content');
        container.innerHTML = '';
        container.className = 'page-content livetv-grid';
        container.style.padding = '15px';
        container.classList.remove('hidden');

        const pageHeader = document.getElementById('page-header');
        pageHeader.classList.remove('hidden');
        pageHeader.classList.add('centered-header');
        pageHeader.querySelector('i').className = 'fas fa-tv';
        pageHeader.querySelector('i').style.display = 'inline-block';
        document.getElementById('page-title').textContent = categoryName;
        document.getElementById('back-btn').style.display = 'block';
        document.getElementById('bottom-nav').style.display = 'none';

        const categoryContent = allLiveTvChannels.filter(channel => channel.category === categoryName);

        if (categoryContent.length > 0) {
            categoryContent.forEach((channel, index) => {
                const card = createTvGridCard(channel);
                card.style.animationDelay = `${index * 0.05}s`;
                card.classList.add('list-item-animate');
                container.appendChild(card);
            });
        } else {
            container.className = 'page-content is-empty-page';
            container.innerHTML = `<div class="empty-state"><p>No channels found in ${categoryName}</p></div>`;
        }
        window.scrollTo(0, 0);
    }

    function showLiveTvPlayer(channel) {
        const user = auth.currentUser;
    
        if (!user || user.isAnonymous) {
            showToast("Please sign in to access Live TV.");
            return;
        }
        if (!currentUserProfile || currentUserProfile.subscriptionStatus === 'none' || !currentUserProfile.subscriptionExpiry || currentUserProfile.subscriptionExpiry <= Date.now()) {
            showToast("A premium subscription is required to watch Live TV.");
            navigateTo('subscription');
            return;
        }

        hideAllPages();
        navigationHistory.push({ type: 'livetv_player', id: channel.id });
        document.getElementById('livetv-player-page').style.display = 'flex';
        document.getElementById('back-btn').style.display = 'block';
        document.getElementById('bottom-nav').style.display = 'none';
        window.scrollTo(0, 0);

        const videoElement = document.getElementById('livetv-player-element');
        const errorOverlay = document.querySelector('#livetv-player-page .player-error-overlay');
        const loadingOverlay = document.querySelector('#livetv-player-page .player-loading-overlay');

        const source = channel.streamUrl;

        // Clean up previous player instances
        if (liveTvPlayer) {
            liveTvPlayer.destroy();
            liveTvPlayer = null;
        }
        if (hls) {
            hls.destroy();
            hls = null;
        }

        // Clear previous source
        videoElement.src = '';
        videoElement.removeAttribute('src');
        
        errorOverlay.classList.remove('show');
        loadingOverlay.classList.add('show');

        const setupHls = (streamUrl) => {
            if (streamUrl.includes('.m3u8')) {
                if (Hls.isSupported()) {
                    hls = new Hls({
                        enableWorker: false,
                        lowLatencyMode: true,
                        backBufferLength: 90,
                        debug: false,
                        maxBufferLength: 30,
                        maxMaxBufferLength: 60,
                        maxBufferSize: 60 * 1000 * 1000,
                        maxBufferHole: 0.5,
                        maxFragLookUpTolerance: 0.2,
                        liveSyncDurationCount: 3,
                        liveMaxLatencyDurationCount: 10
                    });
                    
                    hls.loadSource(streamUrl);
                    hls.attachMedia(videoElement);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        loadingOverlay.classList.remove('show');
                        initAdvancedPlayerUI('livetv-player-page', 'livetv', videoElement);
                        const playPromise = videoElement.play();
                        if (playPromise && typeof playPromise.catch === 'function') {
                            playPromise.catch(() => {});
                        }
                    });
                    
                    hls.on(Hls.Events.ERROR, function (event, data) {
                        console.error('HLS Error:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.error('Fatal network error, trying to recover');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.error('Fatal media error, trying to recover');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.error('Unrecoverable error');
                                    errorOverlay.classList.add('show');
                                    loadingOverlay.classList.remove('show');
                                    break;
                            }
                        }
                    });
                } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    // Native HLS support (Safari)
                    videoElement.src = streamUrl;
                    videoElement.addEventListener('loadedmetadata', function() {
                        loadingOverlay.classList.remove('show');
                        initAdvancedPlayerUI('livetv-player-page', 'livetv', videoElement);
                        const playPromise = videoElement.play();
                        if (playPromise && typeof playPromise.catch === 'function') {
                            playPromise.catch(() => {});
                        }
                    });
                } else {
                    console.error('HLS is not supported in this browser');
                    errorOverlay.classList.add('show');
                    loadingOverlay.classList.remove('show');
                    return;
                }
            } else {
                // Direct video stream (MP4, etc.)
                videoElement.src = streamUrl;
                videoElement.addEventListener('loadedmetadata', function() {
                    loadingOverlay.classList.remove('show');
                    initAdvancedPlayerUI('livetv-player-page', 'livetv', videoElement);
                    const playPromise = videoElement.play();
                    if (playPromise && typeof playPromise.catch === 'function') {
                        playPromise.catch(() => {});
                    }
                });
            }
        };

        setupHls(source);

        const recommendationsContainer = document.getElementById('livetv-player-recommendations');
        const recommendationsSlider = recommendationsContainer.querySelector('.content-slider');
        recommendationsSlider.innerHTML = ''; 

        const recommendedChannels = allLiveTvChannels
            .filter(c => c.category === channel.category && c.id !== channel.id)
            .slice(0, 10);

        if (recommendedChannels.length > 0) {
            recommendationsContainer.style.display = 'block';
            recommendedChannels.forEach(recChannel => {
                const card = createTvRecommendationCard(recChannel);
                recommendationsSlider.appendChild(card);
            });
        } else {
            recommendationsContainer.style.display = 'none';
        }
    }


    function clearAllCountdowns() {
        countdownIntervals.forEach(intervalId => clearInterval(intervalId));
        countdownIntervals = [];
    }

    async function renderUpcomingPage() {
        const container = document.getElementById('upcoming-container');
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading upcoming content...</p>';
        clearAllCountdowns();

        try {
            const snapshot = await database.ref('upcoming').orderByChild('releaseTimestamp').once('value');
            if (!snapshot.exists()) {
                container.innerHTML = `<div class="empty-state"><i class="fas fa-clock empty-icon"></i><p>Nothing is scheduled</p><span>Check back later for new announcements.</span></div>`;
                return;
            }

        container.innerHTML = '';
        let upcomingItems = [];
        snapshot.forEach(child => {
            upcomingItems.push({ id: child.key, ...child.val() });
        });

        upcomingItems.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'upcoming-card list-item-animate';
            card.style.animationDelay = `${index * 0.05}s`;

            const typeDisplay = item.type === 'movies' ? 'Movie' : 'Web Series';

            card.innerHTML = `
                <div class="poster"><img src="${item.poster}" alt="${item.title}" loading="lazy"></div>
                <div class="info">
                    <h3 class="title">${item.title}</h3>
                    <div class="countdown-timer" id="timer-${item.id}" data-timestamp="${item.releaseTimestamp}">Loading...</div>
                    <p class="meta">${item.year} &bull; ${typeDisplay}</p>
                </div>`;
            container.appendChild(card);
            startCountdown(item.id, item.releaseTimestamp);
        });
        } catch(error) {
            container.innerHTML = `<div class="empty-state"><p>Could not load upcoming content.</p></div>`;
            console.error("Error loading upcoming content: ", error);
        }
    }

    function startCountdown(itemId, releaseTimestamp) {
        const timerElement = document.getElementById(`timer-${itemId}`);
        if (!timerElement) return;

        const intervalId = setInterval(() => {
            const now = Date.now();
            const distance = releaseTimestamp - now;

            if (distance < 0) {
                timerElement.textContent = "Available Now!";
                clearInterval(intervalId);
                return;
            }

            const hours = Math.floor(distance / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            timerElement.textContent = `${String(hours).padStart(2, '0')} Hrs ${String(minutes).padStart(2, '0')} Min ${String(seconds).padStart(2, '0')} Sec`;
        }, 1000);
        countdownIntervals.push(intervalId);
    }
</script>
</body>
</html>


