<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANGMANCH - Admin Panel</title>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary-color: #e50914;
            --primary-glow: rgba(229, 9, 20, 0.5);
            --bg-color: #1a1d24;
            --sidebar-bg: rgba(17, 19, 25, 0.7);
            --card-bg: rgba(34, 38, 47, 0.6);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #2b1010 0%, #1a1d24 70%);
            color: var(--text-primary);
        }

        .hidden {
            display: none !important;
        }

        /* Glass Utility */
        .glass-panel {
            background: rgba(30, 34, 45, 0.8);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            will-change: transform;
        }

        /* --- Login Page --- */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: radial-gradient(circle at center, #2b1010 0%, #111319 100%);
        }

        .login-box {
            width: 100%;
            max-width: 380px;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .login-box .logo {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 25px;
        }

        .login-box .logo .movie-text {
            color: white;
        }

        .login-box .logo .hunt-text {
            color: var(--primary-color);
        }

        .login-box h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-secondary);
        }

        .login-box .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .login-box .auth-input {
            width: 100%;
            padding: 14px 20px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: #fff;
            font-size: 15px;
        }

        .login-box .auth-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-box .error-message {
            color: var(--primary-color);
            font-size: 13px;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        /* --- Admin Panel Layout --- */
        #admin-panel {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(15px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-right: 1px solid var(--border-color);
        }

        .sidebar .logo {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar .logo .movie-text {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .sidebar .logo .hunt-text {
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .sidebar .nav-menu {
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar .nav-menu::-webkit-scrollbar {
            width: 5px;
        }

        .sidebar .nav-menu::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .sidebar .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease, color 0.3s ease;
            border: 1px solid transparent;
            transform-origin: left center;
            will-change: transform;
        }

        .sidebar .nav-item i {
            width: 20px;
            text-align: center;
            transition: all 0.4s ease;
        }

        /* Zoom Effect for Sidebar */
        .sidebar .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: white;
            transform: scale(1.02) translate3d(5px, 0, 0);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar .nav-item:hover i {
            transform: scale(1.1);
            color: var(--primary-color);
        }

        .sidebar .nav-item.active {
            background: linear-gradient(90deg, rgba(229, 9, 20, 0.2), transparent);
            color: var(--primary-color);
            font-weight: 600;
            border-left: 3px solid var(--primary-color);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .sidebar .logout-btn {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        /* Responsive Sidebar */
        .menu-toggle {
            display: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
            margin-right: 15px;
            background: none;
            border: none;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .sidebar-overlay.show {
            display: block;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                z-index: 1001;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5);
            }

            .sidebar.open {
                left: 0;
            }

            .menu-toggle {
                display: inline-block;
            }

            .main-content {
                padding: 15px;
                width: 100%;
            }

            .page-header {
                flex-wrap: wrap;
                gap: 10px;
            }

            .page-header h1 {
                font-size: 22px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            /* Adjust modal for mobile */
            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 85vh;
            }
        }

        /* Improved Cross Button */
        .modal-close-icon {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close-icon:hover {
            background: var(--primary-color);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        /* Theme Settings Page */
        .theme-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .admin-theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s;
            position: relative;
        }

        .admin-theme-btn:hover {
            transform: scale(1.1);
        }

        .admin-theme-btn.active {
            border-color: white;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .admin-theme-btn::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            opacity: 0;
        }

        .admin-theme-btn.active::after {
            opacity: 1;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate3d(0, 10px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 28px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .brand-badge {
            margin-left: 12px;
            padding: 6px 12px;
            border-radius: 16px;
            background: rgba(229, 9, 20, 0.12);
            color: var(--primary-color);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.4px;
            border: 1px solid rgba(229, 9, 20, 0.35);
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }

        /* --- Dashboard Stats --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
            will-change: transform;
        }

        .stat-card:hover {
            transform: translate3d(0, -5px, 0);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: rgba(40, 44, 55, 0.8);
        }

        .stat-card .stat-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* --- Tables --- */
        .table-wrapper {
            background: rgba(30, 34, 45, 0.7);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 18px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(0, 0, 0, 0.2);
        }

        td {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .actions a {
            color: var(--text-secondary);
            margin: 0 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .actions a:hover {
            color: var(--primary-color);
            transform: scale(1.2);
        }

        .poster-thumbnail {
            width: 40px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* --- Modal --- */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(12px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-backdrop.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: rgba(26, 29, 36, 0.95);
            backdrop-filter: blur(25px);
            border-radius: 24px;
            padding: 35px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.7);
            transform: scale(0.85) translateY(30px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-backdrop.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(229, 9, 20, 0.2);
            background-color: rgba(0, 0, 0, 0.3);
            outline: none;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .modal-footer {
            margin-top: 30px;
            text-align: right;
        }

        .modal-footer .btn {
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* --- Specific Page Styles --- */
        #maintenance-page .toggle-switch {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
        }

        #maintenance-page .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        #maintenance-page .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        #maintenance-page .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        #maintenance-page .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        #maintenance-page input:checked+.slider {
            background-color: var(--primary-color);
        }

        #maintenance-page input:checked+.slider:before {
            transform: translateX(26px);
        }
    </style>
</head>

<body>

    <div id="login-container">
        <div class="login-box">
            <div class="logo"><span class="movie-text">RANG</span><span class="hunt-text">MANCH</span></div>
            <h1>Admin Panel Login</h1>
            <form id="admin-login-form">
                <div class="input-group"><input type="email" id="login-email" class="auth-input"
                        placeholder="Admin Email" required></div>
                <div class="input-group"><input type="password" id="login-password" class="auth-input"
                        placeholder="Password" required></div>
                <p id="login-error" class="error-message"></p>
                <button type="submit" class="auth-btn">Login</button>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <aside class="sidebar">
            <div class="logo"><span class="movie-text">RANG</span><span class="hunt-text">MANCH</span></div>
            <nav class="nav-menu">
                <a class="nav-item active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                <a class="nav-item" data-page="users"><i class="fas fa-users"></i> Users</a>
                <a class="nav-item" data-page="movies"><i class="fas fa-film"></i> Movies</a>
                <a class="nav-item" data-page="webseries"><i class="fas fa-tv"></i> Web Series</a>
                <a class="nav-item" data-page="anime"><i class="fas fa-ghost"></i> Anime</a>
                <a class="nav-item" data-page="anime_movies"><i class="fas fa-video"></i> Anime Movies</a>
                <a class="nav-item" data-page="livetv"><i class="fas fa-broadcast-tower"></i> Live TV</a>
                <a class="nav-item" data-page="upcoming"><i class="fas fa-clock"></i> Upcoming</a>
                <a class="nav-item" data-page="payments"><i class="fas fa-credit-card"></i> Payments</a>
                <a class="nav-item" data-page="subscription_plans"><i class="fas fa-list-alt"></i> Subscription
                    Plans</a>
                <a class="nav-item" data-page="notifications"><i class="fas fa-bell"></i> Notifications</a>
                <a class="nav-item" data-page="redeem_codes"><i class="fas fa-ticket-alt"></i> Redeem Codes</a>
                <a class="nav-item" data-page="requests"><i class="fas fa-inbox"></i> Requests & Reports</a>
                <a class="nav-item" data-page="maintenance"><i class="fas fa-tools"></i> Maintenance</a>
                <a class="nav-item" data-page="settings"><i class="fas fa-cog"></i> Settings</a>
            </nav>
            <a class="nav-item logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </aside>

        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                <div class="page-header">
                    <h1>Dashboard <span class="brand-badge">RANGMANCH</span></h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">Total Users</div>
                        <div class="stat-number" id="total-users">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Movies</div>
                        <div class="stat-number" id="total-movies">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Web Series</div>
                        <div class="stat-number" id="total-series">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Anime</div>
                        <div class="stat-number" id="total-anime">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Pending Payments</div>
                        <div class="stat-number" id="pending-payments">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Movie Requests</div>
                        <div class="stat-number" id="movie-requests-count">0</div>
                    </div>
                </div>
            </div>

            <!-- Generic Content Page -->
            <div id="content-page" class="page">
                <div class="page-header">
                    <h1 id="content-page-title">Content <span class="brand-badge">RANGMANCH</span></h1>
                    <button class="btn btn-primary" id="add-content-btn"><i class="fas fa-plus"></i> Add New</button>
                </div>
                <div class="table-wrapper">
                    <table id="content-table">
                        <thead>
                            <tr></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align:center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Other Pages will be dynamically filled -->
            <div id="users-page" class="page"></div>
            <div id="payments-page" class="page"></div>
            <div id="subscription_plans-page" class="page"></div>
            <div id="notifications-page" class="page"></div>
            <div id="redeem_codes-page" class="page"></div>
            <div id="requests-page" class="page"></div>
            <div id="maintenance-page" class="page"></div>

            <!-- Settings Page -->
            <div id="settings-page" class="page">
                <div class="page-header">
                    <h1>Settings</h1>
                </div>
                <div class="glass-panel" style="padding: 30px; border-radius: 16px;">
                    <h3 style="margin-bottom: 20px; color: var(--text-secondary);">Theme & Appearance</h3>
                    <div class="theme-options" id="admin-theme-options"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- Generic Modal -->
    <div id="form-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Modal Title</h2>
                <button class="modal-close-icon js-close-modal"><i class="fas fa-times"></i></button>
            </div>
            <form id="modal-form">
                <input type="hidden" id="edit-id" />
                <div class="form-grid" id="form-fields">
                    <!-- Fields will be injected here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary js-close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="save-btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulk-modal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 600px; width: 90%;">
            <div class="modal-header"
                style="margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;">
                <h2 id="bulk-modal-title" style="font-size: 24px;">Bulk Import Content</h2>
                <button class="modal-close-icon js-close-bulk-modal"><i class="fas fa-times"></i></button>
            </div>

            <div class="form-group full-width">
                <label style="display: block; margin-bottom: 10px; color: var(--text-secondary);">JSON Data
                    Array</label>
                <textarea id="bulk-json-input" placeholder='Paste JSON array here...'
                    style="height: 400px; font-family: 'Consolas', monospace; font-size: 13px; background: rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.1);"></textarea>
            </div>

            <div class="modal-footer"
                style="padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: 20px;">
                <button type="button" class="btn btn-secondary js-close-bulk-modal">Cancel Import</button>
                <button type="button" class="btn btn-primary" id="bulk-save-btn" style="padding: 12px 30px;"><i
                        class="fas fa-cloud-upload-alt"></i> Import & Sync All</button>
            </div>
        </div>
    </div>


    <script>
        // ===============================================================
        // SETUP - यह हिस्सा आपको कॉन्फ़िगर करना होगा
        // ===============================================================

        // 1. अपनी फायरबेस कॉन्फ़िगरेशन यहां पेस्ट करें

        const firebaseConfig = {
  apiKey: "AIzaSyAdvmI8mRyxEdBlnE0vDF-IW1eTxvR8fzw",
  authDomain: "gt-store-774fe.firebaseapp.com",
  databaseURL: "https://gt-store-774fe-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "gt-store-774fe",
  storageBucket: "gt-store-774fe.firebasestorage.app",
  messagingSenderId: "237273289443",
  appId: "1:237273289443:web:eae46a81c1ab7519f86bd6",
  measurementId: "G-RK3P4FNCPG"
};
        // 2. यहां एडमिन उपयोगकर्ता के UIDs डालें (आप एक से अधिक डाल सकते हैं)
        // आप Firebase Console -> Authentication में जाकर यूजर का UID कॉपी कर सकते हैं।
        const ADMIN_UIDS = ['r2nBH4S09rWXndQhG70cljSDyPv1', ''];

        // ===============================================================
        // INITIALIZATION
        // ===============================================================
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('admin-login-form');
        const loginError = document.getElementById('login-error');
        const mainContent = document.querySelector('.main-content');

        // Data Migration
        (function migrateAdminData() {
            const oldK = 'moviehunt_admin_theme';
            const newK = 'rangmanch_admin_theme';
            if (localStorage.getItem(oldK) && !localStorage.getItem(newK)) {
                localStorage.setItem(newK, localStorage.getItem(oldK));
                localStorage.removeItem(oldK);
            }
        })();

        // --- Theme Logic ---
        const themes = {
            'classic-red': '#e50914',
            'ocean-blue': '#007BFF',
            'forest-green': '#28a745',
            'royal-purple': '#8A2BE2',
            'sunset-orange': '#FF8C00',
            'cyber-pink': '#FF00FF',
            'neutral-white': '#333333'
        };

        function applyAdminTheme(themeKey) {
            if (!themeKey) themeKey = localStorage.getItem('rangmanch_admin_theme') || 'classic-red';

            const color = themes[themeKey] || '#e50914';
            const glowColor = color + '80';

            document.documentElement.style.setProperty('--primary-color', color);
            document.documentElement.style.setProperty('--primary-glow', glowColor);

            // Handle Neutral White specific overrides
            if (themeKey === 'neutral-white') {
                document.documentElement.style.setProperty('--bg-color', '#f4f4f9');
                document.documentElement.style.setProperty('--card-bg', 'rgba(255, 255, 255, 0.9)');
                document.documentElement.style.setProperty('--text-primary', '#1a1d24');
                document.documentElement.style.setProperty('--text-secondary', '#555');
                document.documentElement.style.setProperty('--sidebar-bg', 'rgba(255, 255, 255, 0.9)');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(0, 0, 0, 0.05)');
                document.documentElement.style.setProperty('--glass-border', 'rgba(0, 0, 0, 0.1)');
                document.documentElement.style.setProperty('--glass-shadow', '0 8px 32px 0 rgba(0, 0, 0, 0.1)');
            } else {
                // Revert to dark mode defaults
                document.documentElement.style.setProperty('--bg-color', '#1a1d24');
                document.documentElement.style.setProperty('--card-bg', 'rgba(34, 38, 47, 0.6)');
                document.documentElement.style.setProperty('--text-primary', '#ffffff');
                document.documentElement.style.setProperty('--text-secondary', '#a0a0a0');
                document.documentElement.style.setProperty('--sidebar-bg', 'rgba(17, 19, 25, 0.7)');
                document.documentElement.style.setProperty('--glass-bg', 'rgba(20, 20, 20, 0.6)');
                document.documentElement.style.setProperty('--glass-border', 'rgba(255, 255, 255, 0.1)');
                document.documentElement.style.setProperty('--glass-shadow', '0 8px 32px 0 rgba(0, 0, 0, 0.37)');
            }

            localStorage.setItem('rangmanch_admin_theme', themeKey);
            renderAdminThemeOptions();
        }

        function renderAdminThemeOptions() {
            const container = document.getElementById('admin-theme-options');
            if (!container) return;
            container.innerHTML = '';

            const currentTheme = localStorage.getItem('rangmanch_admin_theme') || 'classic-red';

            Object.keys(themes).forEach(key => {
                const btn = document.createElement('div');
                btn.className = `admin-theme-btn ${key === currentTheme ? 'active' : ''}`;
                btn.style.backgroundColor = themes[key];
                btn.onclick = () => applyAdminTheme(key);
                if (key === 'neutral-white') {
                    btn.style.backgroundColor = '#f4f4f9';
                    btn.style.border = '2px solid #ccc';
                }
                container.appendChild(btn);
            });
        }

        // Sidebar Toggle Logic
        function setupSidebarToggle() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const headers = document.querySelectorAll('.page-header');

            // Inject Toggle Button
            headers.forEach(header => {
                if (!header.querySelector('.menu-toggle')) {
                    const btn = document.createElement('button');
                    btn.className = 'menu-toggle';
                    btn.innerHTML = '<i class="fas fa-bars"></i>';
                    btn.onclick = () => {
                        sidebar.classList.add('open');
                        overlay.classList.add('show');
                    };
                    header.prepend(btn);
                }
            });

            // Close Sidebar
            if (overlay) {
                overlay.onclick = () => {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('show');
                };
            }

            // Close on nav click (mobile)
            document.querySelectorAll('.sidebar .nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                        overlay.classList.remove('show');
                    }
                });
            });
        }

        // Init
        applyAdminTheme();
        // Run setup when DOM is fully loaded or periodically if content is dynamic
        document.addEventListener('DOMContentLoaded', () => {
            setupSidebarToggle();
            renderAdminThemeOptions();
        });
        // Also run immediately in case we are already loaded
        setupSidebarToggle();
        renderAdminThemeOptions();

        // ===============================================================
        // AUTHENTICATION
        // ===============================================================
        auth.onAuthStateChanged(user => {
            if (user && ADMIN_UIDS.includes(user.uid)) {
                loginContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                initAdminPanel();
            } else {
                loginContainer.classList.remove('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    loginError.textContent = error.message;
                    loginError.style.display = 'block';
                });
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut();
        });


        // ===============================================================
        // ADMIN PANEL LOGIC
        // ===============================================================
        function initAdminPanel() {
            setupNavigation();
            showPage('dashboard');
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll('.sidebar .nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (item.id === 'logout-btn') return;
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    showPage(item.dataset.page);
                });
            });
        }

        let currentPage = null;
        function showPage(pageId) {
            const contentPage = document.getElementById('content-page');
            const pageElement = document.getElementById(`${pageId}-page`);
            const allPages = document.querySelectorAll('.page');

            // Deactivate current
            allPages.forEach(p => p.classList.remove('active'));

            const contentPageIds = ['movies', 'webseries', 'anime', 'anime_movies', 'livetv', 'upcoming'];
            if (contentPageIds.includes(pageId)) {
                renderContentPage(pageId);
                contentPage.classList.add('active');
                mainContent.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (pageElement) {
                pageElement.classList.add('active');
                mainContent.scrollTo({ top: 0, behavior: 'smooth' });

                switch (pageId) {
                    case 'dashboard': renderDashboard(); break;
                    case 'users': renderUsersPage(); break;
                    case 'payments': renderPaymentsPage(); break;
                    case 'subscription_plans': renderSubscriptionPlansPage(); break;
                    case 'notifications': renderNotificationsPage(); break;
                    case 'redeem_codes': renderRedeemCodesPage(); break;
                    case 'requests': renderRequestsPage(); break;
                    case 'maintenance': renderMaintenancePage(); break;
                }
            }
        }

        // ===============================================================
        // DASHBOARD
        // ===============================================================
        async function renderDashboard() {
            const cacheKey = 'dashboard_stats';

            // Show cached if available
            if (dataCache[cacheKey]) {
                const stats = dataCache[cacheKey];
                for (const [id, val] of Object.entries(stats)) {
                    const el = document.getElementById(id);
                    if (el) el.textContent = val;
                }
            }

            const refs = {
                'total-users': database.ref('users'),
                'total-movies': database.ref('movies'),
                'total-series': database.ref('webseries'),
                'total-anime': database.ref('anime'),
                'movie-requests-count': database.ref('movie_requests'),
            };

            const statsOutput = {};
            for (const [elementId, ref] of Object.entries(refs)) {
                const snapshot = await ref.once('value');
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                statsOutput[elementId] = count;
                document.getElementById(elementId).textContent = count;
            }

            const paymentsSnapshot = await database.ref('payments').orderByChild('status').equalTo('pending').once('value');
            const pendingCount = paymentsSnapshot.exists() ? Object.keys(paymentsSnapshot.val()).length : 0;
            statsOutput['pending-payments'] = pendingCount;
            document.getElementById('pending-payments').textContent = pendingCount;

            dataCache[cacheKey] = statsOutput;
        }

        // ===============================================================
        // MODAL & FORM HANDLING
        // ===============================================================
        const modal = document.getElementById('form-modal');
        const modalForm = document.getElementById('modal-form');
        const formFields = document.getElementById('form-fields');
        const modalTitle = document.getElementById('modal-title');
        const editIdField = document.getElementById('edit-id');

        const bulkModal = document.getElementById('bulk-modal');
        const bulkJsonInput = document.getElementById('bulk-json-input');
        const bulkSaveBtn = document.getElementById('bulk-save-btn');

        function closeModal(m) {
            m.classList.remove('show');
            setTimeout(() => {
                if (!m.classList.contains('show')) m.style.display = 'none';
            }, 300);
        }

        function openModalElement(m) {
            m.style.display = 'flex';
            setTimeout(() => m.classList.add('show'), 10);
        }

        document.querySelectorAll('.js-close-modal').forEach(btn => {
            btn.addEventListener('click', () => closeModal(modal));
        });

        document.querySelectorAll('.js-close-bulk-modal').forEach(btn => {
            btn.addEventListener('click', () => closeModal(bulkModal));
        });

        function openModal(title, fieldsHtml, data = {}) {
            modalTitle.textContent = title;
            formFields.innerHTML = fieldsHtml;
            modalForm.reset();
            editIdField.value = data.id || '';

            // Populate form if data is provided for editing
            for (const key in data) {
                const input = formFields.querySelector(`[name="${key}"]`);
                if (input) {
                    if (key === 'episodes' && data[key]) {
                        input.value = JSON.stringify(data[key], null, 2);
                    } else {
                        input.value = data[key];
                    }
                }
            }

            openModalElement(modal);
        }

        // ===============================================================
        // GENERIC CONTENT MANAGEMENT
        // ===============================================================
        const contentConfig = {
            movies: { title: 'Movies', dbPath: 'movies', headers: ['Poster', 'Title', 'Category', 'Tier', 'Actions'], fields: ['poster', 'title', 'category', 'tier'] },
            webseries: { title: 'Web Series', dbPath: 'webseries', headers: ['Poster', 'Title', 'Category', 'Tier', 'Actions'], fields: ['poster', 'title', 'category', 'tier'] },
            anime: { title: 'Anime', dbPath: 'anime', headers: ['Poster', 'Title', 'Category', 'Tier', 'Actions'], fields: ['poster', 'title', 'category', 'tier'] },
            anime_movies: { title: 'Anime Movies', dbPath: 'anime_movies', headers: ['Poster', 'Title', 'Category', 'Tier', 'Actions'], fields: ['poster', 'title', 'category', 'tier'] },
            livetv: { title: 'Live TV Channels', dbPath: 'livetv', headers: ['Logo', 'Name', 'Category', 'Actions'], fields: ['logoUrl', 'name', 'category'] },
            upcoming: { title: 'Upcoming Content', dbPath: 'upcoming', headers: ['Poster', 'Title', 'Release Date', 'Actions'], fields: ['poster', 'title', 'releaseTimestamp'] },
        };

        function openBulkModal(type) {
            const config = contentConfig[type];
            document.getElementById('bulk-modal-title').textContent = `Bulk Upload ${config.title} (JSON)`;
            bulkJsonInput.value = '';
            openModalElement(bulkModal);
            bulkSaveBtn.onclick = () => saveBulkContent(type);
        }

        async function saveBulkContent(type) {
            const config = contentConfig[type];
            const jsonText = bulkJsonInput.value.trim();

            if (!jsonText) {
                alert("Please paste JSON data.");
                return;
            }

            try {
                const dataArray = JSON.parse(jsonText);
                if (!Array.isArray(dataArray)) {
                    throw new Error("Data must be a JSON array.");
                }

                if (!confirm(`Are you sure you want to upload ${dataArray.length} items to ${config.title}?`)) {
                    return;
                }

                const keyMap = {
                    "Title": "title",
                    "Year": "year",
                    "Poster URL": "poster",
                    "Backdrop URL": "backdrop",
                    "Category": "category",
                    "Genre": "genre",
                    "Rating": "rating",
                    "Language": "language",
                    "Trailer URL (YouTube)": "trailer",
                    "Trailer": "trailer",
                    "Premium Tier": "tier",
                    "Premium Tier Free": "tier",
                    "Storyline": "storyline",
                    "Movie Link (.m3u8, .mp4)": "link",
                    "Movie Link": "link",
                    "Episodes": "episodes",
                    "Episodes (JSON format)": "episodes",
                    "Channel Name": "name",
                    "Category": "category",
                    "Language": "language",
                    "Logo URL": "logoUrl",
                    "Stream URL (.m3u8)": "streamUrl"
                };

                bulkSaveBtn.disabled = true;
                bulkSaveBtn.textContent = 'Uploading...';

                const ref = database.ref(config.dbPath);
                const timestamp = firebase.database.ServerValue.TIMESTAMP;

                const promises = dataArray.map(rawItem => {
                    const cleanItem = {};
                    for (let key in rawItem) {
                        let standardKey = keyMap[key] || key.toLowerCase().replace(/\s+/g, '_');

                        // Sanitize key for Firebase (remove . # $ / [ ])
                        standardKey = standardKey.replace(/[.#$/[\]]/g, '');

                        let value = rawItem[key];
                        // Basic value cleaning
                        if (standardKey === 'tier' && typeof value === 'string') {
                            value = value.toLowerCase();
                        }

                        cleanItem[standardKey] = value;
                    }
                    cleanItem.timestamp = timestamp;
                    return ref.push().set(cleanItem);
                });

                await Promise.all(promises);

                alert(`Successfully imported ${dataArray.length} items to ${config.title}!`);
                closeModal(bulkModal);
                renderContentPage(type);
            } catch (e) {
                alert("Error parsing or uploading JSON: " + e.message);
            } finally {
                bulkSaveBtn.disabled = false;
                bulkSaveBtn.textContent = 'Import & Sync All';
            }
        }

        // Data Cache to reduce Firebase calls
        const dataCache = {};

        async function renderContentPage(type) {
            const config = contentConfig[type];
            document.getElementById('content-page-title').textContent = config.title;

            const table = document.getElementById('content-table');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');

            thead.innerHTML = config.headers.map(h => `<th>${h}</th>`).join('');

            // Show cached data immediately if available
            if (dataCache[type]) {
                renderTableBody(tbody, dataCache[type], type, config);
            } else {
                tbody.innerHTML = `<tr><td colspan="${config.headers.length}" style="text-align:center;">Loading...</td></tr>`;
            }

            // Fetch fresh data
            try {
                const snapshot = await database.ref(config.dbPath).once('value');
                const data = [];
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        data.push({ id: child.key, ...child.val() });
                    });
                }
                dataCache[type] = data;
                renderTableBody(tbody, data, type, config);
            } catch (error) {
                console.error("Fetch error:", error);
                if (!dataCache[type]) {
                    tbody.innerHTML = `<tr><td colspan="${config.headers.length}" style="text-align:center;">Error loading data.</td></tr>`;
                }
            }

            document.getElementById('add-content-btn').onclick = () => addContent(type);
            modalForm.onsubmit = (e) => saveContent(e, type);
        }

        function renderTableBody(container, data, type, config) {
            if (data.length === 0) {
                container.innerHTML = `<tr><td colspan="${config.headers.length}" style="text-align:center;">No content found.</td></tr>`;
                return;
            }

            const fragment = document.createDocumentFragment();
            data.forEach(item => {
                const tr = document.createElement('tr');
                let rowHtml = '';
                config.fields.forEach(field => {
                    if (field === 'poster' || field === 'logoUrl') {
                        rowHtml += `<td><img src="${item[field]}" class="poster-thumbnail"></td>`;
                    } else if (field === 'releaseTimestamp') {
                        rowHtml += `<td>${new Date(item[field]).toLocaleString()}</td>`;
                    } else {
                        rowHtml += `<td>${item[field] || 'N/A'}</td>`;
                    }
                });
                rowHtml += `<td class="actions">
                    <a onclick="editContent('${type}', '${item.id}')" title="Edit"><i class="fas fa-edit"></i></a>
                    <a onclick="deleteContent('${type}', '${item.id}')" title="Delete"><i class="fas fa-trash"></i></a>
                </td>`;
                tr.innerHTML = rowHtml;
                fragment.appendChild(tr);
            });

            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function getContentFormFields(type) {
            let baseFields = `
        <div style="grid-column: 1/-1; margin-bottom: 20px; text-align: right;">
            <a href="javascript:void(0)" onclick="closeModal(modal); openBulkModal('${type}')" style="color: var(--primary-color); font-size: 13px; text-decoration: none; font-weight: 600;">
                <i class="fas fa-file-import"></i> Switch to Bulk Upload (JSON)
            </a>
        </div>
        <div class="form-group"><label>Title</label><input type="text" name="title" required></div>
        <div class="form-group"><label>Year</label><input type="number" name="year"></div>
        <div class="form-group"><label>Poster URL</label><input type="url" name="poster" required></div>
        <div class="form-group"><label>Backdrop URL</label><input type="url" name="backdrop"></div>
        <div class="form-group"><label>Category</label><input type="text" name="category"></div>
        <div class="form-group"><label>Genre</label><input type="text" name="genre"></div>
        <div class="form-group"><label>Rating (e.g., 8.5)</label><input type="text" name="rating"></div>
        <div class="form-group"><label>Language</label><input type="text" name="language"></div>
        <div class="form-group"><label>Trailer URL (YouTube)</label><input type="url" name="trailer"></div>
        <div class="form-group">
            <label>Premium Tier</label>
            <select name="tier"><option value="free">Free</option><option value="premium">Premium</option></select>
        </div>
        <div class="form-group full-width"><label>Storyline</label><textarea name="storyline"></textarea></div>
    `;

            switch (type) {
                case 'movies':
                case 'anime_movies':
                    return baseFields + `<div class="form-group full-width"><label>Movie Link (.m3u8, .mp4)</label><input type="url" name="link" required></div>`;
                case 'webseries':
                case 'anime':
                    return baseFields + `<div class="form-group full-width"><label>Episodes (JSON format)</label><textarea name="episodes" placeholder='[{"season": 1, "episode": 1, "title": "Episode 1", "link": "url"}, ...]'></textarea></div>`;
                case 'livetv':
                    return `
                <div style="grid-column: 1/-1; margin-bottom: 20px; text-align: right;">
                    <a href="javascript:void(0)" onclick="closeModal(modal); openBulkModal('${type}')" style="color: var(--primary-color); font-size: 13px; text-decoration: none; font-weight: 600;">
                        <i class="fas fa-file-import"></i> Switch to Bulk Upload (JSON)
                    </a>
                </div>
                <div class="form-group"><label>Channel Name</label><input type="text" name="name" required></div>
                <div class="form-group"><label>Category</label><input type="text" name="category"></div>
                <div class="form-group"><label>Language</label><input type="text" name="language"></div>
                <div class="form-group"><label>Logo URL</label><input type="url" name="logoUrl" required></div>
                <div class="form-group full-width"><label>Stream URL (.m3u8)</label><input type="url" name="streamUrl" required></div>
            `;
                case 'upcoming':
                    return `
                <div style="grid-column: 1/-1; margin-bottom: 20px; text-align: right;">
                    <a href="javascript:void(0)" onclick="closeModal(modal); openBulkModal('${type}')" style="color: var(--primary-color); font-size: 13px; text-decoration: none; font-weight: 600;">
                        <i class="fas fa-file-import"></i> Switch to Bulk Upload (JSON)
                    </a>
                </div>
                <div class="form-group"><label>Title</label><input type="text" name="title" required></div>
                <div class="form-group"><label>Year</label><input type="number" name="year"></div>
                <div class="form-group"><label>Poster URL</label><input type="url" name="poster" required></div>
                <div class="form-group">
                    <label>Type</label>
                    <select name="type"><option value="movies">Movie</option><option value="webseries">Web Series</option></select>
                </div>
                 <div class="form-group full-width"><label>Release Date & Time</label><input type="datetime-local" id="release-date" name="releaseDate" required></div>
            `;
            }
            return '';
        }

        function addContent(type) {
            const config = contentConfig[type];
            openModal(`Add New ${config.title}`, getContentFormFields(type));
        }

        async function editContent(type, id) {
            const config = contentConfig[type];
            const snapshot = await database.ref(`${config.dbPath}/${id}`).once('value');
            if (snapshot.exists()) {
                const data = { id, ...snapshot.val() };
                openModal(`Edit ${config.title}`, getContentFormFields(type), data);
            } else {
                alert('Error: Content not found.');
            }
        }

        function saveContent(event, type) {
            event.preventDefault();
            const config = contentConfig[type];
            const id = editIdField.value;

            let data = {};
            const formData = new FormData(modalForm);
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            // Handle specific data types
            if (type === 'upcoming') {
                data.releaseTimestamp = new Date(document.getElementById('release-date').value).getTime();
                delete data.releaseDate;
            }
            if ((type === 'webseries' || type === 'anime') && data.episodes) {
                try {
                    data.episodes = JSON.parse(data.episodes);
                } catch (e) {
                    alert("Error: Episodes JSON is not valid.");
                    return;
                }
            }
            data.timestamp = firebase.database.ServerValue.TIMESTAMP;

            const ref = id ? database.ref(`${config.dbPath}/${id}`) : database.ref(config.dbPath).push();

            ref.set(data)
                .then(() => {
                    modal.style.display = 'none';
                    renderContentPage(type);
                })
                .catch(error => alert(`Error: ${error.message}`));
        }

        function deleteContent(type, id) {
            const config = contentConfig[type];
            if (confirm(`Are you sure you want to delete this item?`)) {
                database.ref(`${config.dbPath}/${id}`).remove()
                    .then(() => renderContentPage(type))
                    .catch(error => alert(`Error: ${error.message}`));
            }
        }
        // Global scope for functions called from HTML
        window.editContent = editContent;
        window.deleteContent = deleteContent;

        // ===============================================================
        // USER MANAGEMENT
        // ===============================================================
        async function renderUsersPage() {
            const pageElement = document.getElementById('users-page');
            pageElement.innerHTML = `
        <div class="page-header"><h1>Users</h1></div>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Name</th><th>Email</th><th>Subscription</th><th>Expiry Date</th><th>Actions</th></tr></thead>
                <tbody><tr><td colspan="5" style="text-align:center;">Loading...</td></tr></tbody>
            </table>
        </div>`;

            const tbody = pageElement.querySelector('tbody');
            const snapshot = await database.ref('users').once('value');

            if (!snapshot.exists()) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No users found.</td></tr>`;
                return;
            }

            let rows = '';
            snapshot.forEach(childSnapshot => {
                const user = { id: childSnapshot.key, ...childSnapshot.val() };
                const expiry = user.subscriptionExpiry ? new Date(user.subscriptionExpiry).toLocaleString() : 'N/A';
                rows += `
            <tr>
                <td>${user.displayName || 'Guest'}</td>
                <td>${user.email || 'N/A'}</td>
                <td>${user.subscriptionStatus || 'none'}</td>
                <td>${expiry}</td>
                <td class="actions">
                    <a onclick="editUser('${user.id}')" title="Edit Subscription"><i class="fas fa-user-edit"></i></a>
                    <a onclick="deleteUser('${user.id}')" title="Delete User"><i class="fas fa-trash"></i></a>
                </td>
            </tr>`;
            });
            tbody.innerHTML = rows;
        }

        async function editUser(uid) {
            const snapshot = await database.ref(`users/${uid}`).once('value');
            if (snapshot.exists()) {
                const user = { id: uid, ...snapshot.val() };
                const expiryDate = user.subscriptionExpiry ? new Date(user.subscriptionExpiry).toISOString().slice(0, 16) : '';
                const formHtml = `
            <p>Editing user: <strong>${user.displayName || user.email}</strong></p>
            <div class="form-group">
                <label>Subscription Status</label>
                <select name="subscriptionStatus">
                    <option value="none">None</option>
                    <option value="premium">Premium</option>
                </select>
            </div>
            <div class="form-group">
                <label>Subscription Expiry Date</label>
                <input type="datetime-local" name="subscriptionExpiry" value="${expiryDate}">
            </div>`;
                openModal('Edit User Subscription', formHtml, user);

                modalForm.onsubmit = (e) => {
                    e.preventDefault();
                    const newStatus = modalForm.querySelector('[name="subscriptionStatus"]').value;
                    const newExpiryInput = modalForm.querySelector('[name="subscriptionExpiry"]').value;
                    const newExpiry = newExpiryInput ? new Date(newExpiryInput).getTime() : null;

                    database.ref(`users/${uid}`).update({
                        subscriptionStatus: newStatus,
                        subscriptionExpiry: newExpiry
                    }).then(() => {
                        modal.style.display = 'none';
                        renderUsersPage();
                    }).catch(error => alert(`Error: ${error.message}`));
                };
            }
        }

        function deleteUser(uid) {
            if (confirm(`Are you sure you want to delete this user's database record? \n\nIMPORTANT: This does NOT delete their authentication account. That must be done from the Firebase Console.`)) {
                database.ref(`users/${uid}`).remove()
                    .then(() => renderUsersPage())
                    .catch(error => alert(`Error: ${error.message}`));
            }
        }
        window.editUser = editUser;
        window.deleteUser = deleteUser;

        // ===============================================================
        // PAYMENT MANAGEMENT
        // ===============================================================
        async function renderPaymentsPage() {
            const pageElement = document.getElementById('payments-page');
            pageElement.innerHTML = `
        <div class="page-header"><h1>Payment Verifications</h1></div>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>User Email</th><th>Plan</th><th>Transaction ID</th><th>Amount</th><th>Method</th><th>Screenshot</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody><tr><td colspan="8" style="text-align:center;">Loading...</td></tr></tbody>
            </table>
        </div>`;

            const tbody = pageElement.querySelector('tbody');
            const snapshot = await database.ref('payments').once('value');

            if (!snapshot.exists()) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No payments found.</td></tr>`;
                return;
            }

            let rows = '';
            snapshot.forEach(childSnapshot => {
                const payment = { id: childSnapshot.key, ...childSnapshot.val() };
                const statusClass = payment.status === 'pending' ? 'status-pending' : 'status-approved';
                rows += `
            <tr>
                <td>${payment.email || 'N/A'}</td>
                <td>${payment.plan || 'N/A'}</td>
                <td>${payment.transactionId || 'N/A'}</td>
                <td>${typeof payment.amount !== 'undefined' ? payment.amount : 'N/A'}</td>
                <td>${payment.method || 'N/A'}</td>
                <td>${payment.screenshotUrl ? `<a href="${payment.screenshotUrl}" target="_blank">View</a>` : 'N/A'}</td>
                <td><span class="status-badge ${statusClass}">${payment.status}</span></td>
                <td class="actions">
                    ${payment.status === 'pending' ? `<a onclick="approvePayment('${payment.id}', '${payment.uid}', '${payment.plan}')" title="Approve Payment"><i class="fas fa-check-circle"></i></a>` : ''}
                </td>
            </tr>`;
            });
            tbody.innerHTML = rows;
        }

        async function approvePayment(paymentId, uid, plan) {
            if (!confirm('Are you sure you want to approve this payment and grant premium access?')) return;

            // Assuming a 30-day plan duration, you can make this dynamic
            const planDurationDays = 30;
            const expiryTimestamp = Date.now() + (planDurationDays * 24 * 60 * 60 * 1000);

            const updates = {};
            updates[`/users/${uid}/subscriptionStatus`] = 'premium'; // Or derive from `plan`
            updates[`/users/${uid}/subscriptionExpiry`] = expiryTimestamp;
            updates[`/payments/${paymentId}/status`] = 'approved';

            try {
                await database.ref().update(updates);
                renderPaymentsPage();
            } catch (error) {
                alert(`Error approving payment: ${error.message}`);
            }
        }
        window.approvePayment = approvePayment;

        async function renderSubscriptionPlansPage() {
            const pageElement = document.getElementById('subscription_plans-page');
            pageElement.innerHTML = `
        <div class="page-header"><h1>Subscription Plans</h1></div>
        <div class="table-wrapper" style="padding: 20px; margin-bottom: 30px;">
            <form id="subscription-plan-form">
                <div class="form-grid">
                    <div class="form-group"><label>Name</label><input type="text" name="name" required></div>
                    <div class="form-group">
                        <label>Tier</label>
                        <select name="tier">
                            <option value="basic">Basic</option>
                            <option value="premium">Premium</option>
                            <option value="vip">VIP</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Price</label><input type="number" name="price" step="0.01" required></div>
                    <div class="form-group"><label>Duration (days)</label><input type="number" name="duration_days" value="30" required></div>
                    <div class="form-group full-width"><label>Description</label><textarea name="description"></textarea></div>
                </div>
                <div class="modal-footer" style="text-align: left; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Add Plan</button>
                </div>
            </form>
        </div>
        <div class="page-header"><h1>Existing Plans</h1></div>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Name</th><th>Tier</th><th>Price</th><th>Duration</th><th>Actions</th></tr></thead>
                <tbody id="plans-tbody"><tr><td colspan="5" style="text-align:center;">Loading...</td></tr></tbody>
            </table>
        </div>
    `;
            const form = document.getElementById('subscription-plan-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const fd = new FormData(form);
                const plan = {
                    name: fd.get('name'),
                    tier: fd.get('tier'),
                    price: parseFloat(fd.get('price')),
                    duration_days: parseInt(fd.get('duration_days')),
                    description: fd.get('description') || '',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                database.ref('subscription_plans').push(plan)
                    .then(() => {
                        alert('Plan added');
                        form.reset();
                        loadSubscriptionPlans();
                    })
                    .catch(error => alert(`Error: ${error.message}`));
            });
            loadSubscriptionPlans();
        }

        async function loadSubscriptionPlans() {
            const tbody = document.getElementById('plans-tbody');
            const snapshot = await database.ref('subscription_plans').once('value');
            if (!snapshot.exists()) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No plans found.</td></tr>`;
                return;
            }
            let rows = '';
            snapshot.forEach(childSnapshot => {
                const id = childSnapshot.key;
                const p = childSnapshot.val();
                rows += `
            <tr>
                <td>${p.name}</td>
                <td>${p.tier}</td>
                <td>${p.price}</td>
                <td>${p.duration_days} days</td>
                <td class="actions">
                    <a onclick="editSubscriptionPlan('${id}')" title="Edit"><i class="fas fa-edit"></i></a>
                    <a onclick="deleteSubscriptionPlan('${id}')" title="Delete"><i class="fas fa-trash"></i></a>
                </td>
            </tr>`;
            });
            tbody.innerHTML = rows;
        }

        function getPlanFormFields() {
            return `
        <div class="form-group"><label>Name</label><input type="text" name="name" required></div>
        <div class="form-group">
            <label>Tier</label>
            <select name="tier">
                <option value="basic">Basic</option>
                <option value="premium">Premium</option>
                <option value="vip">VIP</option>
            </select>
        </div>
        <div class="form-group"><label>Price</label><input type="number" name="price" step="0.01" required></div>
        <div class="form-group"><label>Duration (days)</label><input type="number" name="duration_days" required></div>
        <div class="form-group full-width"><label>Description</label><textarea name="description"></textarea></div>
    `;
        }

        async function editSubscriptionPlan(id) {
            const snap = await database.ref(`subscription_plans/${id}`).once('value');
            if (!snap.exists()) {
                alert('Error: Plan not found.');
                return;
            }
            const data = { id, ...snap.val() };
            openModal('Edit Subscription Plan', getPlanFormFields(), data);
            modalForm.onsubmit = (e) => {
                e.preventDefault();
                const fd = new FormData(modalForm);
                const updated = {
                    name: fd.get('name'),
                    tier: fd.get('tier'),
                    price: parseFloat(fd.get('price')),
                    duration_days: parseInt(fd.get('duration_days')),
                    description: fd.get('description') || ''
                };
                database.ref(`subscription_plans/${id}`).set(updated)
                    .then(() => {
                        modal.style.display = 'none';
                        loadSubscriptionPlans();
                    })
                    .catch(error => alert(`Error: ${error.message}`));
            };
        }

        function deleteSubscriptionPlan(id) {
            if (confirm('Are you sure you want to delete this plan?')) {
                database.ref(`subscription_plans/${id}`).remove()
                    .then(() => loadSubscriptionPlans())
                    .catch(error => alert(`Error: ${error.message}`));
            }
        }
        window.editSubscriptionPlan = editSubscriptionPlan;
        window.deleteSubscriptionPlan = deleteSubscriptionPlan;

        // ===============================================================
        // NOTIFICATIONS MANAGEMENT
        // ===============================================================
        async function renderNotificationsPage() {
            const pageElement = document.getElementById('notifications-page');
            pageElement.innerHTML = `
        <div class="page-header"><h1>Send Notification</h1></div>
        <div class="table-wrapper" style="padding: 20px;">
            <form id="notification-form">
                <div class="form-grid">
                    <div class="form-group"><label>Title</label><input type="text" name="title" required></div>
                    <div class="form-group"><label>Target (all / user UID)</label><input type="text" name="target" value="all" required></div>
                    <div class="form-group full-width"><label>Message</label><textarea name="message" required></textarea></div>
                    <div class="form-group"><label>Movie/Series ID (Optional)</label><input type="text" name="movieId"></div>
                    <div class="form-group"><label>Movie Poster (Optional)</label><input type="url" name="moviePoster"></div>
                </div>
                <div class="modal-footer" style="text-align: left; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Send Notification</button>
                </div>
            </form>
        </div>
    `;

            document.getElementById('notification-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const notificationData = {
                    title: formData.get('title'),
                    message: formData.get('message'),
                    target: formData.get('target'),
                    movieId: formData.get('movieId') || null,
                    moviePoster: formData.get('moviePoster') || null,
                    icon: 'fa-bell', // default icon
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                database.ref('notifications').push(notificationData)
                    .then(() => {
                        alert('Notification sent!');
                        e.target.reset();
                    })
                    .catch(error => alert(`Error: ${error.message}`));
            });
        }

        // ===============================================================
        // REDEEM CODES MANAGEMENT
        // ===============================================================
        async function renderRedeemCodesPage() {
            const pageElement = document.getElementById('redeem_codes-page');
            pageElement.innerHTML = `
        <div class="page-header"><h1>Generate Redeem Code</h1></div>
        <div class="table-wrapper" style="padding: 20px; margin-bottom: 30px;">
            <form id="redeem-code-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Plan Type</label>
                        <select name="plan"><option value="premium">Premium</option></select>
                    </div>
                    <div class="form-group">
                        <label>Duration (in days)</label>
                        <input type="number" name="duration" value="30" required>
                    </div>
                </div>
                <div class="modal-footer" style="text-align: left; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Generate Code</button>
                </div>
            </form>
        </div>
        <div class="page-header"><h1>Existing Codes</h1></div>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Code</th><th>Plan</th><th>Duration</th><th>Status</th><th>Redeemed By</th></tr></thead>
                <tbody id="codes-tbody"><tr><td colspan="5" style="text-align:center;">Loading...</td></tr></tbody>
            </table>
        </div>
    `;

            document.getElementById('redeem-code-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const plan = e.target.elements.plan.value;
                const duration_days = parseInt(e.target.elements.duration.value);
                const code = 'MH-' + Math.random().toString(36).substr(2, 8).toUpperCase();

                const codeData = {
                    plan,
                    duration_days,
                    active: true,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };

                database.ref('redeem_codes').child(code).set(codeData)
                    .then(() => {
                        alert(`Code generated: ${code}`);
                        loadRedeemCodes();
                    })
                    .catch(error => alert(`Error: ${error.message}`));
            });

            loadRedeemCodes();
        }

        async function loadRedeemCodes() {
            const tbody = document.getElementById('codes-tbody');
            const snapshot = await database.ref('redeem_codes').once('value');
            if (!snapshot.exists()) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No codes found.</td></tr>`;
                return;
            }
            let rows = '';
            snapshot.forEach(childSnapshot => {
                const code = childSnapshot.key;
                const data = childSnapshot.val();
                const status = data.active ? 'Active' : 'Redeemed';
                rows += `
            <tr>
                <td>${code}</td>
                <td>${data.plan}</td>
                <td>${data.duration_days} days</td>
                <td>${status}</td>
                <td>${data.redeemedBy || 'N/A'}</td>
            </tr>`;
            });
            tbody.innerHTML = rows;
        }

        // ===============================================================
        // REQUESTS & REPORTS
        // ===============================================================
        async function renderRequestsPage() {
            const pageElement = document.getElementById('requests-page');
            pageElement.innerHTML = `
        <div class="page-header"><h1>Movie Requests</h1></div>
        <div class="table-wrapper" id="movie-requests-table"></div>
        <div class="page-header" style="margin-top: 40px;"><h1>Bug Reports</h1></div>
        <div class="table-wrapper" id="bug-reports-table"></div>
        <div class="page-header" style="margin-top: 40px;"><h1>Content Reports</h1></div>
        <div class="table-wrapper" id="content-reports-table"></div>
    `;

            renderTable('movie_requests', 'movie-requests-table', ['Movie Name', 'Year', 'Requested By', 'Actions'], ['movieName', 'movieYear', 'requestedBy']);
            renderTable('bug_reports', 'bug-reports-table', ['Description', 'Reported By', 'Actions'], ['description', 'reportedBy']);
            renderTable('content_reports', 'content-reports-table', ['Content Title', 'Reason', 'Description', 'Reported By', 'Actions'], ['title', 'reason', 'description', 'reportedBy']);
        }

        async function renderTable(dbPath, elementId, headers, fields) {
            const container = document.getElementById(elementId);
            container.innerHTML = `
        <table>
            <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
            <tbody><tr><td colspan="${headers.length}" style="text-align:center;">Loading...</td></tr></tbody>
        </table>`;

            const tbody = container.querySelector('tbody');
            const snapshot = await database.ref(dbPath).once('value');
            if (!snapshot.exists()) {
                tbody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align:center;">No items found.</td></tr>`;
                return;
            }

            let rows = '';
            snapshot.forEach(childSnapshot => {
                const data = { id: childSnapshot.key, ...childSnapshot.val() };
                let rowData = fields.map(field => `<td>${data[field]}</td>`).join('');
                rowData += `<td class="actions"><a onclick="deleteRequest('${dbPath}', '${data.id}')"><i class="fas fa-trash"></i></a></td>`;
                rows += `<tr>${rowData}</tr>`;
            });
            tbody.innerHTML = rows;
        }

        function deleteRequest(dbPath, id) {
            if (confirm('Are you sure you want to delete this item?')) {
                database.ref(`${dbPath}/${id}`).remove().then(() => renderRequestsPage());
            }
        }
        window.deleteRequest = deleteRequest;


        // ===============================================================
        // MAINTENANCE MODE
        // ===============================================================
        async function renderMaintenancePage() {
            const pageElement = document.getElementById('maintenance-page');
            pageElement.innerHTML = `
        <div class="page-header"><h1>Maintenance Mode</h1></div>
        <div class="toggle-switch">
            <span>Enable Maintenance Mode</span>
            <label class="switch">
                <input type="checkbox" id="maintenance-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="form-group" style="margin-top: 20px;">
            <label>Maintenance Message</label>
            <textarea id="maintenance-message" class="form-control" style="width:100%; min-height:100px;"></textarea>
        </div>
        <button class="btn btn-primary" id="save-maintenance-btn" style="margin-top: 20px;">Save Settings</button>
    `;

            const toggle = document.getElementById('maintenance-toggle');
            const messageInput = document.getElementById('maintenance-message');

            const snapshot = await database.ref('maintenance').once('value');
            if (snapshot.exists()) {
                const data = snapshot.val();
                toggle.checked = data.enabled;
                messageInput.value = data.message || '';
            }

            document.getElementById('save-maintenance-btn').onclick = () => {
                const settings = {
                    enabled: toggle.checked,
                    message: messageInput.value
                };
                database.ref('maintenance').set(settings)
                    .then(() => alert('Maintenance settings saved.'))
                    .catch(error => alert(`Error: ${error.message}`));
            };
        }


    </script>
</body>

</html>

